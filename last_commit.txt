Repository: plone.supermodel


Branch: refs/heads/master
Date: 2020-02-14T09:38:11+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.supermodel/commit/7ef8fb5f0765bcf31299bf141625416655c4faeb

support zope.interface 5.x+ with deferred _v_attrs dict creation

Files changed:
M plone/supermodel/utils.py

b"diff --git a/plone/supermodel/utils.py b/plone/supermodel/utils.py\nindex a797bdf..9fd8919 100644\n--- a/plone/supermodel/utils.py\n+++ b/plone/supermodel/utils.py\n@@ -298,7 +298,7 @@ def syncSchema(source, dest, overwrite=False, sync_bases=False):\n         for name in to_delete:\n             # delattr(dest, name)\n             del dest._InterfaceClass__attrs[name]\n-            if hasattr(dest, '_v_attrs'):\n+            if hasattr(dest, '_v_attrs') and dest._v_attrs is not None:\n                 del dest._v_attrs[name]\n \n     # Add fields that are in source, but not in dest\n@@ -317,6 +317,8 @@ def syncSchema(source, dest, overwrite=False, sync_bases=False):\n             # setattr(dest, name, clone)\n             dest._InterfaceClass__attrs[name] = clone\n             if hasattr(dest, '_v_attrs'):\n+                if dest._v_attrs is None:\n+                    dest._v_attrs = {}\n                 dest._v_attrs[name] = clone\n \n     # Copy tagged values\n"

Repository: plone.supermodel


Branch: refs/heads/master
Date: 2020-02-14T09:38:11+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.supermodel/commit/98d2559372211041acfead02748a9a035b512d35

document change

Files changed:
A news/33.feature

b'diff --git a/news/33.feature b/news/33.feature\nnew file mode 100644\nindex 0000000..2970198\n--- /dev/null\n+++ b/news/33.feature\n@@ -0,0 +1,2 @@\n+zope.interface master, upcoming v5.0, initializes ``_v_attrs`` with ``None`` to save memory and creates the dict upon first usage.\n+So we need to do so in order to support the new version.\n\\ No newline at end of file\n'

Repository: plone.supermodel


Branch: refs/heads/master
Date: 2020-02-17T00:02:07+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.supermodel/commit/c8f9a06e19b074c6d82804b8cc8b7d3f318a3080

Merge pull request #33 from plone/zope.interface-5

support zope.interface 5.x+ with deferred _v_attrs dict creation

Files changed:
A news/33.feature
M plone/supermodel/utils.py

b"diff --git a/news/33.feature b/news/33.feature\nnew file mode 100644\nindex 0000000..2970198\n--- /dev/null\n+++ b/news/33.feature\n@@ -0,0 +1,2 @@\n+zope.interface master, upcoming v5.0, initializes ``_v_attrs`` with ``None`` to save memory and creates the dict upon first usage.\n+So we need to do so in order to support the new version.\n\\ No newline at end of file\ndiff --git a/plone/supermodel/utils.py b/plone/supermodel/utils.py\nindex a797bdf..9fd8919 100644\n--- a/plone/supermodel/utils.py\n+++ b/plone/supermodel/utils.py\n@@ -298,7 +298,7 @@ def syncSchema(source, dest, overwrite=False, sync_bases=False):\n         for name in to_delete:\n             # delattr(dest, name)\n             del dest._InterfaceClass__attrs[name]\n-            if hasattr(dest, '_v_attrs'):\n+            if hasattr(dest, '_v_attrs') and dest._v_attrs is not None:\n                 del dest._v_attrs[name]\n \n     # Add fields that are in source, but not in dest\n@@ -317,6 +317,8 @@ def syncSchema(source, dest, overwrite=False, sync_bases=False):\n             # setattr(dest, name, clone)\n             dest._InterfaceClass__attrs[name] = clone\n             if hasattr(dest, '_v_attrs'):\n+                if dest._v_attrs is None:\n+                    dest._v_attrs = {}\n                 dest._v_attrs[name] = clone\n \n     # Copy tagged values\n"

