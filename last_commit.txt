Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-09-07T14:57:38+02:00
Author: Fred van Dijk (fredvd) <fredvd@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/4222fb52ed93e99982e12c619fbd85bea23bad6d

Fix folder layout property migration

Files changed:
M CHANGES.rst
M plone/app/contenttypes/migration/migration.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 3d683f9a..05437d3e 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -28,6 +28,15 @@ New features:\n \n Bug fixes:\n \n+- Fix folder layout property migration. The default listing_view layout was\n+  always set if a folder didn\'t have a layout property.\n+  Also a default_page property could be inherited from parent folders or\n+  the Plone Siteroot, causing \'front-page\' default_pages on many folders.\n+  Now only a direct layout property is copied and in that case on the local\n+  default_page if set is copied again.\n+  see `issue 444 <https://github.com/plone/plone.app.contenttypes/issues/444>`\n+  [fredvd]\n+\n - Fixed false implemented Factories and Markers for ILeadImage and IRichText.\n   see `issue 457 <https://github.com/plone/plone.app.contenttypes/issues/476>`\n   [iham]\ndiff --git a/plone/app/contenttypes/migration/migration.py b/plone/app/contenttypes/migration/migration.py\nindex df6d66b0..4ee3dd64 100644\n--- a/plone/app/contenttypes/migration/migration.py\n+++ b/plone/app/contenttypes/migration/migration.py\n@@ -32,6 +32,7 @@\n from Products.contentmigration.basemigrator.migrator import CMFItemMigrator\n from Products.contentmigration.basemigrator.walker import CatalogWalker\n from Products.contentmigration.walker import CustomQueryWalker\n+from Acquisition import aq_base\n from zExceptions import NotFound\n from zope.component import adapter\n from zope.component import getAdapters\n@@ -205,19 +206,19 @@ def last_migrate_layout(self):\n         migrate_criteria may get overriden by a later call to\n         migrate_properties.\n         """\n-        old_layout = self.old.getLayout() or getattr(self.old, \'layout\', None)\n+        old_layout = getattr(aq_base(self.old), \'layout\', None)\n         if old_layout:\n-            default_page = self.old.getDefaultPage() or \\\n-                getattr(self.old, \'default_page\', None)\n+            default_page = getattr(aq_base(self.old), \'default_page\', None)\n             try:\n                 # Delete old-style layout attribute.\n                 del self.new.layout\n             except AttributeError:\n                 pass\n+            # always copy over the layout, transform if necessary\n             self.new.setLayout(LISTING_VIEW_MAPPING.get(old_layout, old_layout))  # noqa\n             if default_page:\n                 # any defaultPage is switched of by setLayout\n-                # and needs to set again\n+                # and needs to set again if it was directly on the object\n                 self.new.setDefaultPage(default_page)\n \n \n'

Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-09-18T13:01:02+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/fdd689ee2b94adfa160172788be16fd1c9377690

Merge pull request #484 from plone/fix_folder_layout_migration

Fix folder layout property migration

Files changed:
M CHANGES.rst
M plone/app/contenttypes/migration/migration.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex c1fa3f92..20d6a312 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -28,6 +28,15 @@ New features:\n \n Bug fixes:\n \n+- Fix folder layout property migration. The default listing_view layout was\n+  always set if a folder didn\'t have a layout property.\n+  Also a default_page property could be inherited from parent folders or\n+  the Plone Siteroot, causing \'front-page\' default_pages on many folders.\n+  Now only a direct layout property is copied and in that case on the local\n+  default_page if set is copied again.\n+  see `issue 444 <https://github.com/plone/plone.app.contenttypes/issues/444>`\n+  [fredvd]\n+\n - Fixed false implemented Factories and Markers for ILeadImage and IRichText.\n   see `issue 457 <https://github.com/plone/plone.app.contenttypes/issues/476>`\n   [iham]\ndiff --git a/plone/app/contenttypes/migration/migration.py b/plone/app/contenttypes/migration/migration.py\nindex df6d66b0..4ee3dd64 100644\n--- a/plone/app/contenttypes/migration/migration.py\n+++ b/plone/app/contenttypes/migration/migration.py\n@@ -32,6 +32,7 @@\n from Products.contentmigration.basemigrator.migrator import CMFItemMigrator\n from Products.contentmigration.basemigrator.walker import CatalogWalker\n from Products.contentmigration.walker import CustomQueryWalker\n+from Acquisition import aq_base\n from zExceptions import NotFound\n from zope.component import adapter\n from zope.component import getAdapters\n@@ -205,19 +206,19 @@ def last_migrate_layout(self):\n         migrate_criteria may get overriden by a later call to\n         migrate_properties.\n         """\n-        old_layout = self.old.getLayout() or getattr(self.old, \'layout\', None)\n+        old_layout = getattr(aq_base(self.old), \'layout\', None)\n         if old_layout:\n-            default_page = self.old.getDefaultPage() or \\\n-                getattr(self.old, \'default_page\', None)\n+            default_page = getattr(aq_base(self.old), \'default_page\', None)\n             try:\n                 # Delete old-style layout attribute.\n                 del self.new.layout\n             except AttributeError:\n                 pass\n+            # always copy over the layout, transform if necessary\n             self.new.setLayout(LISTING_VIEW_MAPPING.get(old_layout, old_layout))  # noqa\n             if default_page:\n                 # any defaultPage is switched of by setLayout\n-                # and needs to set again\n+                # and needs to set again if it was directly on the object\n                 self.new.setDefaultPage(default_page)\n \n \n'

