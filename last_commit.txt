Repository: Products.PlonePAS


Branch: refs/heads/5.x
Date: 2018-04-16T17:33:03+12:00
Author: ezvirtual (ezvirtual) <ezvirtual@thevirtual.co.nz>
Commit: https://github.com/plone/Products.PlonePAS/commit/4bcbd63ecb3ac6281096a94e9b4e56c3211fa1c4

trigger PropertiesUpdated event when user properties are updated

add simple test for properties updated event

make test imports consistent with existing style &amp; re-order

Files changed:
M CHANGES.rst
M setup.py
M src/Products/PlonePAS/tests/test_memberdatatool.py
M src/Products/PlonePAS/tools/memberdata.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3f2909f..bc805d6 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,11 @@ Changelog
 5.0.16 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Notify PropertiesUpdated event when member properties are changed
+  [ezvirtual]
+
+- Add simple test for PropertiesUpdated event
+  [ezvirtual]
 
 
 5.0.15 (2017-12-11)
diff --git a/setup.py b/setup.py
index c01b5a7..2365d7c 100644
--- a/setup.py
+++ b/setup.py
@@ -3,7 +3,7 @@
 from setuptools import find_packages
 import sys
 
-version = '5.0.16.dev0'
+version = '5.0.16'
 
 longdescription = open("README.rst").read()
 longdescription += '\n'
diff --git a/src/Products/PlonePAS/tests/test_memberdatatool.py b/src/Products/PlonePAS/tests/test_memberdatatool.py
index b7ae400..07bd71c 100644
--- a/src/Products/PlonePAS/tests/test_memberdatatool.py
+++ b/src/Products/PlonePAS/tests/test_memberdatatool.py
@@ -1,9 +1,13 @@
 # -*- coding: utf-8 -*-
 from DateTime import DateTime
 from OFS.Image import Image
+from Products.CMFCore.interfaces import IMemberData
 from Products.PlonePAS.tests import base
 from Products.PlonePAS.tests import dummy
+from Products.PluggableAuthService.interfaces.events import \
+        IPropertiesUpdatedEvent
 from plone.app.testing import TEST_USER_ID as default_user
+import zope.component
 
 
 class TestMemberDataTool(base.TestCase):
@@ -68,3 +72,17 @@ def testFulltextMemberSearch(self):
         self.assertEqual(len(search('bambam.net')), 1)
         self.assertEqual(len(search('bedrock.com')), 2)
         self.assertEqual(len(search('brubble')), 1)
+
+    def testPropertiesUpdatedEvent(self):
+
+        def event_handler(context, event):
+            self._properties_updated_handler_called = True
+
+        gsm = zope.component.getGlobalSiteManager()
+        gsm.registerHandler(event_handler,
+                            (IMemberData, IPropertiesUpdatedEvent))
+
+        self._properties_updated_handler_called = False
+        self.addMember('ez', 'Ez Zy', 'ez@ezmail.net',
+                       ['Member'], '2018-01-01')
+        self.assertTrue(self._properties_updated_handler_called)
diff --git a/src/Products/PlonePAS/tools/memberdata.py b/src/Products/PlonePAS/tools/memberdata.py
index 3458f6d..aa7d4e6 100644
--- a/src/Products/PlonePAS/tools/memberdata.py
+++ b/src/Products/PlonePAS/tools/memberdata.py
@@ -17,11 +17,13 @@
 from Products.PlonePAS.interfaces.group import IGroupManagement
 from Products.PlonePAS.interfaces.plugins import IUserManagement
 from Products.PlonePAS.interfaces.propertysheets import IMutablePropertySheet
+from Products.PluggableAuthService.events import PropertiesUpdated
 from Products.PluggableAuthService.interfaces.authservice import \
     IPluggableAuthService
 from Products.PluggableAuthService.interfaces.plugins import IPropertiesPlugin
 from Products.PluggableAuthService.interfaces.plugins import \
     IRoleAssignerPlugin
+from zope.event import notify
 from zope.interface import implementer
 
 
@@ -286,6 +288,11 @@ def setMemberProperties(self, mapping, force_local=0, force_empty=False):
         if modified:
             self.notifyModified()
 
+        # Trigger PropertiesUpdated event when member properties are updated,
+        # excluding user login events
+        if set(mapping.keys()) != set(('login_time', 'last_login_time')):
+            notify(PropertiesUpdated(self, mapping))
+
     def getProperty(self, id, default=_marker):
         """PAS-specific method to fetch a user's properties. Looks
         through the ordered property sheets.


Repository: Products.PlonePAS


Branch: refs/heads/5.x
Date: 2018-04-24T16:15:36+12:00
Author: ezvirtual (ezvirtual) <ezvirtual@thevirtual.co.nz>
Commit: https://github.com/plone/Products.PlonePAS/commit/17f2929d833a532a4ec6f5c29f9b5229e1252dd1

Changes to notify(PropertiesUpdated) event &amp; tests based on pull-request feedback

Files changed:
M CHANGES.rst
M setup.py
M src/Products/PlonePAS/tests/test_memberdatatool.py
M src/Products/PlonePAS/tools/memberdata.py

diff --git a/CHANGES.rst b/CHANGES.rst
index bc805d6..83234ba 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -7,9 +7,6 @@ Changelog
 - Notify PropertiesUpdated event when member properties are changed
   [ezvirtual]
 
-- Add simple test for PropertiesUpdated event
-  [ezvirtual]
-
 
 5.0.15 (2017-12-11)
 -------------------
diff --git a/setup.py b/setup.py
index 2365d7c..c01b5a7 100644
--- a/setup.py
+++ b/setup.py
@@ -3,7 +3,7 @@
 from setuptools import find_packages
 import sys
 
-version = '5.0.16'
+version = '5.0.16.dev0'
 
 longdescription = open("README.rst").read()
 longdescription += '\n'
diff --git a/src/Products/PlonePAS/tests/test_memberdatatool.py b/src/Products/PlonePAS/tests/test_memberdatatool.py
index 07bd71c..05f381a 100644
--- a/src/Products/PlonePAS/tests/test_memberdatatool.py
+++ b/src/Products/PlonePAS/tests/test_memberdatatool.py
@@ -83,6 +83,41 @@ def event_handler(context, event):
                             (IMemberData, IPropertiesUpdatedEvent))
 
         self._properties_updated_handler_called = False
-        self.addMember('ez', 'Ez Zy', 'ez@ezmail.net',
-                       ['Member'], '2018-01-01')
+
+        username = 'ez'
+        roles = ['Member']
+        fullname = 'Ez Zy'
+        email = 'ez@ezmail.net'
+
+        self.membership.addMember(username, 'secret', roles, [])
+        member = self.membership.getMemberById(username)
+
+        self.assertFalse(self._properties_updated_handler_called)
+
+        member.setMemberProperties({
+            'fullname': fullname,
+            'email': email})
+
         self.assertTrue(self._properties_updated_handler_called)
+
+        # Test that notify(PropertiesUpdated) isn't called on user login.
+        self._properties_updated_handler_called = False
+        login(self.portal, username)
+        # Imitate a login as the plone.app.testing login method doesn't seem to
+        # set these member properties.
+        member.setMemberProperties({
+            'login_time': DateTime('2018-02-15'),
+            'last_login_time': DateTime('2018-02-15')})
+
+        self.assertFalse(self._properties_updated_handler_called)
+
+        # Test notify(PropertiesUpdated) isn't called when login_time is
+        # present as we're assuming this should only be changed on login.
+        self._properties_updated_handler_called = False
+        member.setMemberProperties({
+            'login_time': DateTime('2018-02-15'),
+            'fullname': 'Bed Rock'})
+
+        self.assertFalse(self._properties_updated_handler_called)
+        gsm.unregisterHandler(event_handler,
+                              (IMemberData, IPropertiesUpdatedEvent))
diff --git a/src/Products/PlonePAS/tools/memberdata.py b/src/Products/PlonePAS/tools/memberdata.py
index aa7d4e6..67d3cbe 100644
--- a/src/Products/PlonePAS/tools/memberdata.py
+++ b/src/Products/PlonePAS/tools/memberdata.py
@@ -290,7 +290,7 @@ def setMemberProperties(self, mapping, force_local=0, force_empty=False):
 
         # Trigger PropertiesUpdated event when member properties are updated,
         # excluding user login events
-        if set(mapping.keys()) != set(('login_time', 'last_login_time')):
+        if not set(mapping.keys()) & set(('login_time', 'last_login_time')):
             notify(PropertiesUpdated(self, mapping))
 
     def getProperty(self, id, default=_marker):


Repository: Products.PlonePAS


Branch: refs/heads/5.x
Date: 2018-04-24T17:27:55+12:00
Author: ezvirtual (ezvirtual) <ezvirtual@thevirtual.co.nz>
Commit: https://github.com/plone/Products.PlonePAS/commit/68af52b3f9ae4f98009048347ce5c38246deec78

remove login call from test as it doesn't seem to set login_time or last_login_time properties that I'm attempting to test

Files changed:
M src/Products/PlonePAS/tests/test_memberdatatool.py

diff --git a/src/Products/PlonePAS/tests/test_memberdatatool.py b/src/Products/PlonePAS/tests/test_memberdatatool.py
index 05f381a..6f29b71 100644
--- a/src/Products/PlonePAS/tests/test_memberdatatool.py
+++ b/src/Products/PlonePAS/tests/test_memberdatatool.py
@@ -102,7 +102,7 @@ def event_handler(context, event):
 
         # Test that notify(PropertiesUpdated) isn't called on user login.
         self._properties_updated_handler_called = False
-        login(self.portal, username)
+
         # Imitate a login as the plone.app.testing login method doesn't seem to
         # set these member properties.
         member.setMemberProperties({


Repository: Products.PlonePAS


Branch: refs/heads/5.x
Date: 2018-04-25T07:40:42+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.PlonePAS/commit/f7ee1722813799bf8058dbd722314369714392b9

Merge pull request #35 from TheVirtualLtd/properties-updated-event

Notify PropertiesUpdated event when user properties are updated

Files changed:
M CHANGES.rst
M src/Products/PlonePAS/tests/test_memberdatatool.py
M src/Products/PlonePAS/tools/memberdata.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 3f2909f..83234ba 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -4,7 +4,8 @@ Changelog
 5.0.16 (unreleased)
 -------------------
 
-- Nothing changed yet.
+- Notify PropertiesUpdated event when member properties are changed
+  [ezvirtual]
 
 
 5.0.15 (2017-12-11)
diff --git a/src/Products/PlonePAS/tests/test_memberdatatool.py b/src/Products/PlonePAS/tests/test_memberdatatool.py
index b7ae400..6f29b71 100644
--- a/src/Products/PlonePAS/tests/test_memberdatatool.py
+++ b/src/Products/PlonePAS/tests/test_memberdatatool.py
@@ -1,9 +1,13 @@
 # -*- coding: utf-8 -*-
 from DateTime import DateTime
 from OFS.Image import Image
+from Products.CMFCore.interfaces import IMemberData
 from Products.PlonePAS.tests import base
 from Products.PlonePAS.tests import dummy
+from Products.PluggableAuthService.interfaces.events import \
+        IPropertiesUpdatedEvent
 from plone.app.testing import TEST_USER_ID as default_user
+import zope.component
 
 
 class TestMemberDataTool(base.TestCase):
@@ -68,3 +72,52 @@ def testFulltextMemberSearch(self):
         self.assertEqual(len(search('bambam.net')), 1)
         self.assertEqual(len(search('bedrock.com')), 2)
         self.assertEqual(len(search('brubble')), 1)
+
+    def testPropertiesUpdatedEvent(self):
+
+        def event_handler(context, event):
+            self._properties_updated_handler_called = True
+
+        gsm = zope.component.getGlobalSiteManager()
+        gsm.registerHandler(event_handler,
+                            (IMemberData, IPropertiesUpdatedEvent))
+
+        self._properties_updated_handler_called = False
+
+        username = 'ez'
+        roles = ['Member']
+        fullname = 'Ez Zy'
+        email = 'ez@ezmail.net'
+
+        self.membership.addMember(username, 'secret', roles, [])
+        member = self.membership.getMemberById(username)
+
+        self.assertFalse(self._properties_updated_handler_called)
+
+        member.setMemberProperties({
+            'fullname': fullname,
+            'email': email})
+
+        self.assertTrue(self._properties_updated_handler_called)
+
+        # Test that notify(PropertiesUpdated) isn't called on user login.
+        self._properties_updated_handler_called = False
+
+        # Imitate a login as the plone.app.testing login method doesn't seem to
+        # set these member properties.
+        member.setMemberProperties({
+            'login_time': DateTime('2018-02-15'),
+            'last_login_time': DateTime('2018-02-15')})
+
+        self.assertFalse(self._properties_updated_handler_called)
+
+        # Test notify(PropertiesUpdated) isn't called when login_time is
+        # present as we're assuming this should only be changed on login.
+        self._properties_updated_handler_called = False
+        member.setMemberProperties({
+            'login_time': DateTime('2018-02-15'),
+            'fullname': 'Bed Rock'})
+
+        self.assertFalse(self._properties_updated_handler_called)
+        gsm.unregisterHandler(event_handler,
+                              (IMemberData, IPropertiesUpdatedEvent))
diff --git a/src/Products/PlonePAS/tools/memberdata.py b/src/Products/PlonePAS/tools/memberdata.py
index 3458f6d..67d3cbe 100644
--- a/src/Products/PlonePAS/tools/memberdata.py
+++ b/src/Products/PlonePAS/tools/memberdata.py
@@ -17,11 +17,13 @@
 from Products.PlonePAS.interfaces.group import IGroupManagement
 from Products.PlonePAS.interfaces.plugins import IUserManagement
 from Products.PlonePAS.interfaces.propertysheets import IMutablePropertySheet
+from Products.PluggableAuthService.events import PropertiesUpdated
 from Products.PluggableAuthService.interfaces.authservice import \
     IPluggableAuthService
 from Products.PluggableAuthService.interfaces.plugins import IPropertiesPlugin
 from Products.PluggableAuthService.interfaces.plugins import \
     IRoleAssignerPlugin
+from zope.event import notify
 from zope.interface import implementer
 
 
@@ -286,6 +288,11 @@ def setMemberProperties(self, mapping, force_local=0, force_empty=False):
         if modified:
             self.notifyModified()
 
+        # Trigger PropertiesUpdated event when member properties are updated,
+        # excluding user login events
+        if not set(mapping.keys()) & set(('login_time', 'last_login_time')):
+            notify(PropertiesUpdated(self, mapping))
+
     def getProperty(self, id, default=_marker):
         """PAS-specific method to fetch a user's properties. Looks
         through the ordered property sheets.


