Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2019-11-25T18:43:57+01:00
Author: Thomas Massmann (tmassman) <thomas.massmann@it-spir.it>
Commit: https://github.com/plone/Products.CMFPlone/commit/340af73069069777f24181e71a1a65ded40c9974

Cherrypick b0648a675:

#Merge pull request #2663 from plone/cekk_fix_content_controlpanel

Do not save type settings in "content-controlpanel" when switching between types.

Files changed:
M Products/CMFPlone/controlpanel/browser/types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py

b'diff --git a/Products/CMFPlone/controlpanel/browser/types.py b/Products/CMFPlone/controlpanel/browser/types.py\nindex fc73fdefd..6d802ce22 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.py\n+++ b/Products/CMFPlone/controlpanel/browser/types.py\n@@ -122,7 +122,7 @@ def __call__(self):\n         cancel_button = form.get(\'form.button.Cancel\', None) is not None\n         type_id = form.get(\'old_type_id\', None)\n \n-        if submitted and not cancel_button:\n+        if save_button and submitted and not cancel_button:\n             if type_id:\n                 portal_types = getToolByName(self.context, \'portal_types\')\n                 portal_repository = getToolByName(self.context,\n@@ -200,9 +200,9 @@ def __call__(self):\n                 elif not default_page_type and type_id in default_page_types:\n                     default_page_types.remove(type_id)\n                 types_settings.default_page_types = default_page_types\n-\n-                redirect_links = form.get(\'redirect_links\', False)\n-                types_settings.redirect_links = redirect_links\n+                if type_id == \'Link\':\n+                    redirect_links = form.get(\'redirect_links\', False)\n+                    types_settings.redirect_links = redirect_links\n \n             # Update workflow\n             if self.have_new_workflow() \\\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\nindex 64c555970..554d1655e 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n@@ -110,7 +110,7 @@ def test_disable_versioning_removes_behavior(self):\n         self.browser.getControl(name=\'type_id\').value = [\'Document\']\n         self.browser.getForm(action=self.types_url).submit()\n         self.browser.getControl(name=\'versionpolicy\').value = [\'off\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n@@ -123,7 +123,7 @@ def test_enable_versioning_behavior_on_document(self):\n         self.browser.getControl(name=\'type_id\').value = [\'Document\']\n         self.browser.getForm(action=self.types_url).submit()\n         self.browser.getControl(name=\'versionpolicy\').value = [\'off\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n@@ -132,7 +132,7 @@ def test_enable_versioning_behavior_on_document(self):\n             not in doc_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         self.assertTrue(\n             \'plone.app.versioningbehavior.behaviors.IVersionable\'\n@@ -157,7 +157,7 @@ def test_enable_versioning_behavior_on_file(self):\n             not in file_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\'Save\').click()\n \n         self.assertTrue(\n             \'plone.app.versioningbehavior.behaviors.IVersionable\'\n@@ -165,3 +165,64 @@ def test_enable_versioning_behavior_on_file(self):\n         self.assertTrue(\n             \'plone.app.lockingbehavior.behaviors.ILocking\'\n             in file_type.behaviors)\n+\n+    def test_dont_update_settings_when_switch_types(self):\n+        # First of all, set a default\n+        self.browser.open(self.types_url)\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\n+            \'Redirect immediately to link target\'\n+        ).selected = True\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Then switch the type\n+        self.browser.getControl(name=\'type_id\').value = [\'Document\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.assertFalse(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+\n+        # Go back to the link, and check the value\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+\n+        self.assertTrue(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.assertEquals(\n+            self.browser.getControl(\n+                \'Redirect immediately to link target\').selected,\n+            True\n+        )\n+\n+    def test_dont_update_redirect_links_when_not_in_link_settings(self):\n+        # First of all, set a default\n+        self.browser.open(self.types_url)\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\n+            \'Redirect immediately to link target\'\n+        ).selected = True\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Then switch the type\n+        self.browser.getControl(name=\'type_id\').value = [\'Document\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.assertFalse(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Go back to the link, and check the value\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+\n+        self.assertTrue(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.assertEquals(\n+            self.browser.getControl(\n+                \'Redirect immediately to link target\').selected,\n+            True\n+        )\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2019-11-25T18:52:17+01:00
Author: Thomas Massmann (tmassman) <thomas.massmann@it-spir.it>
Commit: https://github.com/plone/Products.CMFPlone/commit/0cee75d06dac88947b2c60a5bf5109a65b06b01a

Add changelog.

Files changed:
A news/2986.bugfix

b'diff --git a/news/2986.bugfix b/news/2986.bugfix\nnew file mode 100644\nindex 000000000..0af4d0128\n--- /dev/null\n+++ b/news/2986.bugfix\n@@ -0,0 +1,2 @@\n+Do not save type settings in "content-controlpanel" when switching between types.\n+[cekk]\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2019-11-25T21:25:12+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/9a3b229b1bd234c877b807b598615d075e85eb1a

Merge pull request #2990 from plone/2986-contenttypes-controlpanel

Apply types controlpanel fix to 5.2.x.

Files changed:
A news/2986.bugfix
M Products/CMFPlone/controlpanel/browser/types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py

b'diff --git a/Products/CMFPlone/controlpanel/browser/types.py b/Products/CMFPlone/controlpanel/browser/types.py\nindex fc73fdefd..6d802ce22 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.py\n+++ b/Products/CMFPlone/controlpanel/browser/types.py\n@@ -122,7 +122,7 @@ def __call__(self):\n         cancel_button = form.get(\'form.button.Cancel\', None) is not None\n         type_id = form.get(\'old_type_id\', None)\n \n-        if submitted and not cancel_button:\n+        if save_button and submitted and not cancel_button:\n             if type_id:\n                 portal_types = getToolByName(self.context, \'portal_types\')\n                 portal_repository = getToolByName(self.context,\n@@ -200,9 +200,9 @@ def __call__(self):\n                 elif not default_page_type and type_id in default_page_types:\n                     default_page_types.remove(type_id)\n                 types_settings.default_page_types = default_page_types\n-\n-                redirect_links = form.get(\'redirect_links\', False)\n-                types_settings.redirect_links = redirect_links\n+                if type_id == \'Link\':\n+                    redirect_links = form.get(\'redirect_links\', False)\n+                    types_settings.redirect_links = redirect_links\n \n             # Update workflow\n             if self.have_new_workflow() \\\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\nindex 64c555970..554d1655e 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n@@ -110,7 +110,7 @@ def test_disable_versioning_removes_behavior(self):\n         self.browser.getControl(name=\'type_id\').value = [\'Document\']\n         self.browser.getForm(action=self.types_url).submit()\n         self.browser.getControl(name=\'versionpolicy\').value = [\'off\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n@@ -123,7 +123,7 @@ def test_enable_versioning_behavior_on_document(self):\n         self.browser.getControl(name=\'type_id\').value = [\'Document\']\n         self.browser.getForm(action=self.types_url).submit()\n         self.browser.getControl(name=\'versionpolicy\').value = [\'off\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n@@ -132,7 +132,7 @@ def test_enable_versioning_behavior_on_document(self):\n             not in doc_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         self.assertTrue(\n             \'plone.app.versioningbehavior.behaviors.IVersionable\'\n@@ -157,7 +157,7 @@ def test_enable_versioning_behavior_on_file(self):\n             not in file_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\'Save\').click()\n \n         self.assertTrue(\n             \'plone.app.versioningbehavior.behaviors.IVersionable\'\n@@ -165,3 +165,64 @@ def test_enable_versioning_behavior_on_file(self):\n         self.assertTrue(\n             \'plone.app.lockingbehavior.behaviors.ILocking\'\n             in file_type.behaviors)\n+\n+    def test_dont_update_settings_when_switch_types(self):\n+        # First of all, set a default\n+        self.browser.open(self.types_url)\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\n+            \'Redirect immediately to link target\'\n+        ).selected = True\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Then switch the type\n+        self.browser.getControl(name=\'type_id\').value = [\'Document\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.assertFalse(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+\n+        # Go back to the link, and check the value\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+\n+        self.assertTrue(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.assertEquals(\n+            self.browser.getControl(\n+                \'Redirect immediately to link target\').selected,\n+            True\n+        )\n+\n+    def test_dont_update_redirect_links_when_not_in_link_settings(self):\n+        # First of all, set a default\n+        self.browser.open(self.types_url)\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\n+            \'Redirect immediately to link target\'\n+        ).selected = True\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Then switch the type\n+        self.browser.getControl(name=\'type_id\').value = [\'Document\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.assertFalse(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Go back to the link, and check the value\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+\n+        self.assertTrue(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.assertEquals(\n+            self.browser.getControl(\n+                \'Redirect immediately to link target\').selected,\n+            True\n+        )\ndiff --git a/news/2986.bugfix b/news/2986.bugfix\nnew file mode 100644\nindex 000000000..0af4d0128\n--- /dev/null\n+++ b/news/2986.bugfix\n@@ -0,0 +1,2 @@\n+Do not save type settings in "content-controlpanel" when switching between types.\n+[cekk]\n'

