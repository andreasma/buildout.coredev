Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2018-07-05T15:14:07+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/7c13815eaaba9da9c85a44d4f856d5cc77dae823

Upgrade step to profile version 3 was lost and now recreated

Files changed:
A src/plone/app/multilingual/profiles/upgrades/to_3/registry.xml
M CHANGES.rst
M src/plone/app/multilingual/upgrades.py
M src/plone/app/multilingual/upgrades.zcml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex e66306f4..fa02b482 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,7 +14,10 @@ New features:\n \n Bug fixes:\n \n-- Do not show deprecation warning when loading migrator code, \n+- Upgrade step to profile version 3 was lost and now recreated.\n+  [jensens, 2silver]\n+\n+- Do not show deprecation warning when loading migrator code,\n   as it is intended to load old LRF there.\n   [jensens]\n \ndiff --git a/src/plone/app/multilingual/profiles/upgrades/to_3/registry.xml b/src/plone/app/multilingual/profiles/upgrades/to_3/registry.xml\nnew file mode 100644\nindex 00000000..a719a89b\n--- /dev/null\n+++ b/src/plone/app/multilingual/profiles/upgrades/to_3/registry.xml\n@@ -0,0 +1,7 @@\n+<?xml version="1.0"?>\n+<registry>\n+ <records interface="plone.app.multilingual.interfaces.IMultiLanguageExtraOptionsSchema"\n+          prefix="plone">\n+    <value key="bypass_languageindependent_field_permission_check">False</value>\n+ </records>\n+</registry>\ndiff --git a/src/plone/app/multilingual/upgrades.py b/src/plone/app/multilingual/upgrades.py\nindex 13956ddc..f803770d 100644\n--- a/src/plone/app/multilingual/upgrades.py\n+++ b/src/plone/app/multilingual/upgrades.py\n@@ -1,9 +1,11 @@\n # -*- coding: utf-8 -*-\n from plone.app.multilingual import logger\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import ILanguage\n from Products.CMFPlone.utils import _createObjectByType\n from time import time\n+from zope.component import getUtility\n \n import transaction\n \n@@ -119,8 +121,25 @@ def migration_pam_1_to_2(context):\n     logger.info("All finished in {0}.".format(time() - s1))\n \n \n+def upgrade_to_3(context):\n+    registry = getUtility(IRegistry)\n+\n+    # don\'t re-create if it already exists\n+    key = (\n+        \'plone.app.multilingual.interfaces.IMultiLanguageExtraOptionsSchema.\'\n+        \'bypass_languageindependent_field_permission_check\'\n+    )\n+    if key in registry:\n+        return\n+\n+    context.runImportStepFromProfile(\n+        PROFILE_ID.replace(\'default\', \'to_3\'),\n+        \'plone.app.registry\',\n+    )\n+\n+\n def upgrade_to_4(context):\n     context.runImportStepFromProfile(\n         PROFILE_ID.replace(\'default\', \'to_4\'),\n-        \'plone.app.registry\'\n+        \'plone.app.registry\',\n     )\ndiff --git a/src/plone/app/multilingual/upgrades.zcml b/src/plone/app/multilingual/upgrades.zcml\nindex 7810e2ca..88c4005c 100644\n--- a/src/plone/app/multilingual/upgrades.zcml\n+++ b/src/plone/app/multilingual/upgrades.zcml\n@@ -20,9 +20,25 @@\n       handler="plone.app.multilingual.upgrades.migration_pam_1_to_2"\n       profile="plone.app.multilingual:default"/>\n \n+  <genericsetup:registerProfile\n+      name="to_3"\n+      title="Update new registry key"\n+      directory="profiles/upgrades/to_3"\n+      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+\n+  <genericsetup:upgradeStep\n+      profile="plone.app.multilingual:default"\n+      source="2"\n+      destination="3"\n+      title="Add new registry entry"\n+      handler=".upgrades.upgrade_to_3"\n+      />\n+\n   <genericsetup:registerProfile\n       name="to_4"\n-      title="Update bundle regristration"\n+      title="Update bundle registration"\n       directory="profiles/upgrades/to_4"\n       for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n@@ -32,9 +48,8 @@\n       profile="plone.app.multilingual:default"\n       source="3"\n       destination="4"\n-      title="Update bundle regristration"\n+      title="Update bundle registration"\n       handler=".upgrades.upgrade_to_4"\n       />\n \n-\n </configure>\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2018-08-06T12:36:41+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/724863c175d9741273ab1730e9d02494c479e172

Merge pull request #319 from plone/fix-lost-upgrade-step

Upgrade step to profile version 3 was lost and now recreated

Files changed:
A src/plone/app/multilingual/profiles/upgrades/to_3/registry.xml
M CHANGES.rst
M src/plone/app/multilingual/upgrades.py
M src/plone/app/multilingual/upgrades.zcml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex e66306f4..fa02b482 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,7 +14,10 @@ New features:\n \n Bug fixes:\n \n-- Do not show deprecation warning when loading migrator code, \n+- Upgrade step to profile version 3 was lost and now recreated.\n+  [jensens, 2silver]\n+\n+- Do not show deprecation warning when loading migrator code,\n   as it is intended to load old LRF there.\n   [jensens]\n \ndiff --git a/src/plone/app/multilingual/profiles/upgrades/to_3/registry.xml b/src/plone/app/multilingual/profiles/upgrades/to_3/registry.xml\nnew file mode 100644\nindex 00000000..a719a89b\n--- /dev/null\n+++ b/src/plone/app/multilingual/profiles/upgrades/to_3/registry.xml\n@@ -0,0 +1,7 @@\n+<?xml version="1.0"?>\n+<registry>\n+ <records interface="plone.app.multilingual.interfaces.IMultiLanguageExtraOptionsSchema"\n+          prefix="plone">\n+    <value key="bypass_languageindependent_field_permission_check">False</value>\n+ </records>\n+</registry>\ndiff --git a/src/plone/app/multilingual/upgrades.py b/src/plone/app/multilingual/upgrades.py\nindex 13956ddc..f803770d 100644\n--- a/src/plone/app/multilingual/upgrades.py\n+++ b/src/plone/app/multilingual/upgrades.py\n@@ -1,9 +1,11 @@\n # -*- coding: utf-8 -*-\n from plone.app.multilingual import logger\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import ILanguage\n from Products.CMFPlone.utils import _createObjectByType\n from time import time\n+from zope.component import getUtility\n \n import transaction\n \n@@ -119,8 +121,25 @@ def migration_pam_1_to_2(context):\n     logger.info("All finished in {0}.".format(time() - s1))\n \n \n+def upgrade_to_3(context):\n+    registry = getUtility(IRegistry)\n+\n+    # don\'t re-create if it already exists\n+    key = (\n+        \'plone.app.multilingual.interfaces.IMultiLanguageExtraOptionsSchema.\'\n+        \'bypass_languageindependent_field_permission_check\'\n+    )\n+    if key in registry:\n+        return\n+\n+    context.runImportStepFromProfile(\n+        PROFILE_ID.replace(\'default\', \'to_3\'),\n+        \'plone.app.registry\',\n+    )\n+\n+\n def upgrade_to_4(context):\n     context.runImportStepFromProfile(\n         PROFILE_ID.replace(\'default\', \'to_4\'),\n-        \'plone.app.registry\'\n+        \'plone.app.registry\',\n     )\ndiff --git a/src/plone/app/multilingual/upgrades.zcml b/src/plone/app/multilingual/upgrades.zcml\nindex 7810e2ca..88c4005c 100644\n--- a/src/plone/app/multilingual/upgrades.zcml\n+++ b/src/plone/app/multilingual/upgrades.zcml\n@@ -20,9 +20,25 @@\n       handler="plone.app.multilingual.upgrades.migration_pam_1_to_2"\n       profile="plone.app.multilingual:default"/>\n \n+  <genericsetup:registerProfile\n+      name="to_3"\n+      title="Update new registry key"\n+      directory="profiles/upgrades/to_3"\n+      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+\n+  <genericsetup:upgradeStep\n+      profile="plone.app.multilingual:default"\n+      source="2"\n+      destination="3"\n+      title="Add new registry entry"\n+      handler=".upgrades.upgrade_to_3"\n+      />\n+\n   <genericsetup:registerProfile\n       name="to_4"\n-      title="Update bundle regristration"\n+      title="Update bundle registration"\n       directory="profiles/upgrades/to_4"\n       for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n@@ -32,9 +48,8 @@\n       profile="plone.app.multilingual:default"\n       source="3"\n       destination="4"\n-      title="Update bundle regristration"\n+      title="Update bundle registration"\n       handler=".upgrades.upgrade_to_4"\n       />\n \n-\n </configure>\n'

