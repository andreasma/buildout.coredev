Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-06T15:16:34+01:00
Author: Wolfgang Thomas (pysailor) <thomas@syslab.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/3b3137a6b51e5a7b4c250fabe836f91ec3ee4ab5

Update all FTIs that use the RichText or LeadImage behaviors

Files changed:
A news/192.bugfix
M plone/app/upgrade/v52/alphas.py

b"diff --git a/news/192.bugfix b/news/192.bugfix\nnew file mode 100644\nindex 00000000..5777bde9\n--- /dev/null\n+++ b/news/192.bugfix\n@@ -0,0 +1 @@\n+Update all FTIs that use the RichText or LeadImage behaviors\ndiff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py\nindex 9d530ae5..50112b46 100644\n--- a/plone/app/upgrade/v52/alphas.py\n+++ b/plone/app/upgrade/v52/alphas.py\n@@ -1,6 +1,7 @@\n # -*- coding: utf-8 -*-\n from plone.app.upgrade.utils import cleanUpSkinsTool\n from plone.app.upgrade.utils import loadMigrationProfile\n+from plone.dexterity.interfaces import IDexterityFTI\n from plone.folder.nogopip import manage_addGopipIndex\n from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n@@ -29,6 +30,34 @@ def migrate_gopipindex(context):\n     manage_addGopipIndex(catalog, 'getObjPositionInParent')\n \n \n+def fix_core_behaviors_in_ftis(context):\n+    # The behaviors for IRichText and ILeadImage have been renamed.\n+    # All FTIs that use them must be updated accordingly\n+    # See plone/plone.app.contenttypes#480\n+    types_tool = getToolByName(context, 'portal_types')\n+    to_replace = {\n+        'plone.app.contenttypes.behaviors.richtext.IRichText':\n+            'plone.app.contenttypes.behaviors.richtext.IRichTextBehavior',\n+        'plone.app.contenttypes.behaviors.leadimage.ILeadImage':\n+            'plone.app.contenttypes.behaviors.leadimage.ILeadImageBehavior',\n+    }\n+    ftis = types_tool.listTypeInfo()\n+    for fti in ftis:\n+        # Since we're handling dexterity behaviors, we only care about\n+        # dexterity FTIs\n+        if not IDexterityFTI.providedBy(fti):\n+            continue\n+        behaviors = []\n+        change_needed = False\n+        for behavior in fti.behaviors:\n+            if behavior in to_replace:\n+                behavior = to_replace[behavior]\n+                change_needed = True\n+            behaviors.append(behavior)\n+        if change_needed:\n+            fti.behaviors = tuple(behaviors)\n+\n+\n def to52alpha1(context):\n     loadMigrationProfile(context, 'profile-plone.app.upgrade.v52:to52alpha1')\n     portal = getToolByName(context, 'portal_url').getPortalObject()\n@@ -36,3 +65,4 @@ def to52alpha1(context):\n \n     cleanup_resources()\n     migrate_gopipindex(context)\n+    fix_core_behaviors_in_ftis(context)\n"

