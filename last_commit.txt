Repository: plone.restapi


Branch: refs/heads/master
Date: 2019-12-06T19:06:34+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/c7acf2fb5e943e2a1ed3bba174c5670a071a2c4e

Rename iface name to the short name in blocks (#839)

* Rename iface name to the short name in blocks

* Missing change the internal version

Files changed:
A news/838.bugfix
A src/plone/restapi/upgrades/to0006.py
M src/plone/restapi/profiles/blocks/types/Document.xml
M src/plone/restapi/profiles/default/metadata.xml
M src/plone/restapi/tests/test_behaviors.py
M src/plone/restapi/tests/test_content_blocks.py
M src/plone/restapi/upgrades/configure.zcml
M src/plone/restapi/upgrades/to0005.py

b'diff --git a/news/838.bugfix b/news/838.bugfix\nnew file mode 100644\nindex 00000000..4826e55f\n--- /dev/null\n+++ b/news/838.bugfix\n@@ -0,0 +1,2 @@\n+Change to use the short name for the Blocks behavior instead of using the interface one. It fixes #838.\n+[sneridagh]\ndiff --git a/src/plone/restapi/profiles/blocks/types/Document.xml b/src/plone/restapi/profiles/blocks/types/Document.xml\nindex 9ee0e772..a9a2869a 100644\n--- a/src/plone/restapi/profiles/blocks/types/Document.xml\n+++ b/src/plone/restapi/profiles/blocks/types/Document.xml\n@@ -2,7 +2,7 @@\n <object name="Document" meta_type="Dexterity FTI" i18n:domain="plone"\n    xmlns:i18n="http://xml.zope.org/namespaces/i18n">\n  <property name="behaviors" purge="false">\n-  <element value="plone.restapi.behaviors.IBlocks" />\n+  <element value="volto.blocks" />\n  </property>\n \n </object>\ndiff --git a/src/plone/restapi/profiles/default/metadata.xml b/src/plone/restapi/profiles/default/metadata.xml\nindex b57fed78..81970e34 100644\n--- a/src/plone/restapi/profiles/default/metadata.xml\n+++ b/src/plone/restapi/profiles/default/metadata.xml\n@@ -1,4 +1,4 @@\n <?xml version="1.0"?>\n <metadata>\n-  <version>0005</version>\n+  <version>0006</version>\n </metadata>\ndiff --git a/src/plone/restapi/tests/test_behaviors.py b/src/plone/restapi/tests/test_behaviors.py\nindex 485dd3e4..c412162f 100644\n--- a/src/plone/restapi/tests/test_behaviors.py\n+++ b/src/plone/restapi/tests/test_behaviors.py\n@@ -23,7 +23,7 @@ def setUp(self):\n         fti = DexterityFTI("blocksfolder")\n         self.portal.portal_types._setObject("blocksfolder", fti)\n         fti.klass = "plone.dexterity.content.Container"\n-        fti.behaviors = ("plone.restapi.behaviors.IBlocks",)\n+        fti.behaviors = ("volto.blocks",)\n         self.fti = fti\n         alsoProvides(self.request, IBlocks)\n \ndiff --git a/src/plone/restapi/tests/test_content_blocks.py b/src/plone/restapi/tests/test_content_blocks.py\nindex a0e2d4e4..3651990c 100644\n--- a/src/plone/restapi/tests/test_content_blocks.py\n+++ b/src/plone/restapi/tests/test_content_blocks.py\n@@ -29,7 +29,7 @@ def setUp(self):\n \n         fti = queryUtility(IDexterityFTI, name="Document")\n         behavior_list = [a for a in fti.behaviors]\n-        behavior_list.append("plone.restapi.behaviors.IBlocks")\n+        behavior_list.append("volto.blocks")\n         behavior_list.append("plone.leadimage")\n         fti.behaviors = tuple(behavior_list)\n \ndiff --git a/src/plone/restapi/upgrades/configure.zcml b/src/plone/restapi/upgrades/configure.zcml\nindex 32e03841..ca6bb951 100644\n--- a/src/plone/restapi/upgrades/configure.zcml\n+++ b/src/plone/restapi/upgrades/configure.zcml\n@@ -50,4 +50,13 @@\n         profile="plone.restapi:default"\n         />\n \n+    <genericsetup:upgradeStep\n+        title="Rename iface name to the short name in blocks"\n+        description=""\n+        source="0005"\n+        destination="0006"\n+        handler="plone.restapi.upgrades.to0006.rename_iface_to_name_in_blocks_behavior"\n+        profile="plone.restapi:default"\n+        />\n+\n </configure>\ndiff --git a/src/plone/restapi/upgrades/to0005.py b/src/plone/restapi/upgrades/to0005.py\nindex 782fa6e4..32ad4f30 100644\n--- a/src/plone/restapi/upgrades/to0005.py\n+++ b/src/plone/restapi/upgrades/to0005.py\n@@ -9,7 +9,7 @@\n \n OLD_BEHAVIOR_NAME = "plone.restapi.behaviors.ITiles"\n SHORT_OLD_BEHAVIOR_NAME = "plone.tiles"\n-NEW_BEHAVIOR_NAME = "plone.restapi.behaviors.IBlocks"\n+SHORT_NEW_NAME = "volto.blocks"\n \n \n def rename_tiles_to_blocks(setup_context):\n@@ -28,7 +28,7 @@ def rename_tiles_to_blocks(setup_context):\n                 for currentbehavior in fti.behaviors\n                 if currentbehavior != OLD_BEHAVIOR_NAME\n             ]\n-            new_fti.append(NEW_BEHAVIOR_NAME)\n+            new_fti.append(SHORT_NEW_NAME)\n             fti.behaviors = tuple(new_fti)\n             logger.info("Migrated behavior of {} type".format(_type))\n \n@@ -40,7 +40,7 @@ def rename_tiles_to_blocks(setup_context):\n                 for currentbehavior in fti.behaviors\n                 if currentbehavior != SHORT_OLD_BEHAVIOR_NAME\n             ]\n-            new_fti.append(NEW_BEHAVIOR_NAME)\n+            new_fti.append(SHORT_NEW_NAME)\n             fti.behaviors = tuple(new_fti)\n             logger.info("Migrated behavior of {} type".format(_type))\n \ndiff --git a/src/plone/restapi/upgrades/to0006.py b/src/plone/restapi/upgrades/to0006.py\nnew file mode 100644\nindex 00000000..80aea10e\n--- /dev/null\n+++ b/src/plone/restapi/upgrades/to0006.py\n@@ -0,0 +1,29 @@\n+# -*- coding: utf-8 -*-\n+from plone import api\n+from zope.component import queryUtility\n+from plone.dexterity.interfaces import IDexterityFTI\n+\n+import logging\n+\n+logger = logging.getLogger(__name__)\n+\n+DEPRECATED_NEW_BEHAVIOR_NAME = "plone.restapi.behaviors.IBlocks"\n+SHORT_NEW_NAME = "volto.blocks"\n+\n+\n+def rename_iface_to_name_in_blocks_behavior(setup_context):\n+    """Rename iface name to the short name in blocks\n+    """\n+    pt = api.portal.get_tool("portal_types")\n+\n+    for _type in pt.objectIds():\n+        fti = queryUtility(IDexterityFTI, name=_type)\n+        if fti and DEPRECATED_NEW_BEHAVIOR_NAME in fti.behaviors:\n+            new_fti = [\n+                currentbehavior\n+                for currentbehavior in fti.behaviors\n+                if currentbehavior != DEPRECATED_NEW_BEHAVIOR_NAME\n+            ]\n+            new_fti.append(SHORT_NEW_NAME)\n+            fti.behaviors = tuple(new_fti)\n+            logger.info("Migrated behavior of {} type".format(_type))\n'

