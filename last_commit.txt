Repository: plone.folder


Branch: refs/heads/1.x
Date: 2018-10-12T15:42:30-04:00
Author: vangheem (vangheem) <vangheem@gmail.com>
Commit: https://github.com/plone/plone.folder/commit/6604216dd5c29ec4ffe8b52c456669d9e793fecb

Fix KeyError when removing object that is not referenced in ordering annotation

Co-authored-by: Wildcard Corp. &lt;corporate@wildcardcorp.com&gt;

Files changed:
M CHANGES.rst
M src/plone/folder/default.py
M src/plone/folder/tests/test_ordersupport.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 4b5a6a1..f8e76a0 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -15,7 +15,9 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Fix KeyError when removing object that is not referenced\n+  in ordering annotation\n+  [vangheem]\n \n \n 1.0.11 (2018-04-08)\ndiff --git a/src/plone/folder/default.py b/src/plone/folder/default.py\nindex c7ad8d7..4eab59c 100644\n--- a/src/plone/folder/default.py\n+++ b/src/plone/folder/default.py\n@@ -34,8 +34,11 @@ def notifyRemoved(self, obj_id):\n         """ see interfaces.py """\n         order = self._order()\n         pos = self._pos()\n-        idx = pos[obj_id]\n-        del order[idx]\n+        try:\n+            idx = pos[obj_id]\n+            del order[idx]\n+        except KeyError:\n+            pass\n         # we now need to rebuild pos since the ids have shifted\n         pos.clear()\n         for count, obj_id in enumerate(order):\ndiff --git a/src/plone/folder/tests/test_ordersupport.py b/src/plone/folder/tests/test_ordersupport.py\nindex 3459260..0808e1b 100644\n--- a/src/plone/folder/tests/test_ordersupport.py\n+++ b/src/plone/folder/tests/test_ordersupport.py\n@@ -344,3 +344,20 @@ def testIgnoreNonObjects(self):\n         self.assertEqual(self.folder.getObjectPosition(\'bar\'), 0)\n         self.assertEqual(self.folder.getObjectPosition(\'foo\'), 1)\n         self.assertEqual(self.folder.getObjectPosition(\'baz\'), 2)\n+\n+    def testNotifyRemoved(self):\n+        ordering = self.folder.getOrdering()\n+        self.assertEqual(\n+            ordering.idsInOrder(),\n+            [\'foo\', \'bar\', \'baz\']\n+        )\n+\n+        # make sure notifyRemoved with non-existent id does not throw error\n+        ordering.notifyRemoved(\'foobar\')\n+\n+        # normal\n+        ordering.notifyRemoved(\'foo\')\n+        self.assertEqual(\n+            ordering.idsInOrder(),\n+            [\'bar\', \'baz\']\n+        )\n'

Repository: plone.folder


Branch: refs/heads/1.x
Date: 2018-10-13T14:53:39+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.folder/commit/57fda3abd9017e6fedaf841491efe08199aa7e2f

Merge pull request #10 from plone/vangheem-1x-fix-keyerror

Fix KeyError when removing object that is not referenced in ordering annotation

Files changed:
M CHANGES.rst
M src/plone/folder/default.py
M src/plone/folder/tests/test_ordersupport.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 4b5a6a1..f8e76a0 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -15,7 +15,9 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Fix KeyError when removing object that is not referenced\n+  in ordering annotation\n+  [vangheem]\n \n \n 1.0.11 (2018-04-08)\ndiff --git a/src/plone/folder/default.py b/src/plone/folder/default.py\nindex c7ad8d7..4eab59c 100644\n--- a/src/plone/folder/default.py\n+++ b/src/plone/folder/default.py\n@@ -34,8 +34,11 @@ def notifyRemoved(self, obj_id):\n         """ see interfaces.py """\n         order = self._order()\n         pos = self._pos()\n-        idx = pos[obj_id]\n-        del order[idx]\n+        try:\n+            idx = pos[obj_id]\n+            del order[idx]\n+        except KeyError:\n+            pass\n         # we now need to rebuild pos since the ids have shifted\n         pos.clear()\n         for count, obj_id in enumerate(order):\ndiff --git a/src/plone/folder/tests/test_ordersupport.py b/src/plone/folder/tests/test_ordersupport.py\nindex 3459260..0808e1b 100644\n--- a/src/plone/folder/tests/test_ordersupport.py\n+++ b/src/plone/folder/tests/test_ordersupport.py\n@@ -344,3 +344,20 @@ def testIgnoreNonObjects(self):\n         self.assertEqual(self.folder.getObjectPosition(\'bar\'), 0)\n         self.assertEqual(self.folder.getObjectPosition(\'foo\'), 1)\n         self.assertEqual(self.folder.getObjectPosition(\'baz\'), 2)\n+\n+    def testNotifyRemoved(self):\n+        ordering = self.folder.getOrdering()\n+        self.assertEqual(\n+            ordering.idsInOrder(),\n+            [\'foo\', \'bar\', \'baz\']\n+        )\n+\n+        # make sure notifyRemoved with non-existent id does not throw error\n+        ordering.notifyRemoved(\'foobar\')\n+\n+        # normal\n+        ordering.notifyRemoved(\'foo\')\n+        self.assertEqual(\n+            ordering.idsInOrder(),\n+            [\'bar\', \'baz\']\n+        )\n'

