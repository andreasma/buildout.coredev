Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-09-09T11:56:19+02:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/31dba25f4dc9ca0accf474fa828ba3773f115a6a

Update resources for plone.app.event

changelog

Files changed:
A plone/app/upgrade/v51/profiles/to_513/registry.xml
M CHANGES.rst
M plone/app/upgrade/v51/configure.zcml
M plone/app/upgrade/v51/final.py
M plone/app/upgrade/v51/profiles.zcml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 45c9b7e6..dfc7248c 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -20,6 +20,8 @@ Bug fixes:\n \n - *add item here*\n \n+- Update resources for plone.app.event.  [agitator]\n+\n \n 2.0.15 (2018-06-21)\n -------------------\ndiff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml\nindex 113678a9..ad19471b 100644\n--- a/plone/app/upgrade/v51/configure.zcml\n+++ b/plone/app/upgrade/v51/configure.zcml\n@@ -243,12 +243,18 @@ Add image scaling options to image handling control panel.\n         destination="5113"\n         profile="Products.CMFPlone:plone">\n \n+        <gs:upgradeDepends\n+            title="Run to513 upgrade profile."\n+            description="Update resources for plone.app.event"\n+            import_profile="plone.app.upgrade.v51:to513"\n+            />\n+\n         <gs:upgradeStep\n-            title="Miscellaneous"\n-            description=""\n-            handler="..utils.null_upgrade_step"\n+            title="Force remove old p.a.event resources"\n+            handler=".final.remove_old_PAE_rescources"\n             />\n \n+\n     </gs:upgradeSteps>\n \n     <gs:upgradeSteps\ndiff --git a/plone/app/upgrade/v51/final.py b/plone/app/upgrade/v51/final.py\nindex 8960caea..0218a3b5 100644\n--- a/plone/app/upgrade/v51/final.py\n+++ b/plone/app/upgrade/v51/final.py\n@@ -52,3 +52,11 @@ def remove_highlightsearchterms(context):\n     resources = registry.records[record]\n     if u\'jquery-highlightsearchterms\' in resources.value:\n         resources.value.remove(u\'jquery-highlightsearchterms\')\n+\n+\n+def remove_old_PAE_rescources(context):  # noqa\n+    """FORCE remove old p.a.event resources"""\n+    registry = getUtility(IRegistry)\n+    plone_legacy = registry.records[\'plone.bundles/plone-legacy.resources\']\n+    plone_legacy.value.remove(\'resource-plone-app-event-event-js\')\n+    plone_legacy.value.remove(\'resource-plone-app-event-event-css\')\ndiff --git a/plone/app/upgrade/v51/profiles.zcml b/plone/app/upgrade/v51/profiles.zcml\nindex 1e46ddc3..54756efe 100644\n--- a/plone/app/upgrade/v51/profiles.zcml\n+++ b/plone/app/upgrade/v51/profiles.zcml\n@@ -77,6 +77,15 @@\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n+  <genericsetup:registerProfile\n+      name="to513"\n+      title="Upgrade profile for Plone 5.1.2 to Plone 5.1.3"\n+      description=""\n+      directory="profiles/to_513"\n+      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+\n   <genericsetup:registerProfile\n       name="to514"\n       title="Upgrade profile for Plone 5.1.3 to Plone 5.1.4"\ndiff --git a/plone/app/upgrade/v51/profiles/to_513/registry.xml b/plone/app/upgrade/v51/profiles/to_513/registry.xml\nnew file mode 100644\nindex 00000000..195fbadc\n--- /dev/null\n+++ b/plone/app/upgrade/v51/profiles/to_513/registry.xml\n@@ -0,0 +1,26 @@\n+<?xml version="1.0"?>\n+<registry>\n+\n+  <!-- remove old resources and update legacy bundle -->\n+  <records prefix="plone.resources/resource-plone-app-event-js" remove="True"\n+            interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n+  </records>\n+  <records prefix="plone.resources/resource-plone-app-event-css" remove="True"\n+            interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n+  </records>\n+\n+  <!-- register as resource for legacy bundle -->\n+  <records prefix="plone.resources/plone-app-event"\n+            interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n+      <value key="js">++plone++plone.app.event/event.js</value>\n+  </records>\n+\n+  <records prefix="plone.bundles/plone-legacy"\n+            interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n+    <value key="resources" purge="False">\n+      <element>plone-app-event</element>\n+    </value>\n+    <value key="last_compilation"></value>\n+  </records>\n+\n+</registry>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-09-13T12:08:01+02:00
Author: Sune Broendum Woeller (sunew) <sune@woeller.dk>
Commit: https://github.com/plone/plone.app.upgrade/commit/8d0289686dbe54e08c74919240f3f84ebf18ea70

Dont fail if resource is already removed

Files changed:
M plone/app/upgrade/v51/final.py

b'diff --git a/plone/app/upgrade/v51/final.py b/plone/app/upgrade/v51/final.py\nindex 0218a3b5..1866708a 100644\n--- a/plone/app/upgrade/v51/final.py\n+++ b/plone/app/upgrade/v51/final.py\n@@ -57,6 +57,8 @@ def remove_highlightsearchterms(context):\n def remove_old_PAE_rescources(context):  # noqa\n     """FORCE remove old p.a.event resources"""\n     registry = getUtility(IRegistry)\n-    plone_legacy = registry.records[\'plone.bundles/plone-legacy.resources\']\n-    plone_legacy.value.remove(\'resource-plone-app-event-event-js\')\n-    plone_legacy.value.remove(\'resource-plone-app-event-event-css\')\n+    resources = registry.records[\'plone.bundles/plone-legacy.resources\']\n+    if u\'resource-plone-app-event-event-js\' in resources.value:\n+        resources.value.remove(\'resource-plone-app-event-event-js\')\n+    if u\'resource-plone-app-event-event-css\' in resources.value:\n+        resources.value.remove(\'resource-plone-app-event-event-css\')\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-09-13T21:38:17+02:00
Author: Sune Broendum Woeller (sunew) <sune@woeller.dk>
Commit: https://github.com/plone/plone.app.upgrade/commit/c10780ef301016bde82bfba24f74ea6503de58d1

install plone.resource on upgrade, we need the portal_resources folder

Files changed:
M plone/app/upgrade/v50/alphas.py

b"diff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py\nindex 9ebc6d72..2b1a8de4 100644\n--- a/plone/app/upgrade/v50/alphas.py\n+++ b/plone/app/upgrade/v50/alphas.py\n@@ -74,6 +74,8 @@ def to50alpha1(context):\n         qi = getToolByName(portal, 'portal_quickinstaller')\n     else:\n         qi = get_installer(portal)\n+    if not qi.isProductInstalled('plone.resource'):\n+        qi.installProduct('plone.resource')\n     if not qi.isProductInstalled('plone.app.event'):\n         qi.installProduct('plone.app.event')\n \n"

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-09-14T10:04:55+02:00
Author: Sune Broendum Woeller (sunew) <sune@woeller.dk>
Commit: https://github.com/plone/plone.app.upgrade/commit/425e049511a939db61d3262e60e5526e845c0018

Merge pull request #166 from 'p-a-event-to-513'

Files changed:
A plone/app/upgrade/v51/profiles/to_513/registry.xml
M CHANGES.rst
M plone/app/upgrade/v50/alphas.py
M plone/app/upgrade/v51/configure.zcml
M plone/app/upgrade/v51/final.py
M plone/app/upgrade/v51/profiles.zcml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 45c9b7e6..dfc7248c 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -20,6 +20,8 @@ Bug fixes:\n \n - *add item here*\n \n+- Update resources for plone.app.event.  [agitator]\n+\n \n 2.0.15 (2018-06-21)\n -------------------\ndiff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py\nindex 9ebc6d72..2b1a8de4 100644\n--- a/plone/app/upgrade/v50/alphas.py\n+++ b/plone/app/upgrade/v50/alphas.py\n@@ -74,6 +74,8 @@ def to50alpha1(context):\n         qi = getToolByName(portal, \'portal_quickinstaller\')\n     else:\n         qi = get_installer(portal)\n+    if not qi.isProductInstalled(\'plone.resource\'):\n+        qi.installProduct(\'plone.resource\')\n     if not qi.isProductInstalled(\'plone.app.event\'):\n         qi.installProduct(\'plone.app.event\')\n \ndiff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml\nindex 113678a9..ad19471b 100644\n--- a/plone/app/upgrade/v51/configure.zcml\n+++ b/plone/app/upgrade/v51/configure.zcml\n@@ -243,12 +243,18 @@ Add image scaling options to image handling control panel.\n         destination="5113"\n         profile="Products.CMFPlone:plone">\n \n+        <gs:upgradeDepends\n+            title="Run to513 upgrade profile."\n+            description="Update resources for plone.app.event"\n+            import_profile="plone.app.upgrade.v51:to513"\n+            />\n+\n         <gs:upgradeStep\n-            title="Miscellaneous"\n-            description=""\n-            handler="..utils.null_upgrade_step"\n+            title="Force remove old p.a.event resources"\n+            handler=".final.remove_old_PAE_rescources"\n             />\n \n+\n     </gs:upgradeSteps>\n \n     <gs:upgradeSteps\ndiff --git a/plone/app/upgrade/v51/final.py b/plone/app/upgrade/v51/final.py\nindex 8960caea..1866708a 100644\n--- a/plone/app/upgrade/v51/final.py\n+++ b/plone/app/upgrade/v51/final.py\n@@ -52,3 +52,13 @@ def remove_highlightsearchterms(context):\n     resources = registry.records[record]\n     if u\'jquery-highlightsearchterms\' in resources.value:\n         resources.value.remove(u\'jquery-highlightsearchterms\')\n+\n+\n+def remove_old_PAE_rescources(context):  # noqa\n+    """FORCE remove old p.a.event resources"""\n+    registry = getUtility(IRegistry)\n+    resources = registry.records[\'plone.bundles/plone-legacy.resources\']\n+    if u\'resource-plone-app-event-event-js\' in resources.value:\n+        resources.value.remove(\'resource-plone-app-event-event-js\')\n+    if u\'resource-plone-app-event-event-css\' in resources.value:\n+        resources.value.remove(\'resource-plone-app-event-event-css\')\ndiff --git a/plone/app/upgrade/v51/profiles.zcml b/plone/app/upgrade/v51/profiles.zcml\nindex 1e46ddc3..54756efe 100644\n--- a/plone/app/upgrade/v51/profiles.zcml\n+++ b/plone/app/upgrade/v51/profiles.zcml\n@@ -77,6 +77,15 @@\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n+  <genericsetup:registerProfile\n+      name="to513"\n+      title="Upgrade profile for Plone 5.1.2 to Plone 5.1.3"\n+      description=""\n+      directory="profiles/to_513"\n+      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+\n   <genericsetup:registerProfile\n       name="to514"\n       title="Upgrade profile for Plone 5.1.3 to Plone 5.1.4"\ndiff --git a/plone/app/upgrade/v51/profiles/to_513/registry.xml b/plone/app/upgrade/v51/profiles/to_513/registry.xml\nnew file mode 100644\nindex 00000000..195fbadc\n--- /dev/null\n+++ b/plone/app/upgrade/v51/profiles/to_513/registry.xml\n@@ -0,0 +1,26 @@\n+<?xml version="1.0"?>\n+<registry>\n+\n+  <!-- remove old resources and update legacy bundle -->\n+  <records prefix="plone.resources/resource-plone-app-event-js" remove="True"\n+            interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n+  </records>\n+  <records prefix="plone.resources/resource-plone-app-event-css" remove="True"\n+            interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n+  </records>\n+\n+  <!-- register as resource for legacy bundle -->\n+  <records prefix="plone.resources/plone-app-event"\n+            interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'>\n+      <value key="js">++plone++plone.app.event/event.js</value>\n+  </records>\n+\n+  <records prefix="plone.bundles/plone-legacy"\n+            interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n+    <value key="resources" purge="False">\n+      <element>plone-app-event</element>\n+    </value>\n+    <value key="last_compilation"></value>\n+  </records>\n+\n+</registry>\n'

