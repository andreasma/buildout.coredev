Repository: plone.testing


Branch: refs/heads/4.1.x
Date: 2018-10-04T12:31:03+02:00
Author: Joni Orponen (Rotonen) <joni.orponen@gmail.com>
Commit: https://github.com/plone/plone.testing/commit/561f637ab793562c52a88357817567f2ac0c1477

Enable picking a free port for ZServer layers automatically.

Files changed:
M CHANGES.rst
M src/plone/testing/z2.py
M src/plone/testing/z2.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 14e20eb..a251111 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -6,7 +6,9 @@ Changelog\n \n Breaking changes:\n \n-- *add item here*\n+- Default to picking a dynamical port for ZServer layers instead of a static\n+  default port.\n+  [Rotonen]\n \n New features:\n \ndiff --git a/src/plone/testing/z2.py b/src/plone/testing/z2.py\nindex d661ad7..128b6cc 100644\n--- a/src/plone/testing/z2.py\n+++ b/src/plone/testing/z2.py\n@@ -969,8 +969,10 @@ class ZServer(Layer):\n \n     defaultBases = (STARTUP,)\n \n-    host = os.environ.get(\'ZSERVER_HOST\', \'localhost\')\n-    port = int(os.environ.get(\'ZSERVER_PORT\', 55001))\n+    # Default to \'bindall\' (marked by an empty string) from os.socket\n+    host = os.environ.get(\'ZSERVER_HOST\', \'\')\n+    # Default to letting the OS allocate us a free port (marked by 0)\n+    port = int(os.environ.get(\'ZSERVER_PORT\', 0))\n     timeout = 5.0\n     log = None\n \n@@ -1033,6 +1035,17 @@ def setUpServer(self):\n \n         self.zserver = server\n \n+        # If we dynamically set the host/port, we want to reset it to localhost\n+        # Otherwise this will depend on, for example, the local network setup\n+        if self.host in (\'\', \'0.0.0.0\', \'127.0.0.1\', ):\n+            self.zserver.server_name = \'localhost\'\n+\n+        # Refresh the hostname and port in case we dynamically picked them\n+        self.host = self.zserver.server_name\n+        self[\'host\'] = self.host\n+        self.port = self.zserver.server_port\n+        self[\'port\'] = self.port\n+\n     def tearDownServer(self):\n         """Close the ZServer socket\n         """\n@@ -1080,8 +1093,10 @@ class FTPServer(ZServer):\n \n     defaultBases = (STARTUP,)\n \n-    host = os.environ.get(\'FTPSERVER_HOST\', \'localhost\')\n-    port = int(os.environ.get(\'FTPSERVER_PORT\', 55002))\n+    # Default to \'bindall\' (marked by an empty string) from os.socket\n+    host = os.environ.get(\'FTPSERVER_HOST\', \'\')\n+    # Default to letting the OS allocate us a free port (marked by 0)\n+    port = int(os.environ.get(\'FTPSERVER_PORT\', 0))\n     threads = 1\n     timeout = 5.0\n     log = None\n@@ -1106,6 +1121,20 @@ def setUpServer(self):\n             port=self.port,\n             logger_object=zopeLog)\n \n+\n+        # Refresh the hostname and port in case we dynamically picked them\n+        self.host, self.port = self.ftpServer.socket.getsockname()\n+\n+        # If we dynamically set the host/port, we want to reset it to localhost\n+        # Otherwise this will depend on, for example, the local network setup\n+        if self.host in (\'\', \'0.0.0.0\', \'127.0.0.1\', ):\n+            self.host = \'localhost\'\n+            self.ftpServer.hostname = \'localhost\'\n+            self.ftpServer.ip = \'127.0.0.1\'\n+\n+        self[\'host\'] = self.host\n+        self[\'port\'] = self.port\n+\n     def tearDownServer(self):\n         """Close the FTPServer socket\n         """\ndiff --git a/src/plone/testing/z2.rst b/src/plone/testing/z2.rst\nindex 6479e6a..f0fb4ac 100644\n--- a/src/plone/testing/z2.rst\n+++ b/src/plone/testing/z2.rst\n@@ -465,13 +465,7 @@ The ``ZSERVER`` layer provides a ``FunctionalTesting`` layer that has ``ZSERVER_\n After layer setup, the resources ``host`` and ``port`` are available, and indicate where Zope is running.::\n \n     >>> host = z2.ZSERVER[\'host\']\n-    >>> host\n-    \'localhost\'\n-\n     >>> port = z2.ZSERVER[\'port\']\n-    >>> import os\n-    >>> port == int(os.environ.get(\'ZSERVER_PORT\', 55001))\n-    True\n \n Let\'s now simulate a test.\n Test setup does nothing beyond what the base layers do.::\n@@ -569,13 +563,7 @@ The ``FTP_SERVER`` layer is based on ``FTP_SERVER_FIXTURE``, using the ``Functio\n After layer setup, the resources ``host`` and ``port`` are available, and indicate where Zope is running.::\n \n     >>> host = z2.FTP_SERVER[\'host\']\n-    >>> host\n-    \'localhost\'\n-\n     >>> port = z2.FTP_SERVER[\'port\']\n-    >>> import os\n-    >>> port == int(os.environ.get(\'FTPSERVER_PORT\', 55002))\n-    True\n \n Let\'s now simulate a test.\n Test setup does nothing beyond what the base layers do.::\n'

Repository: plone.testing


Branch: refs/heads/4.1.x
Date: 2018-10-04T22:53:50+02:00
Author: Gil Forcada Codinachs (gforcada) <gil.gnome@gmail.com>
Commit: https://github.com/plone/plone.testing/commit/0900de68325c59e2b909445dacd695ae83e89299

Merge pull request #56 from plone/free-ports-4.1

Enable picking a free port for ZServer layers automatically.

Files changed:
M CHANGES.rst
M src/plone/testing/z2.py
M src/plone/testing/z2.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 14e20eb..a251111 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -6,7 +6,9 @@ Changelog\n \n Breaking changes:\n \n-- *add item here*\n+- Default to picking a dynamical port for ZServer layers instead of a static\n+  default port.\n+  [Rotonen]\n \n New features:\n \ndiff --git a/src/plone/testing/z2.py b/src/plone/testing/z2.py\nindex d661ad7..128b6cc 100644\n--- a/src/plone/testing/z2.py\n+++ b/src/plone/testing/z2.py\n@@ -969,8 +969,10 @@ class ZServer(Layer):\n \n     defaultBases = (STARTUP,)\n \n-    host = os.environ.get(\'ZSERVER_HOST\', \'localhost\')\n-    port = int(os.environ.get(\'ZSERVER_PORT\', 55001))\n+    # Default to \'bindall\' (marked by an empty string) from os.socket\n+    host = os.environ.get(\'ZSERVER_HOST\', \'\')\n+    # Default to letting the OS allocate us a free port (marked by 0)\n+    port = int(os.environ.get(\'ZSERVER_PORT\', 0))\n     timeout = 5.0\n     log = None\n \n@@ -1033,6 +1035,17 @@ def setUpServer(self):\n \n         self.zserver = server\n \n+        # If we dynamically set the host/port, we want to reset it to localhost\n+        # Otherwise this will depend on, for example, the local network setup\n+        if self.host in (\'\', \'0.0.0.0\', \'127.0.0.1\', ):\n+            self.zserver.server_name = \'localhost\'\n+\n+        # Refresh the hostname and port in case we dynamically picked them\n+        self.host = self.zserver.server_name\n+        self[\'host\'] = self.host\n+        self.port = self.zserver.server_port\n+        self[\'port\'] = self.port\n+\n     def tearDownServer(self):\n         """Close the ZServer socket\n         """\n@@ -1080,8 +1093,10 @@ class FTPServer(ZServer):\n \n     defaultBases = (STARTUP,)\n \n-    host = os.environ.get(\'FTPSERVER_HOST\', \'localhost\')\n-    port = int(os.environ.get(\'FTPSERVER_PORT\', 55002))\n+    # Default to \'bindall\' (marked by an empty string) from os.socket\n+    host = os.environ.get(\'FTPSERVER_HOST\', \'\')\n+    # Default to letting the OS allocate us a free port (marked by 0)\n+    port = int(os.environ.get(\'FTPSERVER_PORT\', 0))\n     threads = 1\n     timeout = 5.0\n     log = None\n@@ -1106,6 +1121,20 @@ def setUpServer(self):\n             port=self.port,\n             logger_object=zopeLog)\n \n+\n+        # Refresh the hostname and port in case we dynamically picked them\n+        self.host, self.port = self.ftpServer.socket.getsockname()\n+\n+        # If we dynamically set the host/port, we want to reset it to localhost\n+        # Otherwise this will depend on, for example, the local network setup\n+        if self.host in (\'\', \'0.0.0.0\', \'127.0.0.1\', ):\n+            self.host = \'localhost\'\n+            self.ftpServer.hostname = \'localhost\'\n+            self.ftpServer.ip = \'127.0.0.1\'\n+\n+        self[\'host\'] = self.host\n+        self[\'port\'] = self.port\n+\n     def tearDownServer(self):\n         """Close the FTPServer socket\n         """\ndiff --git a/src/plone/testing/z2.rst b/src/plone/testing/z2.rst\nindex 6479e6a..f0fb4ac 100644\n--- a/src/plone/testing/z2.rst\n+++ b/src/plone/testing/z2.rst\n@@ -465,13 +465,7 @@ The ``ZSERVER`` layer provides a ``FunctionalTesting`` layer that has ``ZSERVER_\n After layer setup, the resources ``host`` and ``port`` are available, and indicate where Zope is running.::\n \n     >>> host = z2.ZSERVER[\'host\']\n-    >>> host\n-    \'localhost\'\n-\n     >>> port = z2.ZSERVER[\'port\']\n-    >>> import os\n-    >>> port == int(os.environ.get(\'ZSERVER_PORT\', 55001))\n-    True\n \n Let\'s now simulate a test.\n Test setup does nothing beyond what the base layers do.::\n@@ -569,13 +563,7 @@ The ``FTP_SERVER`` layer is based on ``FTP_SERVER_FIXTURE``, using the ``Functio\n After layer setup, the resources ``host`` and ``port`` are available, and indicate where Zope is running.::\n \n     >>> host = z2.FTP_SERVER[\'host\']\n-    >>> host\n-    \'localhost\'\n-\n     >>> port = z2.FTP_SERVER[\'port\']\n-    >>> import os\n-    >>> port == int(os.environ.get(\'FTPSERVER_PORT\', 55002))\n-    True\n \n Let\'s now simulate a test.\n Test setup does nothing beyond what the base layers do.::\n'

