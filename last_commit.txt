Repository: plone.theme


Branch: refs/heads/master
Date: 2018-03-02T10:25:13+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.theme/commit/066aa963852da9adadebb27307c85daf8adc45f3

Handle case where we get no skinname in Zope4

Files changed:
M CHANGES.rst
M plone/theme/layer.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6229636..d908228 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Handle case where we get no skinname in Zope4.
+  [pbauer]
 
 
 3.0.3 (2017-07-03)
diff --git a/plone/theme/layer.py b/plone/theme/layer.py
index 2451c5c..ac202d7 100644
--- a/plone/theme/layer.py
+++ b/plone/theme/layer.py
@@ -1,12 +1,11 @@
-from zope.interface import directlyProvides, directlyProvidedBy
+# -*- coding: utf-8 -*-
+from plone.theme.interfaces import IDefaultPloneLayer
+from Products.CMFCore.utils import getToolByName
 from zope.component import queryUtility
-
+from zope.interface import directlyProvides, directlyProvidedBy
 from zope.publisher.interfaces.browser import IBrowserSkinType
 from zope.publisher.interfaces.browser import IDefaultBrowserLayer
 
-from Products.CMFCore.utils import getToolByName
-from plone.theme.interfaces import IDefaultPloneLayer
-
 default_layers = [
     IDefaultPloneLayer,
     IDefaultBrowserLayer,
@@ -17,13 +16,15 @@ def mark_layer(site, event):
     """Mark the request with a layer corresponding to the current skin,
     as set in the portal_skins tool.
     """
-    if getattr(event.request, "_plonetheme_", False):
+    if getattr(event.request, '_plonetheme_', False):
         return
-    event.request._plonetheme_=True
+    event.request._plonetheme_ = True
 
     portal_skins = getToolByName(site, 'portal_skins', None)
     if portal_skins is not None:
         skin_name = site.getCurrentSkinName()
+        if skin_name is not None:
+            return
         skin = queryUtility(IBrowserSkinType, name=skin_name)
         if skin is not None:
             layer_ifaces = []


Repository: plone.theme


Branch: refs/heads/master
Date: 2018-03-02T10:25:13+01:00
Author: Philip Bauer (pbauer) <bauer@starzel.de>
Commit: https://github.com/plone/plone.theme/commit/4ee3b96dfc008cb3f5844574dabf9d0399c87bae

fix wrong condition for missing skinname

Files changed:
M plone/theme/layer.py

diff --git a/plone/theme/layer.py b/plone/theme/layer.py
index ac202d7..70c2195 100644
--- a/plone/theme/layer.py
+++ b/plone/theme/layer.py
@@ -23,7 +23,7 @@ def mark_layer(site, event):
     portal_skins = getToolByName(site, 'portal_skins', None)
     if portal_skins is not None:
         skin_name = site.getCurrentSkinName()
-        if skin_name is not None:
+        if skin_name is None:
             return
         skin = queryUtility(IBrowserSkinType, name=skin_name)
         if skin is not None:


Repository: plone.theme


Branch: refs/heads/master
Date: 2018-03-18T20:25:54+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.theme/commit/16c1a4d6324cf2cdf44a50fc01d5fffb9fd9a0ce

Merge pull request #7 from plone/plonezope4

Handle case where ther is no skinname when migrating to Plone 5.2

Files changed:
M CHANGES.rst
M plone/theme/layer.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 98e0259..fc37d03 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -14,7 +14,8 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Handle case where we get no skinname in Zope4.
+  [pbauer]
 
 
 3.0.4 (2018-03-10)
diff --git a/plone/theme/layer.py b/plone/theme/layer.py
index 2451c5c..70c2195 100644
--- a/plone/theme/layer.py
+++ b/plone/theme/layer.py
@@ -1,12 +1,11 @@
-from zope.interface import directlyProvides, directlyProvidedBy
+# -*- coding: utf-8 -*-
+from plone.theme.interfaces import IDefaultPloneLayer
+from Products.CMFCore.utils import getToolByName
 from zope.component import queryUtility
-
+from zope.interface import directlyProvides, directlyProvidedBy
 from zope.publisher.interfaces.browser import IBrowserSkinType
 from zope.publisher.interfaces.browser import IDefaultBrowserLayer
 
-from Products.CMFCore.utils import getToolByName
-from plone.theme.interfaces import IDefaultPloneLayer
-
 default_layers = [
     IDefaultPloneLayer,
     IDefaultBrowserLayer,
@@ -17,13 +16,15 @@ def mark_layer(site, event):
     """Mark the request with a layer corresponding to the current skin,
     as set in the portal_skins tool.
     """
-    if getattr(event.request, "_plonetheme_", False):
+    if getattr(event.request, '_plonetheme_', False):
         return
-    event.request._plonetheme_=True
+    event.request._plonetheme_ = True
 
     portal_skins = getToolByName(site, 'portal_skins', None)
     if portal_skins is not None:
         skin_name = site.getCurrentSkinName()
+        if skin_name is None:
+            return
         skin = queryUtility(IBrowserSkinType, name=skin_name)
         if skin is not None:
             layer_ifaces = []


