Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2019-08-09T18:16:32+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/506d5df70b99e20edeef7f64b6b65fed9e186873

Refs #204 - Optimize @@historyview workflowHistory user info

Files changed:
M plone/app/layout/viewlets/content.py

b'diff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 78929976..5ed51ad1 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -190,6 +190,20 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     index = ViewPageTemplateFile("review_history.pt")\n \n+    @memoize\n+    def getUserInfo(self, userid):\n+        mt = getToolByName(self.context, \'portal_membership\')\n+        info = mt.getMemberInfo(userid)\n+        if info is None:\n+            return dict(actor_home="",\n+                        actor=dict(fullname=userid))\n+\n+        if not info.get("fullname", None):\n+            info["fullname"] = userid\n+\n+        return dict(actor=info,\n+                    actor_home="%s/author/%s" % (self.site_url, userid))\n+\n     def workflowHistory(self, complete=True):\n         """Return workflow history of this context.\n \n@@ -202,8 +216,6 @@ def workflowHistory(self, complete=True):\n             return []\n \n         workflow = getToolByName(context, \'portal_workflow\')\n-        membership = getToolByName(context, \'portal_membership\')\n-\n         review_history = []\n \n         try:\n@@ -232,13 +244,7 @@ def workflowHistory(self, complete=True):\n                     r[\'actor\'] = {\'username\': anon, \'fullname\': anon}\n                     r[\'actor_home\'] = \'\'\n                 else:\n-                    r[\'actor\'] = membership.getMemberInfo(actorid)\n-                    if r[\'actor\'] is not None:\n-                        r[\'actor_home\'] = self.navigation_root_url + \'/author/\' + actorid\n-                    else:\n-                        # member info is not available\n-                        # the user was probably deleted\n-                        r[\'actor_home\'] = \'\'\n+                    r.update(self.getUserInfo(actorid))\n             review_history.reverse()\n \n         except WorkflowException:\n@@ -253,20 +259,6 @@ class ContentHistoryViewlet(WorkflowHistoryViewlet):\n \n     index = ViewPageTemplateFile("content_history.pt")\n \n-    @memoize\n-    def getUserInfo(self, userid):\n-        mt = getToolByName(self.context, \'portal_membership\')\n-        info=mt.getMemberInfo(userid)\n-        if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n-\n-        if not info.get("fullname", None):\n-            info["fullname"]=userid\n-\n-        return dict(actor=info,\n-                    actor_home="%s/author/%s" % (self.site_url, userid))\n-\n     def revisionHistory(self):\n         context = aq_inner(self.context)\n         if not _checkPermission(AccessPreviousVersions, context):\n'

Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2019-08-09T18:21:50+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/201ca22d46368f1fdd87a0fe4f79e93c31469a6c

Fixes #204 - Fix memory leak on getUserInfo

Files changed:
M plone/app/layout/viewlets/content.py

b'diff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 5ed51ad1..9e752c52 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -192,16 +192,17 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     @memoize\n     def getUserInfo(self, userid):\n+        actor = dict(fullname=userid)\n         mt = getToolByName(self.context, \'portal_membership\')\n         info = mt.getMemberInfo(userid)\n         if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n+            return dict(actor_home="", actor=actor)\n \n-        if not info.get("fullname", None):\n-            info["fullname"] = userid\n+        fullname = info.get("fullname", None)\n+        if fullname:\n+            actor[\'fullname\'] = fullname\n \n-        return dict(actor=info,\n+        return dict(actor=actor,\n                     actor_home="%s/author/%s" % (self.site_url, userid))\n \n     def workflowHistory(self, complete=True):\n'

Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2019-08-09T18:33:57+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/d0ffc272e93562f8a6c2ba7114911da141264cab

Refs #204 - Update Changelog

Files changed:
M CHANGES.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex d8cc0f9d..1ba3e858 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,7 +14,7 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Memory leak on getUserInfo [avoinea] (#204)\n \n \n 2.3.19 (2018-10-31)\n'

Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2019-08-14T10:53:09+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/13d8a55fa9c00574955d1ca142fd71c68ed443d3

Merge pull request #206 from avoinea/2.3.x

2.3.x -  Fixes #204 - Fix memory leak on getUserInfo

Files changed:
M CHANGES.rst
M plone/app/layout/viewlets/content.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex d8cc0f9d..1ba3e858 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,7 +14,7 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Memory leak on getUserInfo [avoinea] (#204)\n \n \n 2.3.19 (2018-10-31)\ndiff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 78929976..9e752c52 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -190,6 +190,21 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     index = ViewPageTemplateFile("review_history.pt")\n \n+    @memoize\n+    def getUserInfo(self, userid):\n+        actor = dict(fullname=userid)\n+        mt = getToolByName(self.context, \'portal_membership\')\n+        info = mt.getMemberInfo(userid)\n+        if info is None:\n+            return dict(actor_home="", actor=actor)\n+\n+        fullname = info.get("fullname", None)\n+        if fullname:\n+            actor[\'fullname\'] = fullname\n+\n+        return dict(actor=actor,\n+                    actor_home="%s/author/%s" % (self.site_url, userid))\n+\n     def workflowHistory(self, complete=True):\n         """Return workflow history of this context.\n \n@@ -202,8 +217,6 @@ def workflowHistory(self, complete=True):\n             return []\n \n         workflow = getToolByName(context, \'portal_workflow\')\n-        membership = getToolByName(context, \'portal_membership\')\n-\n         review_history = []\n \n         try:\n@@ -232,13 +245,7 @@ def workflowHistory(self, complete=True):\n                     r[\'actor\'] = {\'username\': anon, \'fullname\': anon}\n                     r[\'actor_home\'] = \'\'\n                 else:\n-                    r[\'actor\'] = membership.getMemberInfo(actorid)\n-                    if r[\'actor\'] is not None:\n-                        r[\'actor_home\'] = self.navigation_root_url + \'/author/\' + actorid\n-                    else:\n-                        # member info is not available\n-                        # the user was probably deleted\n-                        r[\'actor_home\'] = \'\'\n+                    r.update(self.getUserInfo(actorid))\n             review_history.reverse()\n \n         except WorkflowException:\n@@ -253,20 +260,6 @@ class ContentHistoryViewlet(WorkflowHistoryViewlet):\n \n     index = ViewPageTemplateFile("content_history.pt")\n \n-    @memoize\n-    def getUserInfo(self, userid):\n-        mt = getToolByName(self.context, \'portal_membership\')\n-        info=mt.getMemberInfo(userid)\n-        if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n-\n-        if not info.get("fullname", None):\n-            info["fullname"]=userid\n-\n-        return dict(actor=info,\n-                    actor_home="%s/author/%s" % (self.site_url, userid))\n-\n     def revisionHistory(self):\n         context = aq_inner(self.context)\n         if not _checkPermission(AccessPreviousVersions, context):\n'

