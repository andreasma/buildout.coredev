Repository: plone.app.layout


Branch: refs/heads/master
Date: 2018-06-17T08:25:06+02:00
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/2237048b8f12a116a5cfb67490a1e0a0b728b5e8

Helper  returns site, if context is not in aquisition chain (https://github.com/plone/Products.CMFPlone/issues/2446) (#153)

Files changed:
M CHANGES.rst
M plone/app/layout/navigation/root.py

diff --git a/CHANGES.rst b/CHANGES.rst
index f123188..8c91b26 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -15,7 +15,9 @@ New features:
 
 Bug fixes:
 
-- *add item here*
+- Helper `getNavigationRoot` returns site, if context is not in
+  acquisition chain (eg AJAX calls)
+  [tomgross]
 
 
 2.8.0 (2018-04-24)
diff --git a/plone/app/layout/navigation/root.py b/plone/app/layout/navigation/root.py
index df1ab9d..fcc3d10 100644
--- a/plone/app/layout/navigation/root.py
+++ b/plone/app/layout/navigation/root.py
@@ -6,6 +6,7 @@
 from plone.registry.interfaces import IRegistry
 from Products.CMFCore.utils import getToolByName
 from zope.component import getUtility
+from zope.component.hooks import getSite
 
 
 def getNavigationRoot(context, relativeRoot=None):
@@ -25,7 +26,11 @@ def getNavigationRoot(context, relativeRoot=None):
     through parents, looking for an object implementing INavigationRoot.
     Return the path of that root.
     """
-    portal_url = getToolByName(context, 'portal_url')
+    try:
+        portal_url = getToolByName(context, 'portal_url')
+    except AttributeError:
+        site = getSite()
+        return '/'.join(site.getPhysicalPath())
 
     if relativeRoot is None:
         # fetch from portal_properties


