Repository: plone.app.referenceablebehavior


Branch: refs/heads/master
Date: 2019-04-08T13:15:01-07:00
Author: Ross Patterson (rpatterson) <me@rpatterson.net>
Commit: https://github.com/plone/plone.app.referenceablebehavior/commit/a45f487e0f94effb3992c18c9f416d5cb2cf7234

Fix references missing from the reference catalog on move/rename

Files changed:
M CHANGES.rst
M plone/app/referenceablebehavior/tests/test_basics.py
M plone/app/referenceablebehavior/uidcatalog.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex ffa01c0..4856fce 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,7 +14,9 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Fix references missing from the reference catalog when an object is\n+  moved/renamed.\n+  [rpatterson]\n \n \n 0.7.7 (2017-02-05)\ndiff --git a/plone/app/referenceablebehavior/tests/test_basics.py b/plone/app/referenceablebehavior/tests/test_basics.py\nindex ccf1263..9cf83ba 100644\n--- a/plone/app/referenceablebehavior/tests/test_basics.py\n+++ b/plone/app/referenceablebehavior/tests/test_basics.py\n@@ -25,35 +25,44 @@ def test_rename_does_not_change_uuid(self):\n         self.portal.manage_renameObject(id=\'doc1\', new_id=\'new_name\')\n         self.assertEquals(old_doc_uuid, IUUID(self.portal[\'new_name\']))\n \n-    @unittest.skip(\'Needs Refactor. Linkintegrity does not use ref_catalog\')\n     def test_rename_updates_ref_catalog(self):\n         doc1 = self.portal[\'doc1\']\n         doc2 = self.portal[\'doc2\']\n+\n+        doc1_refs = IReferenceable(doc1)\n+        doc2_refs = IReferenceable(doc2)\n+        doc1_refs.addReference(doc2_refs, relationship=\'fooRelationship\')\n+\n         ref_catalog = self.portal.reference_catalog\n-        doc1.text = RichTextValue(\'<a href="doc2">doc2</a>\')\n-        modified(doc1)\n         self.assertEquals(1, len(ref_catalog()))\n-\n-        self.assertEquals([doc2], IReferenceable(doc1).getReferences())\n+        self.assertEquals([doc2], doc1_refs.getReferences())\n         ref_brain = ref_catalog()[0]\n         self.assertTrue(ref_brain.getPath().startswith(\'doc1\'))\n+\n         self.portal.manage_renameObject(id=\'doc1\', new_id=\'new_name\')\n-        modified(doc1)\n+        doc1 = self.portal[\'new_name\']\n+        doc1_refs = IReferenceable(doc1)\n+\n         self.assertEquals(1, len(ref_catalog()))\n         ref_brain = ref_catalog()[0]\n         self.assertTrue(ref_brain.getPath().startswith(\'new_name\'))\n-        self.assertEquals([doc2], IReferenceable(doc1).getReferences())\n+        self.assertEquals([doc2], doc1_refs.getReferences())\n \n-    @unittest.skip(\'Needs Refactor. Linkintegrity does not use ref_catalog\')\n     def test_remove_cleans_ref_catalog(self):\n         doc1 = self.portal[\'doc1\']\n-        doc1.text = RichTextValue(\'<a href="doc1">doc1</a>\')\n-        modified(doc1)\n+        doc2 = self.portal[\'doc2\']\n+\n+        doc1_refs = IReferenceable(doc1)\n+        doc2_refs = IReferenceable(doc2)\n+        doc1_refs.addReference(doc2_refs, relationship=\'fooRelationship\')\n+\n         ref_catalog = self.portal.reference_catalog\n         self.assertEquals(1, len(ref_catalog()))\n+        self.assertEquals([doc1], doc2_refs.getBackReferences())\n \n         self.portal.manage_delObjects([\'doc1\'])\n         self.assertEquals(0, len(ref_catalog()))\n+        self.assertEquals([], doc2_refs.getBackReferences())\n \n     def test_referenceable_api(self):\n         doc1 = self.portal[\'doc1\']\ndiff --git a/plone/app/referenceablebehavior/uidcatalog.py b/plone/app/referenceablebehavior/uidcatalog.py\nindex 2580fac..2daabe9 100644\n--- a/plone/app/referenceablebehavior/uidcatalog.py\n+++ b/plone/app/referenceablebehavior/uidcatalog.py\n@@ -77,15 +77,17 @@ def moved_handler(obj, event):\n         return\n \n     for ref in annotations.objectValues():\n-        url = getRelURL(ref_catalog, ref.getPhysicalPath())\n+        new_url = getRelURL(ref_catalog, ref.getPhysicalPath())\n         if event.oldName and event.newName:\n-            url = event.oldName + url[len(event.newName):]\n-        uid_catalog_rid = uid_catalog.getrid(url)\n-        ref_catalog_rid = ref_catalog.getrid(url)\n+            old_url = event.oldName + new_url[len(event.newName):]\n+        uid_catalog_rid = uid_catalog.getrid(old_url)\n+        ref_catalog_rid = ref_catalog.getrid(old_url)\n         if uid_catalog_rid is not None:\n-            uid_catalog.uncatalog_object(url)\n+            uid_catalog.uncatalog_object(old_url)\n+            uid_catalog.catalog_object(ref, new_url)\n         if ref_catalog_rid is not None:\n-            ref_catalog.uncatalog_object(url)\n+            ref_catalog.uncatalog_object(old_url)\n+            ref_catalog.catalog_object(ref, new_url)\n \n \n def removed_handler(obj, event):\n'

