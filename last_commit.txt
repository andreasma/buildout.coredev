Repository: plone.app.layout


Branch: refs/heads/master
Date: 2020-02-06T11:07:48+01:00
Author: ale-rt (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/a459c8011d3c178ccd1bd9968f7534455febbc81

Analytics viewlet: make webstats_js a property

Analytics viewlet: make webstats_js a property, so that it does not rely on an a call to the update method to be correctly evaluated

Fixes #227

Files changed:
A news/227.breaking
M news/227.bugfix
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.pt
M plone/app/layout/analytics/view.py

b'diff --git a/news/227.breaking b/news/227.breaking\nnew file mode 100644\nindex 00000000..5d662b7a\n--- /dev/null\n+++ b/news/227.breaking\n@@ -0,0 +1 @@\n+Analytics viewlet: make webstats_js a property, so that it does not rely on an a call to the update method to be correctly evaluated [ale-rt]\ndiff --git a/news/227.bugfix b/news/227.bugfix\nindex 2d5c4765..14889926 100644\n--- a/news/227.bugfix\n+++ b/news/227.bugfix\n@@ -1 +1 @@\n-Restore compatibility with old code that was inheriting from this class and overriding the __init__ method\n+Analytics viewlet: restore compatibility with old code that was inheriting from this class and overriding the __init__ method [ale-rt]\ndiff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 01deb6cc..9a914756 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -12,8 +12,21 @@ We need a view on the content.\n Now we can instantiate the manager.\n \n     >>> manager = Footer(portal, request, view)\n+    >>> manager.update()\n+    >>> for viewlet in manager.viewlets:\n+    ...     if viewlet.__name__ == "plone.analytics":\n+    ...         analytics = viewlet\n+    ...         break\n+\n+When no analytics (webstats_js) code is set up the viewlet will not be rendered:\n+\n+    >>> analytics.webstats_js == u""\n+    True\n+    >>> text = manager.render()\n+    >>> \'id="plone-analytics"\' in text\n+    False\n \n-Set analytics (webstats_js) code through the controlpanel\n+Set the analytics code through the controlpanel and verify it renders properly:\n \n     >>> from plone.registry.interfaces import IRegistry\n     >>> from zope.component import getUtility\n@@ -21,20 +34,17 @@ Set analytics (webstats_js) code through the controlpanel\n     >>> registry = getUtility(IRegistry)\n     >>> site_settings = registry.forInterface(ISiteSchema, prefix="plone")\n     >>> site_settings.webstats_js = u"<script>window.title=\'Hello\'</script>"\n-    >>> manager.update()\n+    >>> analytics.webstats_js == site_settings.webstats_js\n+    True\n     >>> text = manager.render()\n+    >>> \'id="plone-analytics"\' in text\n+    True\n     >>> site_settings.webstats_js in text\n     True\n \n Now enter some non-ascii text\n \n     >>> site_settings.webstats_js = u"<script>window.title=\'C\\xedsa\\u0159\'</script>"\n-    >>> manager.update()\n     >>> text = manager.render()\n     >>> site_settings.webstats_js in text\n     True\n-\n-Check if the div sorrounding the script is present\n-\n-    >>> \'id="plone-analytics"\' in text\n-    True\ndiff --git a/plone/app/layout/analytics/view.pt b/plone/app/layout/analytics/view.pt\nindex ebd13fd5..7d3f83c7 100644\n--- a/plone/app/layout/analytics/view.pt\n+++ b/plone/app/layout/analytics/view.pt\n@@ -1,8 +1,7 @@\n-<div\n-  id="plone-analytics"\n-  tal:condition="view/webstats_js"\n-  tal:content="structure view/webstats_js"\n+<div id="plone-analytics"\n+     tal:define="webstats_js view/webstats_js"\n+     tal:condition="webstats_js"\n+     tal:content="structure webstats_js"\n >\n   Here goes the webstats_js\n </div>\n-\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex d612f8db..b45559c1 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -16,18 +16,20 @@ class AnalyticsViewlet(BrowserView):\n     def __init__(self, context, request, view, manager):\n         super(AnalyticsViewlet, self).__init__(context, request)\n         self.__parent__ = view\n-        self.context = context\n-        self.request = request\n         self.view = view\n         self.manager = manager\n \n-    def update(self):\n-        """render the webstats snippet"""\n+    @property\n+    def webstats_js(self):\n         registry = getUtility(IRegistry)\n         site_settings = registry.forInterface(\n             ISiteSchema, prefix="plone", check=False)\n         try:\n-            if site_settings.webstats_js:\n-                self.webstats_js = site_settings.webstats_js\n+            return site_settings.webstats_js or u""\n         except AttributeError:\n-            self.webstats_js = u""\n+            return u""\n+\n+    def update(self):\n+        """ The viewlet manager _updateViewlets requires this method\n+        """\n+        pass\n'

Repository: plone.app.layout


Branch: refs/heads/master
Date: 2020-02-06T14:19:07+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.layout/commit/d4934fc75b473f67507e1b3c6e7452f5bbee5d81

Merge pull request #229 from plone/227-analytics-viewlet

Analytics viewlet: make webstats_js a property

Files changed:
A news/227.breaking
M news/227.bugfix
M plone/app/layout/analytics/tests/analytics.txt
M plone/app/layout/analytics/view.pt
M plone/app/layout/analytics/view.py

b'diff --git a/news/227.breaking b/news/227.breaking\nnew file mode 100644\nindex 00000000..5d662b7a\n--- /dev/null\n+++ b/news/227.breaking\n@@ -0,0 +1 @@\n+Analytics viewlet: make webstats_js a property, so that it does not rely on an a call to the update method to be correctly evaluated [ale-rt]\ndiff --git a/news/227.bugfix b/news/227.bugfix\nindex 2d5c4765..14889926 100644\n--- a/news/227.bugfix\n+++ b/news/227.bugfix\n@@ -1 +1 @@\n-Restore compatibility with old code that was inheriting from this class and overriding the __init__ method\n+Analytics viewlet: restore compatibility with old code that was inheriting from this class and overriding the __init__ method [ale-rt]\ndiff --git a/plone/app/layout/analytics/tests/analytics.txt b/plone/app/layout/analytics/tests/analytics.txt\nindex 01deb6cc..9a914756 100644\n--- a/plone/app/layout/analytics/tests/analytics.txt\n+++ b/plone/app/layout/analytics/tests/analytics.txt\n@@ -12,8 +12,21 @@ We need a view on the content.\n Now we can instantiate the manager.\n \n     >>> manager = Footer(portal, request, view)\n+    >>> manager.update()\n+    >>> for viewlet in manager.viewlets:\n+    ...     if viewlet.__name__ == "plone.analytics":\n+    ...         analytics = viewlet\n+    ...         break\n+\n+When no analytics (webstats_js) code is set up the viewlet will not be rendered:\n+\n+    >>> analytics.webstats_js == u""\n+    True\n+    >>> text = manager.render()\n+    >>> \'id="plone-analytics"\' in text\n+    False\n \n-Set analytics (webstats_js) code through the controlpanel\n+Set the analytics code through the controlpanel and verify it renders properly:\n \n     >>> from plone.registry.interfaces import IRegistry\n     >>> from zope.component import getUtility\n@@ -21,20 +34,17 @@ Set analytics (webstats_js) code through the controlpanel\n     >>> registry = getUtility(IRegistry)\n     >>> site_settings = registry.forInterface(ISiteSchema, prefix="plone")\n     >>> site_settings.webstats_js = u"<script>window.title=\'Hello\'</script>"\n-    >>> manager.update()\n+    >>> analytics.webstats_js == site_settings.webstats_js\n+    True\n     >>> text = manager.render()\n+    >>> \'id="plone-analytics"\' in text\n+    True\n     >>> site_settings.webstats_js in text\n     True\n \n Now enter some non-ascii text\n \n     >>> site_settings.webstats_js = u"<script>window.title=\'C\\xedsa\\u0159\'</script>"\n-    >>> manager.update()\n     >>> text = manager.render()\n     >>> site_settings.webstats_js in text\n     True\n-\n-Check if the div sorrounding the script is present\n-\n-    >>> \'id="plone-analytics"\' in text\n-    True\ndiff --git a/plone/app/layout/analytics/view.pt b/plone/app/layout/analytics/view.pt\nindex ebd13fd5..7d3f83c7 100644\n--- a/plone/app/layout/analytics/view.pt\n+++ b/plone/app/layout/analytics/view.pt\n@@ -1,8 +1,7 @@\n-<div\n-  id="plone-analytics"\n-  tal:condition="view/webstats_js"\n-  tal:content="structure view/webstats_js"\n+<div id="plone-analytics"\n+     tal:define="webstats_js view/webstats_js"\n+     tal:condition="webstats_js"\n+     tal:content="structure webstats_js"\n >\n   Here goes the webstats_js\n </div>\n-\ndiff --git a/plone/app/layout/analytics/view.py b/plone/app/layout/analytics/view.py\nindex d612f8db..b45559c1 100644\n--- a/plone/app/layout/analytics/view.py\n+++ b/plone/app/layout/analytics/view.py\n@@ -16,18 +16,20 @@ class AnalyticsViewlet(BrowserView):\n     def __init__(self, context, request, view, manager):\n         super(AnalyticsViewlet, self).__init__(context, request)\n         self.__parent__ = view\n-        self.context = context\n-        self.request = request\n         self.view = view\n         self.manager = manager\n \n-    def update(self):\n-        """render the webstats snippet"""\n+    @property\n+    def webstats_js(self):\n         registry = getUtility(IRegistry)\n         site_settings = registry.forInterface(\n             ISiteSchema, prefix="plone", check=False)\n         try:\n-            if site_settings.webstats_js:\n-                self.webstats_js = site_settings.webstats_js\n+            return site_settings.webstats_js or u""\n         except AttributeError:\n-            self.webstats_js = u""\n+            return u""\n+\n+    def update(self):\n+        """ The viewlet manager _updateViewlets requires this method\n+        """\n+        pass\n'

