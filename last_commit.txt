Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-04-02T14:21:48-03:00
Author: hvelarde (hvelarde) <hector.velarde@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/9173ca5126b4c140bac5ed4b3faf9e321fe6be19

Implement better human readable file size logic

Files changed:
A plone/app/contenttypes/tests/test_utils.py
M CHANGES.rst
M plone/app/contenttypes/browser/file.py
M plone/app/contenttypes/browser/templates/file.pt
M plone/app/contenttypes/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ac308697..0ed2380f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,9 @@ Breaking changes:
 
 New features:
 
+- Implement better human readable file size logic.
+  [hvelarde]
+
 - Set the ``plone.app.contenttypes_migration_running`` key while running a migration.
   Other addons can check for that and handle accordingly.
   [thet]
diff --git a/plone/app/contenttypes/browser/file.py b/plone/app/contenttypes/browser/file.py
index f2db2c5c..cbe05ddd 100644
--- a/plone/app/contenttypes/browser/file.py
+++ b/plone/app/contenttypes/browser/file.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 from plone.app.contenttypes.browser.utils import Utils
+from plone.app.contenttypes.utils import human_readable_size
 
 
 class FileView(Utils):
@@ -14,3 +15,6 @@ def is_audiotype(self):
 
     def get_mimetype_icon(self):
         return super(FileView, self).getMimeTypeIcon(self.context.file)
+
+    def human_readable_size(self):
+        return human_readable_size(self.context.file.getSize())
diff --git a/plone/app/contenttypes/browser/templates/file.pt b/plone/app/contenttypes/browser/templates/file.pt
index b6e8eaec..fcdab4f2 100644
--- a/plone/app/contenttypes/browser/templates/file.pt
+++ b/plone/app/contenttypes/browser/templates/file.pt
@@ -17,10 +17,7 @@
                            alt content_type;" border="0" />
       <tal:name tal:content="context/file/filename" >Filename</tal:name>
     </a>
-    <span class="discreet"
-        tal:define="size context/file/getSize;
-                    kb python:size/1024">
-      &mdash; <span tal:replace="kb" /> KB</span>
+    <span class="discreet">&mdash; <span tal:replace="view/human_readable_size" /></span>
   </p>
 
   <video tal:condition="view/is_videotype" controls="controls">
diff --git a/plone/app/contenttypes/tests/test_utils.py b/plone/app/contenttypes/tests/test_utils.py
new file mode 100644
index 00000000..91befe16
--- /dev/null
+++ b/plone/app/contenttypes/tests/test_utils.py
@@ -0,0 +1,23 @@
+# -*- coding: utf-8 -*-
+from plone.app.contenttypes.utils import human_readable_size
+
+import unittest
+
+
+class PloneAppContenttypesUtilsTestCase(unittest.TestCase):
+
+    def test_human_readable_size(self):
+        self.assertEqual(human_readable_size(0), '0 B')
+        self.assertEqual(human_readable_size(1), '1 B')
+        size = 1000
+        self.assertEqual(human_readable_size(1000), '1000 B')
+        size += 24
+        self.assertEqual(human_readable_size(size), '1.0 KB')
+        size += 512
+        self.assertEqual(human_readable_size(size), '1.5 KB')
+        size *= 1024
+        self.assertEqual(human_readable_size(size), '1.5 MB')
+        size *= 1024
+        self.assertEqual(human_readable_size(size), '1.5 GB')
+        size *= 1024
+        self.assertEqual(human_readable_size(size), '1536.0 GB')
diff --git a/plone/app/contenttypes/utils.py b/plone/app/contenttypes/utils.py
index 262fac81..39858ef5 100644
--- a/plone/app/contenttypes/utils.py
+++ b/plone/app/contenttypes/utils.py
@@ -42,3 +42,18 @@ def replace_link_variables_by_paths(context, url):
 def _replace_variable_by_path(url, variable, obj):
     path = '/'.join(obj.getPhysicalPath())
     return url.replace(variable, path)
+
+
+def human_readable_size(size):
+    """Return human readable size.
+    Based on https://stackoverflow.com/a/1094933
+    """
+    if size < 1024:
+        return '{size} B'.format(size=size)
+
+    for unit in ('KB', 'MB', 'GB'):
+        size /= 1024.0
+        if size < 1024.0:
+            return '{size:.1f} {unit}'.format(size=size, unit=unit)
+
+    return '{size:.1f} GB'.format(size=size)


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-04-03T12:17:51+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.contenttypes/commit/0641981a649304713dd2df36f5d887e01921503e

Merge pull request #463 from plone/hvelarde-file-size-2

Implement better human readable file size logic

Files changed:
A plone/app/contenttypes/tests/test_utils.py
M CHANGES.rst
M plone/app/contenttypes/browser/file.py
M plone/app/contenttypes/browser/templates/file.pt
M plone/app/contenttypes/utils.py

diff --git a/CHANGES.rst b/CHANGES.rst
index ac308697..0ed2380f 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -10,6 +10,9 @@ Breaking changes:
 
 New features:
 
+- Implement better human readable file size logic.
+  [hvelarde]
+
 - Set the ``plone.app.contenttypes_migration_running`` key while running a migration.
   Other addons can check for that and handle accordingly.
   [thet]
diff --git a/plone/app/contenttypes/browser/file.py b/plone/app/contenttypes/browser/file.py
index f2db2c5c..cbe05ddd 100644
--- a/plone/app/contenttypes/browser/file.py
+++ b/plone/app/contenttypes/browser/file.py
@@ -1,5 +1,6 @@
 # -*- coding: utf-8 -*-
 from plone.app.contenttypes.browser.utils import Utils
+from plone.app.contenttypes.utils import human_readable_size
 
 
 class FileView(Utils):
@@ -14,3 +15,6 @@ def is_audiotype(self):
 
     def get_mimetype_icon(self):
         return super(FileView, self).getMimeTypeIcon(self.context.file)
+
+    def human_readable_size(self):
+        return human_readable_size(self.context.file.getSize())
diff --git a/plone/app/contenttypes/browser/templates/file.pt b/plone/app/contenttypes/browser/templates/file.pt
index b6e8eaec..fcdab4f2 100644
--- a/plone/app/contenttypes/browser/templates/file.pt
+++ b/plone/app/contenttypes/browser/templates/file.pt
@@ -17,10 +17,7 @@
                            alt content_type;" border="0" />
       <tal:name tal:content="context/file/filename" >Filename</tal:name>
     </a>
-    <span class="discreet"
-        tal:define="size context/file/getSize;
-                    kb python:size/1024">
-      &mdash; <span tal:replace="kb" /> KB</span>
+    <span class="discreet">&mdash; <span tal:replace="view/human_readable_size" /></span>
   </p>
 
   <video tal:condition="view/is_videotype" controls="controls">
diff --git a/plone/app/contenttypes/tests/test_utils.py b/plone/app/contenttypes/tests/test_utils.py
new file mode 100644
index 00000000..91befe16
--- /dev/null
+++ b/plone/app/contenttypes/tests/test_utils.py
@@ -0,0 +1,23 @@
+# -*- coding: utf-8 -*-
+from plone.app.contenttypes.utils import human_readable_size
+
+import unittest
+
+
+class PloneAppContenttypesUtilsTestCase(unittest.TestCase):
+
+    def test_human_readable_size(self):
+        self.assertEqual(human_readable_size(0), '0 B')
+        self.assertEqual(human_readable_size(1), '1 B')
+        size = 1000
+        self.assertEqual(human_readable_size(1000), '1000 B')
+        size += 24
+        self.assertEqual(human_readable_size(size), '1.0 KB')
+        size += 512
+        self.assertEqual(human_readable_size(size), '1.5 KB')
+        size *= 1024
+        self.assertEqual(human_readable_size(size), '1.5 MB')
+        size *= 1024
+        self.assertEqual(human_readable_size(size), '1.5 GB')
+        size *= 1024
+        self.assertEqual(human_readable_size(size), '1536.0 GB')
diff --git a/plone/app/contenttypes/utils.py b/plone/app/contenttypes/utils.py
index 262fac81..39858ef5 100644
--- a/plone/app/contenttypes/utils.py
+++ b/plone/app/contenttypes/utils.py
@@ -42,3 +42,18 @@ def replace_link_variables_by_paths(context, url):
 def _replace_variable_by_path(url, variable, obj):
     path = '/'.join(obj.getPhysicalPath())
     return url.replace(variable, path)
+
+
+def human_readable_size(size):
+    """Return human readable size.
+    Based on https://stackoverflow.com/a/1094933
+    """
+    if size < 1024:
+        return '{size} B'.format(size=size)
+
+    for unit in ('KB', 'MB', 'GB'):
+        size /= 1024.0
+        if size < 1024.0:
+            return '{size:.1f} {unit}'.format(size=size, unit=unit)
+
+    return '{size:.1f} GB'.format(size=size)


