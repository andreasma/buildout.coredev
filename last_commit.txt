Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2018-07-21T17:40:28-07:00
Author: Ross Patterson (rpatterson) <me@rpatterson.net>
Commit: https://github.com/plone/Products.CMFPlone/commit/43de8498a6364f5bed5c7a34bf96f61000532262

Add test coverage for basic content move redirection

Files changed:
A Products/CMFPlone/tests/test_redirector.py

b'diff --git a/Products/CMFPlone/tests/test_redirector.py b/Products/CMFPlone/tests/test_redirector.py\nnew file mode 100644\nindex 000000000..dc0aa38da\n--- /dev/null\n+++ b/Products/CMFPlone/tests/test_redirector.py\n@@ -0,0 +1,50 @@\n+"""\n+Test redirection support end-to-end.\n+"""\n+\n+import unittest\n+\n+import transaction\n+\n+from plone.testing import z2\n+from plone.app import testing as pa_testing\n+\n+from Products.CMFCore.utils import getToolByName\n+\n+from plone.app.redirector import testing\n+\n+\n+class FunctionalRedirectTest(unittest.TestCase):\n+    """\n+    Test redirection support end-to-end.\n+    """\n+\n+    layer = testing.PLONE_APP_REDIRECTOR_FUNCTIONAL_TESTING\n+\n+    def setUp(self):\n+        """\n+        Rename a document so there\'s a working redirect in place.\n+        """\n+        self.portal = self.layer[\'portal\']\n+        pa_testing.setRoles(self.portal, pa_testing.TEST_USER_ID, [\'Manager\'])\n+        self.portal.invokeFactory("Folder", "folder")\n+        self.folder = self.portal.folder\n+        workflow = getToolByName(self.portal, \'portal_workflow\')\n+        workflow.doActionFor(self.folder, \'publish\')\n+        self.folder.invokeFactory(\'Document\', \'foo-document\')\n+        workflow.doActionFor(self.folder[\'foo-document\'], \'publish\')\n+        transaction.savepoint(1)\n+        self.folder.manage_renameObject(\'foo-document\', \'bar-document\')\n+        transaction.commit()\n+\n+        self.browser = z2.Browser(self.layer[\'app\'])\n+\n+    def test_redirect(self):\n+        """\n+        A simple redirect returns the correct status and headers.\n+        """\n+        self.browser.addHeader(\'Accept\', \'text/html\')\n+        self.browser.open(self.folder.absolute_url() + \'/foo-document\')\n+        self.assertEqual(\n+            self.browser.url, self.folder[\'bar-document\'].absolute_url(),\n+            \'Wrong redirect HTTP response location\')\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2018-07-21T17:48:12-07:00
Author: Ross Patterson (rpatterson) <me@rpatterson.net>
Commit: https://github.com/plone/Products.CMFPlone/commit/3b634f6dd25c4dbee6ac5257e61545785d3aa2d4

Fix plone.app.redirector support for JSON/unspecified requests

Files changed:
M Products/CMFPlone/skins/plone_templates/standard_error_message.py
M Products/CMFPlone/tests/test_redirector.py

b'diff --git a/Products/CMFPlone/skins/plone_templates/standard_error_message.py b/Products/CMFPlone/skins/plone_templates/standard_error_message.py\nindex ce9c7aca8..1f0f6e2b0 100644\n--- a/Products/CMFPlone/skins/plone_templates/standard_error_message.py\n+++ b/Products/CMFPlone/skins/plone_templates/standard_error_message.py\n@@ -28,6 +28,9 @@\n error_value = kwargs.get(\'error_value\', None)\n \n if "text/html" not in context.REQUEST.getHeader(\'Accept\', \'\'):\n+    redirection_view = context.restrictedTraverse(\'@@plone_redirector_view\')\n+    redirection_view.attempt_redirect()\n+\n     context.REQUEST.RESPONSE.setHeader("Content-Type", "application/json")\n     # Note: using %s instead of .format to avoid possibly expensive guarded\n     # attribute check.\ndiff --git a/Products/CMFPlone/tests/test_redirector.py b/Products/CMFPlone/tests/test_redirector.py\nindex dc0aa38da..7fba76751 100644\n--- a/Products/CMFPlone/tests/test_redirector.py\n+++ b/Products/CMFPlone/tests/test_redirector.py\n@@ -48,3 +48,12 @@ def test_redirect(self):\n         self.assertEqual(\n             self.browser.url, self.folder[\'bar-document\'].absolute_url(),\n             \'Wrong redirect HTTP response location\')\n+\n+    def test_redirect_json(self):\n+        """\n+        Redirects work for moved content for JSON or unspecified requests.\n+        """\n+        self.browser.open(self.folder.absolute_url() + \'/foo-document\')\n+        self.assertEqual(\n+            self.browser.url, self.folder[\'bar-document\'].absolute_url(),\n+            \'Wrong redirect HTTP response location\')\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2018-07-28T13:58:50-07:00
Author: Ross Patterson (rpatterson) <me@rpatterson.net>
Commit: https://github.com/plone/Products.CMFPlone/commit/86fae14a6dc996850677d0b8ac480c24aced0091

Add missing ChangeLog entry

Files changed:
M CHANGES.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex ee808dc2a..ecee9aeb2 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -23,6 +23,14 @@ Bug fixes:\n   IRichText -> IRichTextBehavior\n   This is a follow up to `issue 476 <https://github.com/plone/plone.app.contenttypes/issues/476>`_.\n   [iham]\n+- Fix plone.app.redirector support for JSON/unspecified requests.\n+  [rpatterson]\n+\n+- Do not include too new upgrades when upgrading Plone Site.\n+  Otherwise the Plone Site ends up at a newer version that the filesystem code supports,\n+  giving an error when upgrading, and resulting in possibly missed upgrades later.\n+  Fixes `issue 2377 <https://github.com/plone/Products.CMFPlone/issues/2377>`_.\n+  [maurits]\n \n - Add test for issue #2469.\n   [jensens]\n'

