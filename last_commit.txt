Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-10-01T17:43:15+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/e0a48eb3131799b13c271adcd4990649a1ca502b

testfixes for plone 5.2 and python 3

Files changed:
M plone/app/upgrade/tests/test_upgrade.py
M plone/app/upgrade/v41/alphas.py
M plone/app/upgrade/v41/final.py
M plone/app/upgrade/v43/alphas.py
M plone/app/upgrade/v50/alphas.py
M plone/app/upgrade/v50/betas.py

b"diff --git a/plone/app/upgrade/tests/test_upgrade.py b/plone/app/upgrade/tests/test_upgrade.py\nindex fabc4886..416d4b56 100644\n--- a/plone/app/upgrade/tests/test_upgrade.py\n+++ b/plone/app/upgrade/tests/test_upgrade.py\n@@ -39,8 +39,8 @@ def testVersionMatch(self):\n \n     def testDoUpgrades(self):\n         self.setRoles(['Manager'])\n-\n-        self.setup.setLastVersionForProfile(_DEFAULT_PROFILE, '2.5')\n+        \n+        self.setup.setLastVersionForProfile(_DEFAULT_PROFILE, '4013')\n         upgrades = self.setup.listUpgrades(_DEFAULT_PROFILE)\n         self.assertTrue(len(upgrades) > 0)\n \ndiff --git a/plone/app/upgrade/v41/alphas.py b/plone/app/upgrade/v41/alphas.py\nindex 727ab761..51d15f22 100644\n--- a/plone/app/upgrade/v41/alphas.py\n+++ b/plone/app/upgrade/v41/alphas.py\n@@ -100,7 +100,10 @@ def _update_rolemap_for_siteadmin_role(portal):\n                                      roles,\n                                      permission_info['acquire'])\n     for permission_id in extra_permissions:\n-        portal.manage_permission(permission_id, ['Site Administrator', ], True)\n+        try:\n+            portal.manage_permission(permission_id, ['Site Administrator', ], True)\n+        except ValueError:\n+            continue\n \n \n def _update_workflows_for_siteadmin_role(portal):\ndiff --git a/plone/app/upgrade/v41/final.py b/plone/app/upgrade/v41/final.py\nindex fcd5dff4..ff380fe4 100644\n--- a/plone/app/upgrade/v41/final.py\n+++ b/plone/app/upgrade/v41/final.py\n@@ -17,7 +17,7 @@ def fixOkapiIndexes(catalog):\n     for index in catalog.getIndexObjects():\n         index = getattr(index, 'index', index)\n         if isinstance(index, OkapiIndex):\n-            index._totaldoclen = Length(long(sum(index._docweight.values())))\n+            index._totaldoclen = Length(int(sum(index._docweight.values())))\n \n \n def fixOwnerTuples(portal):\ndiff --git a/plone/app/upgrade/v43/alphas.py b/plone/app/upgrade/v43/alphas.py\nindex faa911d2..fd49a34c 100644\n--- a/plone/app/upgrade/v43/alphas.py\n+++ b/plone/app/upgrade/v43/alphas.py\n@@ -203,10 +203,11 @@ def _update_syndication_info(portal):\n     from Products.CMFPlone.interfaces.syndication import ISyndicatable\n     catalog = getToolByName(portal, 'portal_catalog')\n     # get all folder types from portal_types\n-    at_tool = getToolByName(portal, 'archetype_tool')\n+    at_tool = getToolByName(portal, 'archetype_tool', None)\n     folder_types = set([])\n-    for _type in at_tool.listPortalTypesWithInterfaces([ISyndicatable]):\n-        folder_types.add(_type.getId())\n+    if at_tool is not None:\n+        for _type in at_tool.listPortalTypesWithInterfaces([ISyndicatable]):\n+            folder_types.add(_type.getId())\n     folder_types = folder_types | _getDexterityFolderTypes(portal)\n     for brain in catalog(portal_type=tuple(folder_types)):\n         try:\ndiff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py\nindex 2b1a8de4..58ceebf9 100644\n--- a/plone/app/upgrade/v50/alphas.py\n+++ b/plone/app/upgrade/v50/alphas.py\n@@ -159,9 +159,9 @@ def migrate_registry_settings(portal):\n     site_props = portal.portal_properties.site_properties\n     registry = portal.portal_registry\n     portal_types = portal.portal_types\n-    registry['plone.site_title'] = portal.title.decode('utf8')\n+    registry['plone.site_title'] = safe_unicode(portal.title)\n     if site_props.hasProperty('webstats_js'):\n-        registry['plone.webstats_js'] = site_props.webstats_js.decode('utf8')\n+        registry['plone.webstats_js'] = safe_unicode(site_props.webstats_js)\n     if site_props.hasProperty('enable_sitemap'):\n         registry['plone.enable_sitemap'] = site_props.enable_sitemap\n \n@@ -264,8 +264,12 @@ def upgrade_editing_controlpanel_settings(context):\n         IEditingSchema['default_editor'].validate(\n             site_properties.default_editor)\n     except ConstraintNotSatisfied:\n-        logger.warn('Ignoring invalid site_properties.default_editor %r.',\n-                    site_properties.default_editor)\n+        logger.warning(\n+            'Ignoring invalid site_properties.default_editor %r.',\n+            site_properties.default_editor)\n+    except AttributeError:\n+        logger.warning(\n+            'Ignoring non existing attribute site_properties.default_editor.')\n     else:\n         settings.default_editor = site_properties.default_editor\n     settings.lock_on_ttw_edit = get_property(\ndiff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py\nindex 3901ba72..87ae1cb5 100644\n--- a/plone/app/upgrade/v50/betas.py\n+++ b/plone/app/upgrade/v50/betas.py\n@@ -84,7 +84,7 @@ def upgrade_mail_controlpanel_settings(context):\n     portal = getSite()\n \n     smtp_host = getattr(portal.MailHost, 'smtp_host', '')\n-    mail_settings.smtp_host = unicode(smtp_host)\n+    mail_settings.smtp_host = safe_unicode(smtp_host)\n \n     smtp_port = getattr(portal.MailHost, 'smtp_port', 25)\n     # It may happen that smtp_port is a string, maybe empty,\n"

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-10-01T17:50:44+02:00
Author: Peter Mathis (petschki) <peter.mathis@kombinat.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/ba855029287740c1d1e161551a28d8a0d9015b2a

add changelog

Files changed:
A news/176.bugfix

b'diff --git a/news/176.bugfix b/news/176.bugfix\nnew file mode 100644\nindex 00000000..49a59c81\n--- /dev/null\n+++ b/news/176.bugfix\n@@ -0,0 +1,6 @@\n+fix tests in Plone >= 5.2 and python 3.\n+As discussed with jensens and mauritsvanrees\n+we start migration tests beginning from 4.0 final \n+due to portal_factory property errors.\n+\n+[petschki]\n\\ No newline at end of file\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-10-01T18:57:05+02:00
Author: Peter Mathis (petschki) <petschki@users.noreply.github.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/d94d545ef8c80bf0259f985c87e5fc808d3c5730

Merge pull request #176 from plone/python3-testfixes

testfixes for plone 5.2 and python 3

Files changed:
A news/176.bugfix
M plone/app/upgrade/tests/test_upgrade.py
M plone/app/upgrade/v41/alphas.py
M plone/app/upgrade/v41/final.py
M plone/app/upgrade/v43/alphas.py
M plone/app/upgrade/v50/alphas.py
M plone/app/upgrade/v50/betas.py

b"diff --git a/news/176.bugfix b/news/176.bugfix\nnew file mode 100644\nindex 00000000..49a59c81\n--- /dev/null\n+++ b/news/176.bugfix\n@@ -0,0 +1,6 @@\n+fix tests in Plone >= 5.2 and python 3.\n+As discussed with jensens and mauritsvanrees\n+we start migration tests beginning from 4.0 final \n+due to portal_factory property errors.\n+\n+[petschki]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/tests/test_upgrade.py b/plone/app/upgrade/tests/test_upgrade.py\nindex fabc4886..416d4b56 100644\n--- a/plone/app/upgrade/tests/test_upgrade.py\n+++ b/plone/app/upgrade/tests/test_upgrade.py\n@@ -39,8 +39,8 @@ def testVersionMatch(self):\n \n     def testDoUpgrades(self):\n         self.setRoles(['Manager'])\n-\n-        self.setup.setLastVersionForProfile(_DEFAULT_PROFILE, '2.5')\n+        \n+        self.setup.setLastVersionForProfile(_DEFAULT_PROFILE, '4013')\n         upgrades = self.setup.listUpgrades(_DEFAULT_PROFILE)\n         self.assertTrue(len(upgrades) > 0)\n \ndiff --git a/plone/app/upgrade/v41/alphas.py b/plone/app/upgrade/v41/alphas.py\nindex 727ab761..51d15f22 100644\n--- a/plone/app/upgrade/v41/alphas.py\n+++ b/plone/app/upgrade/v41/alphas.py\n@@ -100,7 +100,10 @@ def _update_rolemap_for_siteadmin_role(portal):\n                                      roles,\n                                      permission_info['acquire'])\n     for permission_id in extra_permissions:\n-        portal.manage_permission(permission_id, ['Site Administrator', ], True)\n+        try:\n+            portal.manage_permission(permission_id, ['Site Administrator', ], True)\n+        except ValueError:\n+            continue\n \n \n def _update_workflows_for_siteadmin_role(portal):\ndiff --git a/plone/app/upgrade/v41/final.py b/plone/app/upgrade/v41/final.py\nindex fcd5dff4..ff380fe4 100644\n--- a/plone/app/upgrade/v41/final.py\n+++ b/plone/app/upgrade/v41/final.py\n@@ -17,7 +17,7 @@ def fixOkapiIndexes(catalog):\n     for index in catalog.getIndexObjects():\n         index = getattr(index, 'index', index)\n         if isinstance(index, OkapiIndex):\n-            index._totaldoclen = Length(long(sum(index._docweight.values())))\n+            index._totaldoclen = Length(int(sum(index._docweight.values())))\n \n \n def fixOwnerTuples(portal):\ndiff --git a/plone/app/upgrade/v43/alphas.py b/plone/app/upgrade/v43/alphas.py\nindex faa911d2..fd49a34c 100644\n--- a/plone/app/upgrade/v43/alphas.py\n+++ b/plone/app/upgrade/v43/alphas.py\n@@ -203,10 +203,11 @@ def _update_syndication_info(portal):\n     from Products.CMFPlone.interfaces.syndication import ISyndicatable\n     catalog = getToolByName(portal, 'portal_catalog')\n     # get all folder types from portal_types\n-    at_tool = getToolByName(portal, 'archetype_tool')\n+    at_tool = getToolByName(portal, 'archetype_tool', None)\n     folder_types = set([])\n-    for _type in at_tool.listPortalTypesWithInterfaces([ISyndicatable]):\n-        folder_types.add(_type.getId())\n+    if at_tool is not None:\n+        for _type in at_tool.listPortalTypesWithInterfaces([ISyndicatable]):\n+            folder_types.add(_type.getId())\n     folder_types = folder_types | _getDexterityFolderTypes(portal)\n     for brain in catalog(portal_type=tuple(folder_types)):\n         try:\ndiff --git a/plone/app/upgrade/v50/alphas.py b/plone/app/upgrade/v50/alphas.py\nindex 2b1a8de4..58ceebf9 100644\n--- a/plone/app/upgrade/v50/alphas.py\n+++ b/plone/app/upgrade/v50/alphas.py\n@@ -159,9 +159,9 @@ def migrate_registry_settings(portal):\n     site_props = portal.portal_properties.site_properties\n     registry = portal.portal_registry\n     portal_types = portal.portal_types\n-    registry['plone.site_title'] = portal.title.decode('utf8')\n+    registry['plone.site_title'] = safe_unicode(portal.title)\n     if site_props.hasProperty('webstats_js'):\n-        registry['plone.webstats_js'] = site_props.webstats_js.decode('utf8')\n+        registry['plone.webstats_js'] = safe_unicode(site_props.webstats_js)\n     if site_props.hasProperty('enable_sitemap'):\n         registry['plone.enable_sitemap'] = site_props.enable_sitemap\n \n@@ -264,8 +264,12 @@ def upgrade_editing_controlpanel_settings(context):\n         IEditingSchema['default_editor'].validate(\n             site_properties.default_editor)\n     except ConstraintNotSatisfied:\n-        logger.warn('Ignoring invalid site_properties.default_editor %r.',\n-                    site_properties.default_editor)\n+        logger.warning(\n+            'Ignoring invalid site_properties.default_editor %r.',\n+            site_properties.default_editor)\n+    except AttributeError:\n+        logger.warning(\n+            'Ignoring non existing attribute site_properties.default_editor.')\n     else:\n         settings.default_editor = site_properties.default_editor\n     settings.lock_on_ttw_edit = get_property(\ndiff --git a/plone/app/upgrade/v50/betas.py b/plone/app/upgrade/v50/betas.py\nindex 3901ba72..87ae1cb5 100644\n--- a/plone/app/upgrade/v50/betas.py\n+++ b/plone/app/upgrade/v50/betas.py\n@@ -84,7 +84,7 @@ def upgrade_mail_controlpanel_settings(context):\n     portal = getSite()\n \n     smtp_host = getattr(portal.MailHost, 'smtp_host', '')\n-    mail_settings.smtp_host = unicode(smtp_host)\n+    mail_settings.smtp_host = safe_unicode(smtp_host)\n \n     smtp_port = getattr(portal.MailHost, 'smtp_port', 25)\n     # It may happen that smtp_port is a string, maybe empty,\n"

