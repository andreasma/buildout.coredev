Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2018-12-06T08:50:01+01:00
Author: ale-rt (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/f85fb09f63ff404dfbe753be6bb68f120ec9313e

Restore the possibility to sort catalog query results with multiple indexes

Fixes #2464

Files changed:
A news/2464.fixed
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

b"diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 983ee8adb..161a862b8 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -1,12 +1,6 @@\n-import logging\n-import re\n-import time\n-import urllib\n-\n from AccessControl import ClassSecurityInfo\n from AccessControl.PermissionRole import rolesForPermissionOn\n-from AccessControl.Permissions import (\n-    manage_zcatalog_entries as ManageZCatalogEntries)\n+from AccessControl.Permissions import manage_zcatalog_entries as ManageZCatalogEntries  # noqa\n from AccessControl.Permissions import search_zcatalog as SearchZCatalog\n from Acquisition import aq_base\n from Acquisition import aq_inner\n@@ -16,6 +10,9 @@\n from BTrees.Length import Length\n from DateTime import DateTime\n from OFS.interfaces import IOrderedContainer\n+from plone.i18n.normalizer.base import mapUnicode\n+from plone.indexer import indexer\n+from plone.indexer.interfaces import IIndexableObject\n from Products.CMFCore.CatalogTool import CatalogTool as BaseTool\n from Products.CMFCore.CatalogTool import _mergedLocalRoles\n from Products.CMFCore.permissions import AccessInactivePortalContent\n@@ -23,22 +20,25 @@\n from Products.CMFCore.utils import _getAuthenticatedUser\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import DISCUSSION_ANNOTATION_KEY\n-from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from Products.CMFPlone.interfaces import INonStructuralFolder\n from Products.CMFPlone.interfaces import IPloneCatalogTool\n+from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from Products.CMFPlone.utils import base_hasattr\n from Products.CMFPlone.utils import safe_callable\n from Products.CMFPlone.utils import safe_unicode\n from Products.ZCatalog.ZCatalog import ZCatalog\n-from plone.i18n.normalizer.base import mapUnicode\n-from plone.indexer import indexer\n-from plone.indexer.interfaces import IIndexableObject\n from zope.annotation.interfaces import IAnnotations\n from zope.component import queryMultiAdapter\n-from zope.interface import Interface\n from zope.interface import implementer\n+from zope.interface import Interface\n from zope.interface import providedBy\n \n+import logging\n+import re\n+import six\n+import time\n+import urllib\n+\n \n logger = logging.getLogger('Plone')\n \n@@ -387,10 +387,20 @@ def searchResults(self, REQUEST=None, **kw):\n            and not _checkPermission(AccessInactivePortalContent, self):\n             kw['effectiveRange'] = DateTime()\n \n-        sort_on = kw.get('sort_on')\n-        if sort_on and sort_on not in self.indexes():\n-            # I get crazy sort_ons like '194' or 'null'.\n-            kw.pop('sort_on')\n+        # filter out invalid sort_on indexes\n+        sort_on = kw.get('sort_on') or []\n+        if isinstance(sort_on, six.string_types):\n+            sort_on = [sort_on]\n+        valid_indexes = self.indexes()\n+        try:\n+            sort_on = [idx for idx in sort_on if idx in valid_indexes]\n+        except TypeError:\n+            # sort_on is not iterable\n+            sort_on = []\n+        if not sort_on:\n+            kw.pop('sort_on', None)\n+        else:\n+            kw['sort_on'] = sort_on\n \n         return ZCatalog.searchResults(self, REQUEST, **kw)\n \ndiff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py\nindex c6e2be75a..d99dfa0b0 100644\n--- a/Products/CMFPlone/tests/testCatalogTool.py\n+++ b/Products/CMFPlone/tests/testCatalogTool.py\n@@ -1,6 +1,7 @@\n # -*- encoding: utf-8 -*-\n from Acquisition import aq_base\n from DateTime import DateTime\n+from functools import partial\n from OFS.ObjectManager import REPLACEABLE\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n@@ -13,14 +14,16 @@\n from Products.CMFPlone.tests import dummy\n from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n from Products.CMFPlone.tests.utils import folder_position\n+from z3c.form.interfaces import IFormLayer\n from zope.event import notify\n from zope.interface import alsoProvides\n from zope.lifecycleevent import ObjectCreatedEvent\n-from z3c.form.interfaces import IFormLayer\n+\n import transaction\n import unittest\n import zope.interface\n \n+\n user2 = 'u2'\n group2 = 'g2'\n \n@@ -519,6 +522,36 @@ def afterSetUp(self):\n         self.folder.doc5.reindexObject()\n         self.folder.doc6.reindexObject()\n \n+    def testSortMultipleColumns(self):\n+        path = '/'.join(self.folder.getPhysicalPath())\n+        query = partial(self.catalog, path=path)\n+        brains = query(sort_on=['portal_type', 'sortable_title'])\n+        self.assertListEqual(\n+            [brain.getPath() for brain in brains],\n+            [\n+                '/plone/Members/test_user_1_/doc2',\n+                '/plone/Members/test_user_1_/doc3',\n+                '/plone/Members/test_user_1_/doc',\n+                '/plone/Members/test_user_1_/doc5',\n+                '/plone/Members/test_user_1_/doc6',\n+                '/plone/Members/test_user_1_/doc4',\n+                '/plone/Members/test_user_1_'\n+            ],\n+        )\n+        brains = query(sort_on=['portal_type', 'getId'])\n+        self.assertListEqual(\n+            [brain.getPath() for brain in brains],\n+            [\n+                '/plone/Members/test_user_1_/doc',\n+                '/plone/Members/test_user_1_/doc2',\n+                '/plone/Members/test_user_1_/doc3',\n+                '/plone/Members/test_user_1_/doc4',\n+                '/plone/Members/test_user_1_/doc5',\n+                '/plone/Members/test_user_1_/doc6',\n+                '/plone/Members/test_user_1_',\n+            ]\n+        )\n+\n     def testUnknownSortOnIsIgnored(self):\n         # You should not get a CatalogError when an invalid sort_on is passed.\n         # I get crazy sort_ons like '194' or 'null'.\ndiff --git a/news/2464.fixed b/news/2464.fixed\nnew file mode 100644\nindex 000000000..208e85080\n--- /dev/null\n+++ b/news/2464.fixed\n@@ -0,0 +1 @@\n+Restore the possibility to sort catalog query results with multiple indexes\n"

Repository: Products.CMFPlone


Branch: refs/heads/5.0.x
Date: 2018-12-06T18:22:35+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/8f6bf5587e666046b5538a054484ae9887e6368a

Merge pull request #2651 from plone/5.0.x-2464-fix-sorting-multiple-columns

[5.0.x] Restore the possibility to sort catalog query results with multiple indexes

Files changed:
A news/2464.fixed
M Products/CMFPlone/CatalogTool.py
M Products/CMFPlone/tests/testCatalogTool.py

b"diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 983ee8adb..161a862b8 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -1,12 +1,6 @@\n-import logging\n-import re\n-import time\n-import urllib\n-\n from AccessControl import ClassSecurityInfo\n from AccessControl.PermissionRole import rolesForPermissionOn\n-from AccessControl.Permissions import (\n-    manage_zcatalog_entries as ManageZCatalogEntries)\n+from AccessControl.Permissions import manage_zcatalog_entries as ManageZCatalogEntries  # noqa\n from AccessControl.Permissions import search_zcatalog as SearchZCatalog\n from Acquisition import aq_base\n from Acquisition import aq_inner\n@@ -16,6 +10,9 @@\n from BTrees.Length import Length\n from DateTime import DateTime\n from OFS.interfaces import IOrderedContainer\n+from plone.i18n.normalizer.base import mapUnicode\n+from plone.indexer import indexer\n+from plone.indexer.interfaces import IIndexableObject\n from Products.CMFCore.CatalogTool import CatalogTool as BaseTool\n from Products.CMFCore.CatalogTool import _mergedLocalRoles\n from Products.CMFCore.permissions import AccessInactivePortalContent\n@@ -23,22 +20,25 @@\n from Products.CMFCore.utils import _getAuthenticatedUser\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone import DISCUSSION_ANNOTATION_KEY\n-from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from Products.CMFPlone.interfaces import INonStructuralFolder\n from Products.CMFPlone.interfaces import IPloneCatalogTool\n+from Products.CMFPlone.PloneBaseTool import PloneBaseTool\n from Products.CMFPlone.utils import base_hasattr\n from Products.CMFPlone.utils import safe_callable\n from Products.CMFPlone.utils import safe_unicode\n from Products.ZCatalog.ZCatalog import ZCatalog\n-from plone.i18n.normalizer.base import mapUnicode\n-from plone.indexer import indexer\n-from plone.indexer.interfaces import IIndexableObject\n from zope.annotation.interfaces import IAnnotations\n from zope.component import queryMultiAdapter\n-from zope.interface import Interface\n from zope.interface import implementer\n+from zope.interface import Interface\n from zope.interface import providedBy\n \n+import logging\n+import re\n+import six\n+import time\n+import urllib\n+\n \n logger = logging.getLogger('Plone')\n \n@@ -387,10 +387,20 @@ def searchResults(self, REQUEST=None, **kw):\n            and not _checkPermission(AccessInactivePortalContent, self):\n             kw['effectiveRange'] = DateTime()\n \n-        sort_on = kw.get('sort_on')\n-        if sort_on and sort_on not in self.indexes():\n-            # I get crazy sort_ons like '194' or 'null'.\n-            kw.pop('sort_on')\n+        # filter out invalid sort_on indexes\n+        sort_on = kw.get('sort_on') or []\n+        if isinstance(sort_on, six.string_types):\n+            sort_on = [sort_on]\n+        valid_indexes = self.indexes()\n+        try:\n+            sort_on = [idx for idx in sort_on if idx in valid_indexes]\n+        except TypeError:\n+            # sort_on is not iterable\n+            sort_on = []\n+        if not sort_on:\n+            kw.pop('sort_on', None)\n+        else:\n+            kw['sort_on'] = sort_on\n \n         return ZCatalog.searchResults(self, REQUEST, **kw)\n \ndiff --git a/Products/CMFPlone/tests/testCatalogTool.py b/Products/CMFPlone/tests/testCatalogTool.py\nindex c6e2be75a..d99dfa0b0 100644\n--- a/Products/CMFPlone/tests/testCatalogTool.py\n+++ b/Products/CMFPlone/tests/testCatalogTool.py\n@@ -1,6 +1,7 @@\n # -*- encoding: utf-8 -*-\n from Acquisition import aq_base\n from DateTime import DateTime\n+from functools import partial\n from OFS.ObjectManager import REPLACEABLE\n from plone.app.testing import TEST_USER_ID\n from plone.app.testing import TEST_USER_NAME\n@@ -13,14 +14,16 @@\n from Products.CMFPlone.tests import dummy\n from Products.CMFPlone.tests.PloneTestCase import PloneTestCase\n from Products.CMFPlone.tests.utils import folder_position\n+from z3c.form.interfaces import IFormLayer\n from zope.event import notify\n from zope.interface import alsoProvides\n from zope.lifecycleevent import ObjectCreatedEvent\n-from z3c.form.interfaces import IFormLayer\n+\n import transaction\n import unittest\n import zope.interface\n \n+\n user2 = 'u2'\n group2 = 'g2'\n \n@@ -519,6 +522,36 @@ def afterSetUp(self):\n         self.folder.doc5.reindexObject()\n         self.folder.doc6.reindexObject()\n \n+    def testSortMultipleColumns(self):\n+        path = '/'.join(self.folder.getPhysicalPath())\n+        query = partial(self.catalog, path=path)\n+        brains = query(sort_on=['portal_type', 'sortable_title'])\n+        self.assertListEqual(\n+            [brain.getPath() for brain in brains],\n+            [\n+                '/plone/Members/test_user_1_/doc2',\n+                '/plone/Members/test_user_1_/doc3',\n+                '/plone/Members/test_user_1_/doc',\n+                '/plone/Members/test_user_1_/doc5',\n+                '/plone/Members/test_user_1_/doc6',\n+                '/plone/Members/test_user_1_/doc4',\n+                '/plone/Members/test_user_1_'\n+            ],\n+        )\n+        brains = query(sort_on=['portal_type', 'getId'])\n+        self.assertListEqual(\n+            [brain.getPath() for brain in brains],\n+            [\n+                '/plone/Members/test_user_1_/doc',\n+                '/plone/Members/test_user_1_/doc2',\n+                '/plone/Members/test_user_1_/doc3',\n+                '/plone/Members/test_user_1_/doc4',\n+                '/plone/Members/test_user_1_/doc5',\n+                '/plone/Members/test_user_1_/doc6',\n+                '/plone/Members/test_user_1_',\n+            ]\n+        )\n+\n     def testUnknownSortOnIsIgnored(self):\n         # You should not get a CatalogError when an invalid sort_on is passed.\n         # I get crazy sort_ons like '194' or 'null'.\ndiff --git a/news/2464.fixed b/news/2464.fixed\nnew file mode 100644\nindex 000000000..208e85080\n--- /dev/null\n+++ b/news/2464.fixed\n@@ -0,0 +1 @@\n+Restore the possibility to sort catalog query results with multiple indexes\n"

