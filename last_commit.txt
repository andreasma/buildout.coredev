Repository: plone.app.layout


Branch: refs/heads/2.8.x
Date: 2019-08-09T18:18:03+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/2469661887cf195220477fc8b5506d0f7f5a95e0

Refs #204 - Optimize @@historyview workflowHistory user info

Files changed:
M plone/app/layout/viewlets/content.py

b'diff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 9651ab2d..e5e23f7d 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -320,6 +320,20 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     index = ViewPageTemplateFile("review_history.pt")\n \n+    @memoize\n+    def getUserInfo(self, userid):\n+        mt = getToolByName(self.context, \'portal_membership\')\n+        info = mt.getMemberInfo(userid)\n+        if info is None:\n+            return dict(actor_home="",\n+                        actor=dict(fullname=userid))\n+\n+        if not info.get("fullname", None):\n+            info["fullname"] = userid\n+\n+        return dict(actor=info,\n+                    actor_home="%s/author/%s" % (self.site_url, userid))\n+\n     def workflowHistory(self, complete=True):\n         """Return workflow history of this context.\n \n@@ -332,8 +346,6 @@ def workflowHistory(self, complete=True):\n             return []\n \n         workflow = getToolByName(context, \'portal_workflow\')\n-        membership = getToolByName(context, \'portal_membership\')\n-\n         review_history = []\n \n         try:\n@@ -362,14 +374,7 @@ def workflowHistory(self, complete=True):\n                     r[\'actor\'] = {\'username\': anon, \'fullname\': anon}\n                     r[\'actor_home\'] = \'\'\n                 else:\n-                    r[\'actor\'] = membership.getMemberInfo(actorid)\n-                    if r[\'actor\'] is not None:\n-                        r[\'actor_home\'] = self.navigation_root_url + \\\n-                            \'/author/\' + actorid\n-                    else:\n-                        # member info is not available\n-                        # the user was probably deleted\n-                        r[\'actor_home\'] = \'\'\n+                    r.update(self.getUserInfo(actorid))\n             review_history.reverse()\n \n         except WorkflowException:\n@@ -384,20 +389,6 @@ class ContentHistoryViewlet(WorkflowHistoryViewlet):\n \n     index = ViewPageTemplateFile("content_history.pt")\n \n-    @memoize\n-    def getUserInfo(self, userid):\n-        mt = getToolByName(self.context, \'portal_membership\')\n-        info = mt.getMemberInfo(userid)\n-        if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n-\n-        if not info.get("fullname", None):\n-            info["fullname"] = userid\n-\n-        return dict(actor=info,\n-                    actor_home="%s/author/%s" % (self.site_url, userid))\n-\n     def revisionHistory(self):\n         context = aq_inner(self.context)\n         if not _checkPermission(AccessPreviousVersions, context):\n'

Repository: plone.app.layout


Branch: refs/heads/2.8.x
Date: 2019-08-09T18:18:05+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/620170309f9ebe456f0e80a0b9f26ea7ccb1b3a4

Fixes #204 - Fix memory leak on getUserInfo

Files changed:
M plone/app/layout/viewlets/content.py

b'diff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex e5e23f7d..17196a8c 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -322,16 +322,17 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     @memoize\n     def getUserInfo(self, userid):\n+        actor = dict(fullname=userid)\n         mt = getToolByName(self.context, \'portal_membership\')\n         info = mt.getMemberInfo(userid)\n         if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n+            return dict(actor_home="", actor=actor)\n \n-        if not info.get("fullname", None):\n-            info["fullname"] = userid\n+        fullname = info.get("fullname", None)\n+        if fullname:\n+            actor[\'fullname\'] = fullname\n \n-        return dict(actor=info,\n+        return dict(actor=actor,\n                     actor_home="%s/author/%s" % (self.site_url, userid))\n \n     def workflowHistory(self, complete=True):\n'

Repository: plone.app.layout


Branch: refs/heads/2.8.x
Date: 2019-08-09T18:35:15+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.layout/commit/6059f75e8799e14170f55a879aa79a89d57fb1fb

Refs #204 - Update Changelog

Files changed:
M CHANGES.rst

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 86c9272b..cfbe4923 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,7 +14,7 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Memory leak on getUserInfo [avoinea] (#204)\n \n \n 2.8.3 (2018-10-31)\n'

Repository: plone.app.layout


Branch: refs/heads/2.8.x
Date: 2019-08-14T10:53:36+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.layout/commit/96321927078aec7d6b3e9b2422b8d774b037a7ee

Merge pull request #209 from avoinea/2.8.x

2.8.x - Fixes #204 - Fix memory leak on getUserInfo

Files changed:
M CHANGES.rst
M plone/app/layout/viewlets/content.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 86c9272b..cfbe4923 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,7 +14,7 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Memory leak on getUserInfo [avoinea] (#204)\n \n \n 2.8.3 (2018-10-31)\ndiff --git a/plone/app/layout/viewlets/content.py b/plone/app/layout/viewlets/content.py\nindex 9651ab2d..17196a8c 100644\n--- a/plone/app/layout/viewlets/content.py\n+++ b/plone/app/layout/viewlets/content.py\n@@ -320,6 +320,21 @@ class WorkflowHistoryViewlet(ViewletBase):\n \n     index = ViewPageTemplateFile("review_history.pt")\n \n+    @memoize\n+    def getUserInfo(self, userid):\n+        actor = dict(fullname=userid)\n+        mt = getToolByName(self.context, \'portal_membership\')\n+        info = mt.getMemberInfo(userid)\n+        if info is None:\n+            return dict(actor_home="", actor=actor)\n+\n+        fullname = info.get("fullname", None)\n+        if fullname:\n+            actor[\'fullname\'] = fullname\n+\n+        return dict(actor=actor,\n+                    actor_home="%s/author/%s" % (self.site_url, userid))\n+\n     def workflowHistory(self, complete=True):\n         """Return workflow history of this context.\n \n@@ -332,8 +347,6 @@ def workflowHistory(self, complete=True):\n             return []\n \n         workflow = getToolByName(context, \'portal_workflow\')\n-        membership = getToolByName(context, \'portal_membership\')\n-\n         review_history = []\n \n         try:\n@@ -362,14 +375,7 @@ def workflowHistory(self, complete=True):\n                     r[\'actor\'] = {\'username\': anon, \'fullname\': anon}\n                     r[\'actor_home\'] = \'\'\n                 else:\n-                    r[\'actor\'] = membership.getMemberInfo(actorid)\n-                    if r[\'actor\'] is not None:\n-                        r[\'actor_home\'] = self.navigation_root_url + \\\n-                            \'/author/\' + actorid\n-                    else:\n-                        # member info is not available\n-                        # the user was probably deleted\n-                        r[\'actor_home\'] = \'\'\n+                    r.update(self.getUserInfo(actorid))\n             review_history.reverse()\n \n         except WorkflowException:\n@@ -384,20 +390,6 @@ class ContentHistoryViewlet(WorkflowHistoryViewlet):\n \n     index = ViewPageTemplateFile("content_history.pt")\n \n-    @memoize\n-    def getUserInfo(self, userid):\n-        mt = getToolByName(self.context, \'portal_membership\')\n-        info = mt.getMemberInfo(userid)\n-        if info is None:\n-            return dict(actor_home="",\n-                        actor=dict(fullname=userid))\n-\n-        if not info.get("fullname", None):\n-            info["fullname"] = userid\n-\n-        return dict(actor=info,\n-                    actor_home="%s/author/%s" % (self.site_url, userid))\n-\n     def revisionHistory(self):\n         context = aq_inner(self.context)\n         if not _checkPermission(AccessPreviousVersions, context):\n'

