Repository: plone.restapi


Branch: refs/heads/master
Date: 2020-01-24T13:10:13+01:00
Author: Víctor Fernández de Alba (sneridagh) <sneridagh@gmail.com>
Commit: https://github.com/plone/plone.restapi/commit/eba24db81509ea977406e416efda8cf07296e0e7

Degrade gracefully when a term set in a content field does not exists in the assigned vocabulary (#860)

Files changed:
A news/856.bugfix
M src/plone/restapi/serializer/dxfields.py
M src/plone/restapi/tests/test_dxfield_serializer.py

b'diff --git a/news/856.bugfix b/news/856.bugfix\nnew file mode 100644\nindex 00000000..28bb8e16\n--- /dev/null\n+++ b/news/856.bugfix\n@@ -0,0 +1,3 @@\n+- Degrade gracefully when a term set in a content field does not exists in the assigned\n+  vocabulary\n+  [sneridagh]\ndiff --git a/src/plone/restapi/serializer/dxfields.py b/src/plone/restapi/serializer/dxfields.py\nindex cd2e09a6..62ead159 100644\n--- a/src/plone/restapi/serializer/dxfields.py\n+++ b/src/plone/restapi/serializer/dxfields.py\n@@ -15,6 +15,10 @@\n from zope.schema.interfaces import IField\n from zope.schema.interfaces import IVocabularyTokenized\n \n+import logging\n+\n+log = logging.getLogger(__name__)\n+\n \n @adapter(IField, IDexterityContent, Interface)\n @implementer(IFieldSerializer)\n@@ -66,8 +70,11 @@ def __call__(self):\n         ):\n             values = []\n             for v in value:\n-                term = value_type.vocabulary.getTerm(v)\n-                values.append({u"token": term.token, u"title": term.title})\n+                try:\n+                    term = value_type.vocabulary.getTerm(v)\n+                    values.append({u"token": term.token, u"title": term.title})\n+                except LookupError:\n+                    log.warn("Term lookup error: %r" % v)\n             value = values\n         return json_compatible(value)\n \ndiff --git a/src/plone/restapi/tests/test_dxfield_serializer.py b/src/plone/restapi/tests/test_dxfield_serializer.py\nindex 725ca752..1e3b0d5d 100644\n--- a/src/plone/restapi/tests/test_dxfield_serializer.py\n+++ b/src/plone/restapi/tests/test_dxfield_serializer.py\n@@ -151,6 +151,18 @@ def test_list_field_with_vocabulary_choice_serialization_returns_terms(self):\n             value,\n         )\n \n+    def test_list_field_with_vocabulary_choice_serialization_no_valid_term(self):\n+        value = self.serialize(\n+            "test_list_field_with_choice_with_vocabulary", [u"value3", u"value4"]\n+        )\n+        self.assertTrue(isinstance(value, list), "Not a <list>")\n+        self.assertEqual(\n+            [\n+                {u"token": u"token3", u"title": u"title3"},\n+            ],\n+            value,\n+        )\n+\n     def test_set_field_serialization_returns_list(self):\n         value = self.serialize("test_set_field", set(["a", "b", "c"]))\n         self.assertTrue(isinstance(value, list), "Not a <list>")\n'

