Repository: plone.app.imaging


Branch: refs/heads/1.0.x
Date: 2019-09-27T13:13:45+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.imaging/commit/edf824a8defcc56c0a1fcb580779048e5f19670d

Fix IOError: cannot write mode RGBA as JPEG

Files changed:
M src/plone/app/imaging/monkey.py

b"diff --git a/src/plone/app/imaging/monkey.py b/src/plone/app/imaging/monkey.py\nindex c6cb04b..2f164a8 100644\n--- a/src/plone/app/imaging/monkey.py\n+++ b/src/plone/app/imaging/monkey.py\n@@ -104,6 +104,12 @@ def scale(self, data, w, h, default_format='PNG'):\n     # for GIF, could also use image.format in ('GIF','PNG')\n     if original_mode == 'P' and img_format == 'GIF':\n         image = image.convert('P')\n+\n+    # Avoid - IOError: cannot write mode RGBA as JPEG\n+    # See https://github.com/python-pillow/Pillow/issues/2609#issuecomment-313841918\n+    if original_mode in ('CMYK', 'RGBA', 'LA') and target_format in ('JPG', 'JPEG'):\n+        target_format = 'PNG'\n+\n     thumbnail_file = StringIO()\n     # quality parameter doesn't affect lossless formats\n     image.save(thumbnail_file, target_format, quality=pil_quality, progressive=True)\n"

Repository: plone.app.imaging


Branch: refs/heads/1.0.x
Date: 2019-09-27T13:14:18+03:00
Author: Alin Voinea (avoinea) <contact@avoinea.com>
Commit: https://github.com/plone/plone.app.imaging/commit/24ae35bdd0f5bb6ea795c7a5d33504bd9b442673

Update HISTORY

Files changed:
M docs/HISTORY.txt

b'diff --git a/docs/HISTORY.txt b/docs/HISTORY.txt\nindex 2fde176..cdf0a8e 100644\n--- a/docs/HISTORY.txt\n+++ b/docs/HISTORY.txt\n@@ -14,8 +14,8 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n-\n+- Fix IOError: cannot write mode RGBA as JPEG on ImageField scale\n+  [avoinea]\n \n 1.0.13 (2016-02-24)\n -------------------\n'

Repository: plone.app.imaging


Branch: refs/heads/1.0.x
Date: 2019-09-30T09:25:45+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.imaging/commit/8a92b8ddeadf048c614fc763119b2b85d1cfa321

Merge pull request #40 from eea/1.0.x

1.0.x - Fix IOError: cannot write mode RGBA as JPEG

Files changed:
M docs/HISTORY.txt
M src/plone/app/imaging/monkey.py

b"diff --git a/docs/HISTORY.txt b/docs/HISTORY.txt\nindex 2fde176..cdf0a8e 100644\n--- a/docs/HISTORY.txt\n+++ b/docs/HISTORY.txt\n@@ -14,8 +14,8 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n-\n+- Fix IOError: cannot write mode RGBA as JPEG on ImageField scale\n+  [avoinea]\n \n 1.0.13 (2016-02-24)\n -------------------\ndiff --git a/src/plone/app/imaging/monkey.py b/src/plone/app/imaging/monkey.py\nindex c6cb04b..2f164a8 100644\n--- a/src/plone/app/imaging/monkey.py\n+++ b/src/plone/app/imaging/monkey.py\n@@ -104,6 +104,12 @@ def scale(self, data, w, h, default_format='PNG'):\n     # for GIF, could also use image.format in ('GIF','PNG')\n     if original_mode == 'P' and img_format == 'GIF':\n         image = image.convert('P')\n+\n+    # Avoid - IOError: cannot write mode RGBA as JPEG\n+    # See https://github.com/python-pillow/Pillow/issues/2609#issuecomment-313841918\n+    if original_mode in ('CMYK', 'RGBA', 'LA') and target_format in ('JPG', 'JPEG'):\n+        target_format = 'PNG'\n+\n     thumbnail_file = StringIO()\n     # quality parameter doesn't affect lossless formats\n     image.save(thumbnail_file, target_format, quality=pil_quality, progressive=True)\n"

