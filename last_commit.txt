Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2018-10-11T15:22:53-03:00
Author: Rodrigo Ferreira de Souza (rodfersou) <rodfersou@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/c9dfa2e077030527722fa43bc21a9855bc292512

Introduce IBodyClassAdapter

Files changed:
M CHANGES.rst
M plone/app/layout/globals/interfaces.py
M plone/app/layout/globals/layout.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 976c24d..2d075eb 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -10,7 +10,8 @@ Breaking changes:\n \n New features:\n \n-- *add item here*\n+- *add item here*- Allow addition of extra body classes via multiple IBodyClassAdapter adapter registrations without the need to overload the ILayoutPolicy view.\n+  [thet, jensens, agitator]\n \n Bug fixes:\n \ndiff --git a/plone/app/layout/globals/interfaces.py b/plone/app/layout/globals/interfaces.py\nindex bcdcf2f..e909f23 100644\n--- a/plone/app/layout/globals/interfaces.py\n+++ b/plone/app/layout/globals/interfaces.py\n@@ -249,3 +249,8 @@ class IViewView(Interface):\n     """Marker interface which specifies that the current view is, in fact,\n     a canonical "view" of the object, e.g. what may go on the "view" tab.\n     """\n+\n+class IBodyClassAdapter(Interface):\n+    """Adapter interface for retrieving extra body classes.\n+    """\n+\ndiff --git a/plone/app/layout/globals/layout.py b/plone/app/layout/globals/layout.py\nindex 9acb5d5..8e501e4 100644\n--- a/plone/app/layout/globals/layout.py\n+++ b/plone/app/layout/globals/layout.py\n@@ -1,5 +1,6 @@\n from AccessControl import Unauthorized\n from Acquisition import aq_base\n+from plone.app.layout.globals.interfaces import IBodyClassAdapter\n from Acquisition import aq_parent\n from plone.app.layout.globals.interfaces import ILayoutPolicy\n from plone.app.layout.globals.interfaces import IViewView\n@@ -13,12 +14,15 @@\n from Products.Five.browser.metaconfigure import ViewMixinForTemplates\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from zope.browserpage.viewpagetemplatefile import ViewPageTemplateFile as ZopeViewPageTemplateFile\n+from zope.component import adapter\n+from zope.component import getAdapters\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.component import queryMultiAdapter\n from zope.component import queryUtility\n from zope.interface import alsoProvides\n from zope.interface import implements\n+from zope.interface import Interface\n from zope.publisher.browser import BrowserView\n \n \n@@ -194,4 +198,29 @@ def bodyClass(self, template, view):\n             for role in user.getRolesInContext(self.context):\n                 body_class += \' userrole-\' + role.lower().replace(\' \', \'-\')\n \n+        # Add externally defined extra body classes\n+        body_class_adapters = getAdapters(\n+            (self.context, self.request),\n+            IBodyClassAdapter\n+        )\n+        for name, body_class_adapter in body_class_adapters:\n+            extra_classes = body_class_adapter.get_classes() or []\n+            if isinstance(extra_classes, basestring):\n+                extra_classes = extra_classes.split(\' \')\n+            body_class += \' \' + \' \'.join(extra_classes)\n+\n         return body_class\n+\n+\n+@adapter(Interface)\n+class DefaultBodyClasses(object):\n+\n+    implements(IBodyClassAdapter)\n+\n+    def __init__(self, context, request):\n+        self.context = context\n+        self.request = request\n+    def get_classes(self):\n+        """Default body classes adapter.\n+        """\n+        return []\n'

Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2018-10-11T15:22:53-03:00
Author: Rodrigo Ferreira de Souza (rodfersou) <rodfersou@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/dc3cc444f226fa10ce330882edf91077c33c3fee

Add template and view arguments support to IBodyClassAdapters

Files changed:
M CHANGES.rst
M plone/app/layout/globals/layout.py

b"diff --git a/CHANGES.rst b/CHANGES.rst\nindex 2d075eb..d22a9a1 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -15,7 +15,8 @@ New features:\n \n Bug fixes:\n \n-- *add item here*\n+- Add template and view arguments support to IBodyClassAdapters (fixes `#158 <https://github.com/plone/plone.app.layout/issues/158>`_).\n+  [rodfersou]\n \n \n 2.3.18 (2018-04-24)\ndiff --git a/plone/app/layout/globals/layout.py b/plone/app/layout/globals/layout.py\nindex 8e501e4..8f90ed7 100644\n--- a/plone/app/layout/globals/layout.py\n+++ b/plone/app/layout/globals/layout.py\n@@ -204,7 +204,10 @@ def bodyClass(self, template, view):\n             IBodyClassAdapter\n         )\n         for name, body_class_adapter in body_class_adapters:\n-            extra_classes = body_class_adapter.get_classes() or []\n+            try:\n+                extra_classes = body_class_adapter.get_classes(template, view) or []\n+            except TypeError:  # This adapter is implemented without arguments\n+                extra_classes = body_class_adapter.get_classes() or []\n             if isinstance(extra_classes, basestring):\n                 extra_classes = extra_classes.split(' ')\n             body_class += ' ' + ' '.join(extra_classes)\n"

Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2018-10-13T08:57:37-03:00
Author: Rodrigo Ferreira de Souza (rodfersou) <rodfersou@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/c75e508dd1ba1a77851d685793a6a1006b30340f

Code review

Files changed:
M plone/app/layout/globals/layout.py

b'diff --git a/plone/app/layout/globals/layout.py b/plone/app/layout/globals/layout.py\nindex 8f90ed7..1052105 100644\n--- a/plone/app/layout/globals/layout.py\n+++ b/plone/app/layout/globals/layout.py\n@@ -223,7 +223,8 @@ class DefaultBodyClasses(object):\n     def __init__(self, context, request):\n         self.context = context\n         self.request = request\n-    def get_classes(self):\n+\n+    def get_classes(self, template, view):\n         """Default body classes adapter.\n         """\n         return []\n'

Repository: plone.app.layout


Branch: refs/heads/2.3.x
Date: 2018-10-18T22:59:31+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/4f970c11e15da7b6c86ebdc34ba8edb42c073570

Merge pull request #165 from plone/rodfersou/158

4.3.x -  Add template and view arguments support to IBodyClassAdapters

Files changed:
M CHANGES.rst
M plone/app/layout/globals/interfaces.py
M plone/app/layout/globals/layout.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 976c24d..d22a9a1 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -10,11 +10,13 @@ Breaking changes:\n \n New features:\n \n-- *add item here*\n+- *add item here*- Allow addition of extra body classes via multiple IBodyClassAdapter adapter registrations without the need to overload the ILayoutPolicy view.\n+  [thet, jensens, agitator]\n \n Bug fixes:\n \n-- *add item here*\n+- Add template and view arguments support to IBodyClassAdapters (fixes `#158 <https://github.com/plone/plone.app.layout/issues/158>`_).\n+  [rodfersou]\n \n \n 2.3.18 (2018-04-24)\ndiff --git a/plone/app/layout/globals/interfaces.py b/plone/app/layout/globals/interfaces.py\nindex bcdcf2f..e909f23 100644\n--- a/plone/app/layout/globals/interfaces.py\n+++ b/plone/app/layout/globals/interfaces.py\n@@ -249,3 +249,8 @@ class IViewView(Interface):\n     """Marker interface which specifies that the current view is, in fact,\n     a canonical "view" of the object, e.g. what may go on the "view" tab.\n     """\n+\n+class IBodyClassAdapter(Interface):\n+    """Adapter interface for retrieving extra body classes.\n+    """\n+\ndiff --git a/plone/app/layout/globals/layout.py b/plone/app/layout/globals/layout.py\nindex 9acb5d5..1052105 100644\n--- a/plone/app/layout/globals/layout.py\n+++ b/plone/app/layout/globals/layout.py\n@@ -1,5 +1,6 @@\n from AccessControl import Unauthorized\n from Acquisition import aq_base\n+from plone.app.layout.globals.interfaces import IBodyClassAdapter\n from Acquisition import aq_parent\n from plone.app.layout.globals.interfaces import ILayoutPolicy\n from plone.app.layout.globals.interfaces import IViewView\n@@ -13,12 +14,15 @@\n from Products.Five.browser.metaconfigure import ViewMixinForTemplates\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from zope.browserpage.viewpagetemplatefile import ViewPageTemplateFile as ZopeViewPageTemplateFile\n+from zope.component import adapter\n+from zope.component import getAdapters\n from zope.component import getMultiAdapter\n from zope.component import getUtility\n from zope.component import queryMultiAdapter\n from zope.component import queryUtility\n from zope.interface import alsoProvides\n from zope.interface import implements\n+from zope.interface import Interface\n from zope.publisher.browser import BrowserView\n \n \n@@ -194,4 +198,33 @@ def bodyClass(self, template, view):\n             for role in user.getRolesInContext(self.context):\n                 body_class += \' userrole-\' + role.lower().replace(\' \', \'-\')\n \n+        # Add externally defined extra body classes\n+        body_class_adapters = getAdapters(\n+            (self.context, self.request),\n+            IBodyClassAdapter\n+        )\n+        for name, body_class_adapter in body_class_adapters:\n+            try:\n+                extra_classes = body_class_adapter.get_classes(template, view) or []\n+            except TypeError:  # This adapter is implemented without arguments\n+                extra_classes = body_class_adapter.get_classes() or []\n+            if isinstance(extra_classes, basestring):\n+                extra_classes = extra_classes.split(\' \')\n+            body_class += \' \' + \' \'.join(extra_classes)\n+\n         return body_class\n+\n+\n+@adapter(Interface)\n+class DefaultBodyClasses(object):\n+\n+    implements(IBodyClassAdapter)\n+\n+    def __init__(self, context, request):\n+        self.context = context\n+        self.request = request\n+\n+    def get_classes(self, template, view):\n+        """Default body classes adapter.\n+        """\n+        return []\n'

