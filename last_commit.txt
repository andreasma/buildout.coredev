Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-09T16:37:50+01:00
Author: Jan Mevissen (jmevissen) <mevissen@interaktiv.de>
Commit: https://github.com/plone/plone.app.upgrade/commit/92d6df725d106234709b8d161827944dd44b5790

Remove interface indexes from relation catalog

Files changed:
A news/195.bugfix
M plone/app/upgrade/v52/betas.py

b'diff --git a/news/195.bugfix b/news/195.bugfix\nnew file mode 100644\nindex 00000000..597f7f69\n--- /dev/null\n+++ b/news/195.bugfix\n@@ -0,0 +1 @@\n+Remove interface indexes from relation catalog [jmevissen]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nindex 8e7a1b01..10897d85 100644\n--- a/plone/app/upgrade/v52/betas.py\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -1,6 +1,10 @@\n # -*- coding: utf-8 -*-\n from Products.CMFCore.utils import getToolByName\n from plone.app.upgrade.utils import loadMigrationProfile\n+from zc.relation.interfaces import ICatalog\n+from zope import component\n+from zope.intid.interfaces import IntIdMissingError\n+\n \n import logging\n \n@@ -25,6 +29,26 @@ def add_exclude_from_nav_index(context):\n         catalog.manage_reindexIndex(ids=indexables)\n \n \n+def remove_interface_indexes_from_relations_catalog():\n+    """ remove unused interface indexes from relations catalog """\n+    catalog = component.queryUtility(ICatalog)\n+    indexes_to_remove = [\n+        \'from_interfaces_flattened\',\n+        \'to_interfaces_flattened\'\n+    ]\n+    for index_to_remove in indexes_to_remove:\n+        if index_to_remove in catalog._name_TO_mapping:\n+            catalog.removeValueIndex(index_to_remove)\n+\n+    for rel in catalog:\n+        catalog.unindex(rel)\n+        try:\n+            catalog.index(rel)\n+        except IntIdMissingError:\n+            logger.warn(\'Broken relation removed.\')\n+\n+\n def to52beta1(context):\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52beta1\')\n     add_exclude_from_nav_index(context)\n+    remove_interface_indexes_from_relations_catalog()\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-09T18:26:41+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/1863db355576a0e4d37f7ff6295170d096ef22c6

Merge pull request #195 from plone/remove-relation-indexes

Remove interface indexes from relation catalog

Files changed:
A news/195.bugfix
M plone/app/upgrade/v52/betas.py

b'diff --git a/news/195.bugfix b/news/195.bugfix\nnew file mode 100644\nindex 00000000..597f7f69\n--- /dev/null\n+++ b/news/195.bugfix\n@@ -0,0 +1 @@\n+Remove interface indexes from relation catalog [jmevissen]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nindex 8e7a1b01..10897d85 100644\n--- a/plone/app/upgrade/v52/betas.py\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -1,6 +1,10 @@\n # -*- coding: utf-8 -*-\n from Products.CMFCore.utils import getToolByName\n from plone.app.upgrade.utils import loadMigrationProfile\n+from zc.relation.interfaces import ICatalog\n+from zope import component\n+from zope.intid.interfaces import IntIdMissingError\n+\n \n import logging\n \n@@ -25,6 +29,26 @@ def add_exclude_from_nav_index(context):\n         catalog.manage_reindexIndex(ids=indexables)\n \n \n+def remove_interface_indexes_from_relations_catalog():\n+    """ remove unused interface indexes from relations catalog """\n+    catalog = component.queryUtility(ICatalog)\n+    indexes_to_remove = [\n+        \'from_interfaces_flattened\',\n+        \'to_interfaces_flattened\'\n+    ]\n+    for index_to_remove in indexes_to_remove:\n+        if index_to_remove in catalog._name_TO_mapping:\n+            catalog.removeValueIndex(index_to_remove)\n+\n+    for rel in catalog:\n+        catalog.unindex(rel)\n+        try:\n+            catalog.index(rel)\n+        except IntIdMissingError:\n+            logger.warn(\'Broken relation removed.\')\n+\n+\n def to52beta1(context):\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52beta1\')\n     add_exclude_from_nav_index(context)\n+    remove_interface_indexes_from_relations_catalog()\n'

