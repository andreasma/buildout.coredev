Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2019-02-21T14:48:51+01:00
Author: Katja Suess (ksuess) <k.suess@rohberg.ch>
Commit: https://github.com/plone/Products.CMFPlone/commit/8a187182b90a6358e123f8b5dd081b1ca8fb34ea

Load legacy resources like comments.js

Compile ++plone++static/plone-legacy-compiled.js with correct resource url of comments.js and others.
see https://github.com/plone/Products.CMFPlone/issues/2626

Files changed:
M Products/CMFPlone/resources/browser/cook.py
M Products/CMFPlone/tests/testResourceRegistries.py

b"diff --git a/Products/CMFPlone/resources/browser/cook.py b/Products/CMFPlone/resources/browser/cook.py\nindex 3e67ab14d..c12adf7ed 100644\n--- a/Products/CMFPlone/resources/browser/cook.py\n+++ b/Products/CMFPlone/resources/browser/cook.py\n@@ -88,7 +88,7 @@ def cookWhenChangingSettings(context, bundle=None):\n \n         if css_path:\n             for css_resource in resource.css:\n-                css_url = siteUrl + '/' + css_resource\n+                css_url = '/' + css_resource\n                 response = subrequest(css_url)\n                 if response.status == 200:\n                     logger.info('Cooking css %s', css_resource)\n@@ -107,7 +107,7 @@ def cookWhenChangingSettings(context, bundle=None):\n                     logger.warn('Could not find resource: %s' , css_resource)\n         if not resource.js or not js_path:\n             continue\n-        js_url = siteUrl + '/' + resource.js\n+        js_url = '/' + resource.js\n         response = subrequest(js_url)\n         if response.status == 200:\n             js = response.getBody()\ndiff --git a/Products/CMFPlone/tests/testResourceRegistries.py b/Products/CMFPlone/tests/testResourceRegistries.py\nindex 3a080dca2..30bcb80fc 100644\n--- a/Products/CMFPlone/tests/testResourceRegistries.py\n+++ b/Products/CMFPlone/tests/testResourceRegistries.py\n@@ -73,6 +73,17 @@ def test_cooking_resources(self):\n         )\n         self.assertTrue('body{color:blue}' in resp_css.getBody())\n \n+        resp_js = subrequest(\n+            '{0}/++plone++static/plone-legacy-compiled.js'.format(\n+                self.portal.absolute_url()\n+            )\n+        )\n+        body = resp_js.getBody()\n+        self.assertTrue(\n+            'resource: ++resource++plone.app.discussion.javascripts/comments.js'\n+            in body)\n+        self.assertFalse('Could not find resource' in body)\n+\n     def test_dont_minify_already_minified(self):\n         registry = getUtility(IRegistry)\n         bundles = registry.collectionOfInterface(IBundleRegistry,\n"

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2019-02-21T14:48:51+01:00
Author: Katja Suess (ksuess) <k.suess@rohberg.ch>
Commit: https://github.com/plone/Products.CMFPlone/commit/453fa5490e963965997218bac2dddd94f2ca9947

Change note added

Files changed:
A news/2627.bugfix

b'diff --git a/news/2627.bugfix b/news/2627.bugfix\nnew file mode 100644\nindex 000000000..cc5711813\n--- /dev/null\n+++ b/news/2627.bugfix\n@@ -0,0 +1,3 @@\n+Load legacy resources like comments.js\n+Compile ++plone++static/plone-legacy-compiled.js with correct resource url of comments.js and others, use relative path instead of site url.\n+[ksuess]\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2019-02-21T14:48:51+01:00
Author: Katja Suess (ksuess) <k.suess@rohberg.ch>
Commit: https://github.com/plone/Products.CMFPlone/commit/e055b9e6f4292c2364bfbf30d524c553779f101c

hand over relative address of resource to plone.subrequest

otherwise plone.subrequest, in case of a Plone instance not in root, builds path u'/VirtualHostBase/http/subdomain.example.com:80/VirtualHostRoot/_vh_somepath//somepath/Plone/++resource++plone.app.discussion.javascripts/comments.js' which is false.
OK is path u'/VirtualHostBase/http/subdomain.example.com:80/VirtualHostRoot/_vh_somepath//Plone/++resource++plone.app.discussion.javascripts/comments.js'

Files changed:
M Products/CMFPlone/resources/browser/cook.py

b"diff --git a/Products/CMFPlone/resources/browser/cook.py b/Products/CMFPlone/resources/browser/cook.py\nindex c12adf7ed..8d2779f95 100644\n--- a/Products/CMFPlone/resources/browser/cook.py\n+++ b/Products/CMFPlone/resources/browser/cook.py\n@@ -88,7 +88,7 @@ def cookWhenChangingSettings(context, bundle=None):\n \n         if css_path:\n             for css_resource in resource.css:\n-                css_url = '/' + css_resource\n+                css_url = css_resource\n                 response = subrequest(css_url)\n                 if response.status == 200:\n                     logger.info('Cooking css %s', css_resource)\n@@ -107,7 +107,7 @@ def cookWhenChangingSettings(context, bundle=None):\n                     logger.warn('Could not find resource: %s' , css_resource)\n         if not resource.js or not js_path:\n             continue\n-        js_url = '/' + resource.js\n+        js_url = resource.js\n         response = subrequest(js_url)\n         if response.status == 200:\n             js = response.getBody()\n"

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2019-02-27T16:15:12+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/dc4a2556a81e0e427d9ccc3d480e204e1de599b8

Merge pull request #2627 from plone/legacy-resources

Load legacy resources like comments.js

Files changed:
A news/2627.bugfix
M Products/CMFPlone/resources/browser/cook.py
M Products/CMFPlone/tests/testResourceRegistries.py

b"diff --git a/Products/CMFPlone/resources/browser/cook.py b/Products/CMFPlone/resources/browser/cook.py\nindex 3e67ab14d..8d2779f95 100644\n--- a/Products/CMFPlone/resources/browser/cook.py\n+++ b/Products/CMFPlone/resources/browser/cook.py\n@@ -88,7 +88,7 @@ def cookWhenChangingSettings(context, bundle=None):\n \n         if css_path:\n             for css_resource in resource.css:\n-                css_url = siteUrl + '/' + css_resource\n+                css_url = css_resource\n                 response = subrequest(css_url)\n                 if response.status == 200:\n                     logger.info('Cooking css %s', css_resource)\n@@ -107,7 +107,7 @@ def cookWhenChangingSettings(context, bundle=None):\n                     logger.warn('Could not find resource: %s' , css_resource)\n         if not resource.js or not js_path:\n             continue\n-        js_url = siteUrl + '/' + resource.js\n+        js_url = resource.js\n         response = subrequest(js_url)\n         if response.status == 200:\n             js = response.getBody()\ndiff --git a/Products/CMFPlone/tests/testResourceRegistries.py b/Products/CMFPlone/tests/testResourceRegistries.py\nindex 3a080dca2..30bcb80fc 100644\n--- a/Products/CMFPlone/tests/testResourceRegistries.py\n+++ b/Products/CMFPlone/tests/testResourceRegistries.py\n@@ -73,6 +73,17 @@ def test_cooking_resources(self):\n         )\n         self.assertTrue('body{color:blue}' in resp_css.getBody())\n \n+        resp_js = subrequest(\n+            '{0}/++plone++static/plone-legacy-compiled.js'.format(\n+                self.portal.absolute_url()\n+            )\n+        )\n+        body = resp_js.getBody()\n+        self.assertTrue(\n+            'resource: ++resource++plone.app.discussion.javascripts/comments.js'\n+            in body)\n+        self.assertFalse('Could not find resource' in body)\n+\n     def test_dont_minify_already_minified(self):\n         registry = getUtility(IRegistry)\n         bundles = registry.collectionOfInterface(IBundleRegistry,\ndiff --git a/news/2627.bugfix b/news/2627.bugfix\nnew file mode 100644\nindex 000000000..cc5711813\n--- /dev/null\n+++ b/news/2627.bugfix\n@@ -0,0 +1,3 @@\n+Load legacy resources like comments.js\n+Compile ++plone++static/plone-legacy-compiled.js with correct resource url of comments.js and others, use relative path instead of site url.\n+[ksuess]\n"

