Repository: Products.Archetypes


Branch: refs/heads/1.15.x
Date: 2019-01-09T13:55:05+01:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/Products.Archetypes/commit/96a4719112c3f5830251598ba1ccd3d9a6d712bf

add safe_encode instead of adding a dependency on Products.CMFPlone

Files changed:
M Products/Archetypes/utils.py
M setup.py

b'diff --git a/Products/Archetypes/utils.py b/Products/Archetypes/utils.py\nindex 9abfff3b..d3c96001 100644\n--- a/Products/Archetypes/utils.py\n+++ b/Products/Archetypes/utils.py\n@@ -1,6 +1,7 @@\n import logging\n import os\n import sys\n+import six\n from inspect import getargs, getmro\n from itertools import islice, count\n from types import ClassType, MethodType\n@@ -249,7 +250,7 @@ class DisplayList:\n     """Static display lists, can look up on\n     either side of the dict, and get them in sorted order\n \n-    NOTE: Both keys and values *must* contain unique entries! You can *not* \n+    NOTE: Both keys and values *must* contain unique entries! You can *not*\n     have the same value twice. This is a "feature" not a bug. DisplayLists\n     are meant to be used as a list inside html form entry like a drop down.\n \n@@ -899,3 +900,11 @@ def isFactoryContained(obj):\n         return False\n     meta_type = getattr(aq_base(parent), \'meta_type\', \'\')\n     return meta_type == \'TempFolder\'\n+\n+\n+def safe_encode(value, encoding=\'utf-8\'):\n+    """Convert text to bytes of the specified encoding.\n+    """\n+    if isinstance(value, six.text_type):\n+        value = value.encode(encoding)\n+    return value\ndiff --git a/setup.py b/setup.py\nindex eb8d5360..d66aa1ca 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -71,6 +71,7 @@\n           \'transaction\',\n           \'ZODB3\',\n           \'Zope2 >= 2.13.1\',\n-          \'plone.app.widgets>=2.0.0.dev0\'\n+          \'plone.app.widgets>=2.0.0.dev0\',\n+          \'six\'\n       ],\n       )\n'

Repository: Products.Archetypes


Branch: refs/heads/1.15.x
Date: 2019-01-09T14:01:02+01:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/Products.Archetypes/commit/075d42c9551c53ce0201b282ce417b73acad6806

Fix UnicodeEncodeError on textarea widget

Files changed:
A news/122.bugfix
M Products/Archetypes/Widget.py

b"diff --git a/Products/Archetypes/Widget.py b/Products/Archetypes/Widget.py\nindex c63cc863..05d5b731 100644\n--- a/Products/Archetypes/Widget.py\n+++ b/Products/Archetypes/Widget.py\n@@ -10,13 +10,14 @@\n from Products.CMFCore.Expression import Expression\n from Products.CMFCore.Expression import createExprContext\n \n-from Products.Archetypes.Registry import registerWidget\n-from Products.Archetypes.utils import className\n-from Products.Archetypes.utils import unique\n-from Products.Archetypes.utils import capitalize\n from Products.Archetypes.generator import macrowidget\n from Products.Archetypes.log import log\n from Products.Archetypes.Registry import registerPropertyType\n+from Products.Archetypes.Registry import registerWidget\n+from Products.Archetypes.utils import capitalize\n+from Products.Archetypes.utils import className\n+from Products.Archetypes.utils import safe_encode\n+from Products.Archetypes.utils import unique\n \n from ExtensionClass import Base\n from App.class_init import InitializeClass\n@@ -1471,8 +1472,8 @@ def edit(self, context, field, request):\n \n             # Render the combined widget\n             rendered = '{}\\n{}'.format(\n-                textarea_widget.render(),\n-                etree.tostring(mt_select)\n+                safe_encode(textarea_widget.render()),\n+                safe_encode(etree.tostring(mt_select))\n             )\n         return rendered\n \ndiff --git a/news/122.bugfix b/news/122.bugfix\nnew file mode 100644\nindex 00000000..8619cf76\n--- /dev/null\n+++ b/news/122.bugfix\n@@ -0,0 +1,2 @@\n+Fix UnicodeEncodeError on textarea widget.\n+[agitator]\n\\ No newline at end of file\n"

Repository: Products.Archetypes


Branch: refs/heads/1.15.x
Date: 2019-01-09T15:02:32+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.Archetypes/commit/aa5a909b4762ae3b25c7a617328007d79d793e8f

Merge pull request #123 from plone/fix-UnicodeEncodeError

Fix unicode encode error

Files changed:
A news/122.bugfix
M Products/Archetypes/Widget.py
M Products/Archetypes/utils.py
M setup.py

b'diff --git a/Products/Archetypes/Widget.py b/Products/Archetypes/Widget.py\nindex c63cc863..05d5b731 100644\n--- a/Products/Archetypes/Widget.py\n+++ b/Products/Archetypes/Widget.py\n@@ -10,13 +10,14 @@\n from Products.CMFCore.Expression import Expression\n from Products.CMFCore.Expression import createExprContext\n \n-from Products.Archetypes.Registry import registerWidget\n-from Products.Archetypes.utils import className\n-from Products.Archetypes.utils import unique\n-from Products.Archetypes.utils import capitalize\n from Products.Archetypes.generator import macrowidget\n from Products.Archetypes.log import log\n from Products.Archetypes.Registry import registerPropertyType\n+from Products.Archetypes.Registry import registerWidget\n+from Products.Archetypes.utils import capitalize\n+from Products.Archetypes.utils import className\n+from Products.Archetypes.utils import safe_encode\n+from Products.Archetypes.utils import unique\n \n from ExtensionClass import Base\n from App.class_init import InitializeClass\n@@ -1471,8 +1472,8 @@ def edit(self, context, field, request):\n \n             # Render the combined widget\n             rendered = \'{}\\n{}\'.format(\n-                textarea_widget.render(),\n-                etree.tostring(mt_select)\n+                safe_encode(textarea_widget.render()),\n+                safe_encode(etree.tostring(mt_select))\n             )\n         return rendered\n \ndiff --git a/Products/Archetypes/utils.py b/Products/Archetypes/utils.py\nindex 9abfff3b..d3c96001 100644\n--- a/Products/Archetypes/utils.py\n+++ b/Products/Archetypes/utils.py\n@@ -1,6 +1,7 @@\n import logging\n import os\n import sys\n+import six\n from inspect import getargs, getmro\n from itertools import islice, count\n from types import ClassType, MethodType\n@@ -249,7 +250,7 @@ class DisplayList:\n     """Static display lists, can look up on\n     either side of the dict, and get them in sorted order\n \n-    NOTE: Both keys and values *must* contain unique entries! You can *not* \n+    NOTE: Both keys and values *must* contain unique entries! You can *not*\n     have the same value twice. This is a "feature" not a bug. DisplayLists\n     are meant to be used as a list inside html form entry like a drop down.\n \n@@ -899,3 +900,11 @@ def isFactoryContained(obj):\n         return False\n     meta_type = getattr(aq_base(parent), \'meta_type\', \'\')\n     return meta_type == \'TempFolder\'\n+\n+\n+def safe_encode(value, encoding=\'utf-8\'):\n+    """Convert text to bytes of the specified encoding.\n+    """\n+    if isinstance(value, six.text_type):\n+        value = value.encode(encoding)\n+    return value\ndiff --git a/news/122.bugfix b/news/122.bugfix\nnew file mode 100644\nindex 00000000..8619cf76\n--- /dev/null\n+++ b/news/122.bugfix\n@@ -0,0 +1,2 @@\n+Fix UnicodeEncodeError on textarea widget.\n+[agitator]\n\\ No newline at end of file\ndiff --git a/setup.py b/setup.py\nindex eb8d5360..d66aa1ca 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -71,6 +71,7 @@\n           \'transaction\',\n           \'ZODB3\',\n           \'Zope2 >= 2.13.1\',\n-          \'plone.app.widgets>=2.0.0.dev0\'\n+          \'plone.app.widgets>=2.0.0.dev0\',\n+          \'six\'\n       ],\n       )\n'

