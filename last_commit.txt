Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-03-14T10:09:09+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/09b20e033412815780b0fa95fac7aa7ff2ebe7ff

fix changing bucket size while reindexing relation catalog

Files changed:
A news/201.bugfix
M plone/app/upgrade/v52/betas.py

b'diff --git a/news/201.bugfix b/news/201.bugfix\nnew file mode 100644\nindex 00000000..e9ce582f\n--- /dev/null\n+++ b/news/201.bugfix\n@@ -0,0 +1,2 @@\n+Fix changing bucket size while reindexing relation catalog.\n+[jensens]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nindex 5fee3e74..c2a56e75 100644\n--- a/plone/app/upgrade/v52/betas.py\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -62,7 +62,13 @@ def remove_interface_indexes_from_relations_catalog():\n         if index_to_remove in catalog._name_TO_mapping:\n             catalog.removeValueIndex(index_to_remove)\n \n-    for rel in catalog:\n+    # Avoid RuntimeError: the bucket being iterated changed size by first\n+    # getting all relations. This might need lots of RAM on large databases\n+    relations = [rel for rel in catalog]\n+\n+    # get rid of broken relations, where inid no longer exists\n+    # those broken need to be removed for a later zodbupdate\n+    for rel in relations:\n         catalog.unindex(rel)\n         try:\n             catalog.index(rel)\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-03-14T15:30:46+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/2064759d8aef085eea60ad5d1cbdff9a22cd1e35

Merge pull request #201 from plone/fix-reindexing-relationcatalog

fix changing bucket size while reindexing relation catalog

Files changed:
A news/201.bugfix
M plone/app/upgrade/v52/betas.py

b'diff --git a/news/201.bugfix b/news/201.bugfix\nnew file mode 100644\nindex 00000000..e9ce582f\n--- /dev/null\n+++ b/news/201.bugfix\n@@ -0,0 +1,2 @@\n+Fix changing bucket size while reindexing relation catalog.\n+[jensens]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nindex 5fee3e74..c2a56e75 100644\n--- a/plone/app/upgrade/v52/betas.py\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -62,7 +62,13 @@ def remove_interface_indexes_from_relations_catalog():\n         if index_to_remove in catalog._name_TO_mapping:\n             catalog.removeValueIndex(index_to_remove)\n \n-    for rel in catalog:\n+    # Avoid RuntimeError: the bucket being iterated changed size by first\n+    # getting all relations. This might need lots of RAM on large databases\n+    relations = [rel for rel in catalog]\n+\n+    # get rid of broken relations, where inid no longer exists\n+    # those broken need to be removed for a later zodbupdate\n+    for rel in relations:\n         catalog.unindex(rel)\n         try:\n             catalog.index(rel)\n'

