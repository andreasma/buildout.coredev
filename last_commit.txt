Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-09-06T18:21:00+02:00
Author: Sune Broendum Woeller (sunew) <sune@woeller.dk>
Commit: https://github.com/plone/plone.app.upgrade/commit/6bab181c2ad6b35ccdf56dce46c0ee0bd541ca4c

remove the jquery-highlightsearchterms resource, and the - now empty - plone_ecmascript skin layer. See https://github.com/plone/Products.CMFPlone/pull/1963/commits and https://github.com/plone/Products.CMFPlone/issues/1811 https://github.com/plone/Products.CMFPlone/issues/1801

removing records (wip)

remove jquery-highlightsearchterms from the plone-legacy bundle

c

Files changed:
A plone/app/upgrade/v52/profiles/to_alpha1/registry.xml
M CHANGES.rst
M plone/app/upgrade/v52/alphas.py
M plone/app/upgrade/v52/profiles/to_alpha1/skins.xml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex a2d6039e..52b6a681 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -13,6 +13,9 @@ New features:\n - Add upgrade steps for Datatbles on Plone 5.1.4\n   [frapell]\n \n+- Add upgrade step removing the jquery-highlightsearchterms resource\n+  and the plone_ecmascript skin layer, on Plone 5.2\n+\n Bug fixes:\n \n - *add item here*\ndiff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py\nindex 774a4b9d..972ee8a7 100644\n--- a/plone/app/upgrade/v52/alphas.py\n+++ b/plone/app/upgrade/v52/alphas.py\n@@ -1,7 +1,9 @@\n # -*- coding: utf-8 -*-\n from plone.app.upgrade.utils import cleanUpSkinsTool\n from plone.app.upgrade.utils import loadMigrationProfile\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n+from zope.component import getUtility\n \n import logging\n \n@@ -13,3 +15,9 @@ def to52alpha1(context):\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52alpha1\')\n     portal = getToolByName(context, \'portal_url\').getPortalObject()\n     cleanUpSkinsTool(portal)\n+\n+    registry = getUtility(IRegistry)\n+    record = \'plone.bundles/plone-legacy.resources\'\n+    resources = registry.records[record]\n+    if u\'jquery-highlightsearchterms\' in resources.value:\n+        resources.value.remove(u\'jquery-highlightsearchterms\')\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml b/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml\nnew file mode 100644\nindex 00000000..7a2f4c07\n--- /dev/null\n+++ b/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml\n@@ -0,0 +1,24 @@\n+<?xml version="1.0"?>\n+<registry>\n+\n+\n+  <records prefix="plone.resources/jquery-highlightsearchterms"\n+           interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'\n+           remove="True">\n+  </records>\n+\n+  <!-- Update ``last_compilation`` to deliver new bundles -->\n+  <records\n+      prefix="plone.bundles/plone"\n+      interface="Products.CMFPlone.interfaces.IBundleRegistry"\n+      purge="False">\n+    <value key="last_compilation">2018-09-06 00:00:00</value>\n+  </records>\n+  <records\n+      prefix="plone.bundles/plone-logged-in"\n+      interface="Products.CMFPlone.interfaces.IBundleRegistry"\n+      purge="False">\n+    <value key="last_compilation">2018-09-06 00:00:00</value>\n+  </records>\n+\n+</registry>\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/skins.xml b/plone/app/upgrade/v52/profiles/to_alpha1/skins.xml\nindex c0d3ddf6..12509b31 100644\n--- a/plone/app/upgrade/v52/profiles/to_alpha1/skins.xml\n+++ b/plone/app/upgrade/v52/profiles/to_alpha1/skins.xml\n@@ -8,4 +8,12 @@\n   <skin-path name="*">\n     <layer name="plone_login" remove="True"/>\n   </skin-path>\n+  <object\n+      name="plone_ecmascript"\n+      meta_type="Filesystem Directory View"\n+      directory="Products.CMFPlone:skins/plone_ecmascript"\n+      remove="True"/>\n+  <skin-path name="*">\n+    <layer name="plone_ecmascript" remove="True"/>\n+  </skin-path>\n </object>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-09-06T20:23:08+02:00
Author: Sune Broendum Woeller (sunew) <sune@woeller.dk>
Commit: https://github.com/plone/plone.app.upgrade/commit/c979968ea4122e496a0fcd368dbd01dbea443d69

Also remove the jquery-highlightsearchterms resource, and the plone_ecmascript skin layer for plone 5.1.4

Files changed:
A plone/app/upgrade/v51/profiles/to_514/skins.xml
M CHANGES.rst
M plone/app/upgrade/v51/configure.zcml
M plone/app/upgrade/v51/final.py
M plone/app/upgrade/v51/profiles/to_514/registry.xml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 52b6a681..45c9b7e6 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,7 +14,7 @@ New features:\n   [frapell]\n \n - Add upgrade step removing the jquery-highlightsearchterms resource\n-  and the plone_ecmascript skin layer, on Plone 5.2\n+  and the plone_ecmascript skin layer, on Plone 5.2 and 5.1.4\n \n Bug fixes:\n \ndiff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml\nindex a56c241f..113678a9 100644\n--- a/plone/app/upgrade/v51/configure.zcml\n+++ b/plone/app/upgrade/v51/configure.zcml\n@@ -265,7 +265,7 @@ Add image scaling options to image handling control panel.\n         <gs:upgradeStep\n             title="Miscellaneous"\n             description=""\n-            handler="..utils.null_upgrade_step"\n+            handler=".final.remove_highlightsearchterms"\n             />\n \n     </gs:upgradeSteps>\ndiff --git a/plone/app/upgrade/v51/final.py b/plone/app/upgrade/v51/final.py\nindex c6e9a498..8960caea 100644\n--- a/plone/app/upgrade/v51/final.py\n+++ b/plone/app/upgrade/v51/final.py\n@@ -1,6 +1,9 @@\n # -*- coding: utf-8 -*-\n+from plone.app.upgrade.utils import cleanUpSkinsTool\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from zExceptions import BadRequest\n+from zope.component import getUtility\n \n import logging\n \n@@ -38,3 +41,14 @@ def fix_i18n_domain(context):\n                 \'Action object/%s does not have an i18n_domain property\',\n                 action_id,\n             )\n+\n+\n+def remove_highlightsearchterms(context):\n+    portal = getToolByName(context, \'portal_url\').getPortalObject()\n+    cleanUpSkinsTool(portal)\n+\n+    registry = getUtility(IRegistry)\n+    record = \'plone.bundles/plone-legacy.resources\'\n+    resources = registry.records[record]\n+    if u\'jquery-highlightsearchterms\' in resources.value:\n+        resources.value.remove(u\'jquery-highlightsearchterms\')\ndiff --git a/plone/app/upgrade/v51/profiles/to_514/registry.xml b/plone/app/upgrade/v51/profiles/to_514/registry.xml\nindex 83ad3c05..1b660148 100644\n--- a/plone/app/upgrade/v51/profiles/to_514/registry.xml\n+++ b/plone/app/upgrade/v51/profiles/to_514/registry.xml\n@@ -105,18 +105,23 @@\n       <value key="js">++plone++static/components/datatables.net-select/js/dataTables.select.min.js</value>\n   </records>\n \n+  <records prefix="plone.resources/jquery-highlightsearchterms"\n+           interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'\n+           remove="True">\n+  </records>\n+\n   <!-- Update ``last_compilation`` to deliver new bundles -->\n   <records\n       prefix="plone.bundles/plone"\n       interface="Products.CMFPlone.interfaces.IBundleRegistry"\n       purge="False">\n-    <value key="last_compilation">2018-07-10 00:00:00</value>\n+    <value key="last_compilation">2018-09-06 00:00:00</value>\n   </records>\n   <records\n       prefix="plone.bundles/plone-logged-in"\n       interface="Products.CMFPlone.interfaces.IBundleRegistry"\n       purge="False">\n-    <value key="last_compilation">2018-07-10 00:00:00</value>\n+    <value key="last_compilation">2018-09-06 00:00:00</value>\n   </records>\n \n </registry>\ndiff --git a/plone/app/upgrade/v51/profiles/to_514/skins.xml b/plone/app/upgrade/v51/profiles/to_514/skins.xml\nnew file mode 100644\nindex 00000000..3e7c38da\n--- /dev/null\n+++ b/plone/app/upgrade/v51/profiles/to_514/skins.xml\n@@ -0,0 +1,11 @@\n+<?xml version="1.0"?>\n+<object name="portal_skins">\n+  <object\n+      name="plone_ecmascript"\n+      meta_type="Filesystem Directory View"\n+      directory="Products.CMFPlone:skins/plone_ecmascript"\n+      remove="True"/>\n+  <skin-path name="*">\n+    <layer name="plone_ecmascript" remove="True"/>\n+  </skin-path>\n+</object>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-09-08T12:26:59+02:00
Author: Sune Broendum Woeller (sunew) <sune@woeller.dk>
Commit: https://github.com/plone/plone.app.upgrade/commit/0c1c1ee77c3492da2d3bb74b65e0d6e714c6133c

Update the compilation date of the plone-legacy bundle, to force recompilation

Files changed:
M plone/app/upgrade/v51/profiles/to_514/registry.xml
M plone/app/upgrade/v52/profiles/to_alpha1/registry.xml

b'diff --git a/plone/app/upgrade/v51/profiles/to_514/registry.xml b/plone/app/upgrade/v51/profiles/to_514/registry.xml\nindex 1b660148..ef3704aa 100644\n--- a/plone/app/upgrade/v51/profiles/to_514/registry.xml\n+++ b/plone/app/upgrade/v51/profiles/to_514/registry.xml\n@@ -124,4 +124,10 @@\n     <value key="last_compilation">2018-09-06 00:00:00</value>\n   </records>\n \n+  <!-- Update legacy bundle -->\n+  <records prefix="plone.bundles/plone-legacy"\n+            interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n+    <value key="last_compilation"></value>\n+  </records>\n+\n </registry>\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml b/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml\nindex 7a2f4c07..6582f962 100644\n--- a/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml\n+++ b/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml\n@@ -7,18 +7,10 @@\n            remove="True">\n   </records>\n \n-  <!-- Update ``last_compilation`` to deliver new bundles -->\n-  <records\n-      prefix="plone.bundles/plone"\n-      interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      purge="False">\n-    <value key="last_compilation">2018-09-06 00:00:00</value>\n-  </records>\n-  <records\n-      prefix="plone.bundles/plone-logged-in"\n-      interface="Products.CMFPlone.interfaces.IBundleRegistry"\n-      purge="False">\n-    <value key="last_compilation">2018-09-06 00:00:00</value>\n+  <!-- Update legacy bundle -->\n+  <records prefix="plone.bundles/plone-legacy"\n+            interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n+    <value key="last_compilation"></value>\n   </records>\n \n </registry>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2018-09-09T08:41:13+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/8d8f25df6bc28121d99bae26d852de5f546853cb

Merge pull request #170 from plone/remove-highlightsearchterms

Remove jquery-highlightsearchterms and plone_ecmascript layer

Files changed:
A plone/app/upgrade/v51/profiles/to_514/skins.xml
A plone/app/upgrade/v52/profiles/to_alpha1/registry.xml
M CHANGES.rst
M plone/app/upgrade/v51/configure.zcml
M plone/app/upgrade/v51/final.py
M plone/app/upgrade/v51/profiles/to_514/registry.xml
M plone/app/upgrade/v52/alphas.py
M plone/app/upgrade/v52/profiles/to_alpha1/skins.xml

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex a2d6039e..45c9b7e6 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -13,6 +13,9 @@ New features:\n - Add upgrade steps for Datatbles on Plone 5.1.4\n   [frapell]\n \n+- Add upgrade step removing the jquery-highlightsearchterms resource\n+  and the plone_ecmascript skin layer, on Plone 5.2 and 5.1.4\n+\n Bug fixes:\n \n - *add item here*\ndiff --git a/plone/app/upgrade/v51/configure.zcml b/plone/app/upgrade/v51/configure.zcml\nindex a56c241f..113678a9 100644\n--- a/plone/app/upgrade/v51/configure.zcml\n+++ b/plone/app/upgrade/v51/configure.zcml\n@@ -265,7 +265,7 @@ Add image scaling options to image handling control panel.\n         <gs:upgradeStep\n             title="Miscellaneous"\n             description=""\n-            handler="..utils.null_upgrade_step"\n+            handler=".final.remove_highlightsearchterms"\n             />\n \n     </gs:upgradeSteps>\ndiff --git a/plone/app/upgrade/v51/final.py b/plone/app/upgrade/v51/final.py\nindex c6e9a498..8960caea 100644\n--- a/plone/app/upgrade/v51/final.py\n+++ b/plone/app/upgrade/v51/final.py\n@@ -1,6 +1,9 @@\n # -*- coding: utf-8 -*-\n+from plone.app.upgrade.utils import cleanUpSkinsTool\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n from zExceptions import BadRequest\n+from zope.component import getUtility\n \n import logging\n \n@@ -38,3 +41,14 @@ def fix_i18n_domain(context):\n                 \'Action object/%s does not have an i18n_domain property\',\n                 action_id,\n             )\n+\n+\n+def remove_highlightsearchterms(context):\n+    portal = getToolByName(context, \'portal_url\').getPortalObject()\n+    cleanUpSkinsTool(portal)\n+\n+    registry = getUtility(IRegistry)\n+    record = \'plone.bundles/plone-legacy.resources\'\n+    resources = registry.records[record]\n+    if u\'jquery-highlightsearchterms\' in resources.value:\n+        resources.value.remove(u\'jquery-highlightsearchterms\')\ndiff --git a/plone/app/upgrade/v51/profiles/to_514/registry.xml b/plone/app/upgrade/v51/profiles/to_514/registry.xml\nindex 83ad3c05..ef3704aa 100644\n--- a/plone/app/upgrade/v51/profiles/to_514/registry.xml\n+++ b/plone/app/upgrade/v51/profiles/to_514/registry.xml\n@@ -105,18 +105,29 @@\n       <value key="js">++plone++static/components/datatables.net-select/js/dataTables.select.min.js</value>\n   </records>\n \n+  <records prefix="plone.resources/jquery-highlightsearchterms"\n+           interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'\n+           remove="True">\n+  </records>\n+\n   <!-- Update ``last_compilation`` to deliver new bundles -->\n   <records\n       prefix="plone.bundles/plone"\n       interface="Products.CMFPlone.interfaces.IBundleRegistry"\n       purge="False">\n-    <value key="last_compilation">2018-07-10 00:00:00</value>\n+    <value key="last_compilation">2018-09-06 00:00:00</value>\n   </records>\n   <records\n       prefix="plone.bundles/plone-logged-in"\n       interface="Products.CMFPlone.interfaces.IBundleRegistry"\n       purge="False">\n-    <value key="last_compilation">2018-07-10 00:00:00</value>\n+    <value key="last_compilation">2018-09-06 00:00:00</value>\n+  </records>\n+\n+  <!-- Update legacy bundle -->\n+  <records prefix="plone.bundles/plone-legacy"\n+            interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n+    <value key="last_compilation"></value>\n   </records>\n \n </registry>\ndiff --git a/plone/app/upgrade/v51/profiles/to_514/skins.xml b/plone/app/upgrade/v51/profiles/to_514/skins.xml\nnew file mode 100644\nindex 00000000..3e7c38da\n--- /dev/null\n+++ b/plone/app/upgrade/v51/profiles/to_514/skins.xml\n@@ -0,0 +1,11 @@\n+<?xml version="1.0"?>\n+<object name="portal_skins">\n+  <object\n+      name="plone_ecmascript"\n+      meta_type="Filesystem Directory View"\n+      directory="Products.CMFPlone:skins/plone_ecmascript"\n+      remove="True"/>\n+  <skin-path name="*">\n+    <layer name="plone_ecmascript" remove="True"/>\n+  </skin-path>\n+</object>\ndiff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py\nindex 774a4b9d..972ee8a7 100644\n--- a/plone/app/upgrade/v52/alphas.py\n+++ b/plone/app/upgrade/v52/alphas.py\n@@ -1,7 +1,9 @@\n # -*- coding: utf-8 -*-\n from plone.app.upgrade.utils import cleanUpSkinsTool\n from plone.app.upgrade.utils import loadMigrationProfile\n+from plone.registry.interfaces import IRegistry\n from Products.CMFCore.utils import getToolByName\n+from zope.component import getUtility\n \n import logging\n \n@@ -13,3 +15,9 @@ def to52alpha1(context):\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52alpha1\')\n     portal = getToolByName(context, \'portal_url\').getPortalObject()\n     cleanUpSkinsTool(portal)\n+\n+    registry = getUtility(IRegistry)\n+    record = \'plone.bundles/plone-legacy.resources\'\n+    resources = registry.records[record]\n+    if u\'jquery-highlightsearchterms\' in resources.value:\n+        resources.value.remove(u\'jquery-highlightsearchterms\')\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml b/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml\nnew file mode 100644\nindex 00000000..6582f962\n--- /dev/null\n+++ b/plone/app/upgrade/v52/profiles/to_alpha1/registry.xml\n@@ -0,0 +1,16 @@\n+<?xml version="1.0"?>\n+<registry>\n+\n+\n+  <records prefix="plone.resources/jquery-highlightsearchterms"\n+           interface=\'Products.CMFPlone.interfaces.IResourceRegistry\'\n+           remove="True">\n+  </records>\n+\n+  <!-- Update legacy bundle -->\n+  <records prefix="plone.bundles/plone-legacy"\n+            interface=\'Products.CMFPlone.interfaces.IBundleRegistry\'>\n+    <value key="last_compilation"></value>\n+  </records>\n+\n+</registry>\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/skins.xml b/plone/app/upgrade/v52/profiles/to_alpha1/skins.xml\nindex c0d3ddf6..12509b31 100644\n--- a/plone/app/upgrade/v52/profiles/to_alpha1/skins.xml\n+++ b/plone/app/upgrade/v52/profiles/to_alpha1/skins.xml\n@@ -8,4 +8,12 @@\n   <skin-path name="*">\n     <layer name="plone_login" remove="True"/>\n   </skin-path>\n+  <object\n+      name="plone_ecmascript"\n+      meta_type="Filesystem Directory View"\n+      directory="Products.CMFPlone:skins/plone_ecmascript"\n+      remove="True"/>\n+  <skin-path name="*">\n+    <layer name="plone_ecmascript" remove="True"/>\n+  </skin-path>\n </object>\n'

