Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-05T11:36:15+01:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/7565c7b4fcb968ca2d0ff9f4dcf3651de489cd55

Add exclude_from_nav index for new navigation

Files changed:
M plone/app/upgrade/v52/alphas.py

b'diff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py\nindex 4aa8bd0c..fdf52cfe 100644\n--- a/plone/app/upgrade/v52/alphas.py\n+++ b/plone/app/upgrade/v52/alphas.py\n@@ -16,7 +16,7 @@ def cleanup_resources():\n     registry = getUtility(IRegistry)\n     record = \'plone.bundles/plone-legacy.resources\'\n     resources = registry.records[record]\n-    \n+\n     if u\'jquery-highlightsearchterms\' in resources.value:\n         resources.value.remove(u\'jquery-highlightsearchterms\')\n \n@@ -29,6 +29,23 @@ def migrate_gopipindex(context):\n     manage_addGopipIndex(catalog, \'getObjPositionInParent\')\n \n \n+def add_exclude_from_nav_index(context):\n+    """Add exclude_from_nav index to the portal_catalog.\n+    """\n+    name = \'exclude_from_nav\'\n+    meta_type = \'BooleanIndex\'\n+    catalog = getToolByName(context, \'portal_catalog\')\n+    indexes = catalog.indexes()\n+    indexables = []\n+    if \'name\' not in indexes:\n+        catalog.addIndex(name, meta_type)\n+        indexables.append(name)\n+        logger.info(\'Added %s for field %s.\', meta_type, name)\n+    if len(indexables) > 0:\n+        logger.info(\'Indexing new indexes %s.\', \', \'.join(indexables))\n+        catalog.manage_reindexIndex(ids=indexables)\n+\n+\n def to52alpha1(context):\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52alpha1\')\n     portal = getToolByName(context, \'portal_url\').getPortalObject()\n@@ -36,3 +53,4 @@ def to52alpha1(context):\n \n     cleanup_resources()\n     migrate_gopipindex(context)\n+    add_exclude_from_nav_index(context)\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-05T11:36:15+01:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/bf51f773f0b4204147d98cf88ff9e8c681308121

add registry key for navigation_depth

Files changed:
A plone/app/upgrade/v52/profiles/to_alpha2/.gitkeep
A plone/app/upgrade/v52/profiles/to_alpha2/registry.xml
M plone/app/upgrade/v52/alphas.py
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/profiles.zcml

b'diff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py\nindex fdf52cfe..987fe215 100644\n--- a/plone/app/upgrade/v52/alphas.py\n+++ b/plone/app/upgrade/v52/alphas.py\n@@ -54,3 +54,7 @@ def to52alpha1(context):\n     cleanup_resources()\n     migrate_gopipindex(context)\n     add_exclude_from_nav_index(context)\n+\n+\n+def to52alpha2(context):\n+    loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52alpha2\')\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex 29ac7245..d544a6b0 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -17,6 +17,12 @@\n            handler=".alphas.to52alpha1"\n            />\n \n+      <gs:upgradeStep\n+           title="Run to52alpha2 upgrade profile."\n+           description=""\n+           handler=".alphas.to52alpha2"\n+           />\n+\n     </gs:upgradeSteps>\n \n \ndiff --git a/plone/app/upgrade/v52/profiles.zcml b/plone/app/upgrade/v52/profiles.zcml\nindex 93c6f7f6..5d260dec 100644\n--- a/plone/app/upgrade/v52/profiles.zcml\n+++ b/plone/app/upgrade/v52/profiles.zcml\n@@ -12,4 +12,13 @@\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n+  <genericsetup:registerProfile\n+      name="to52alpha2"\n+      title="Upgrade profile for Plone 5.1.x to Plone 5.2alpha2"\n+      description=""\n+      directory="profiles/to_alpha2"\n+      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+\n </configure>\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha2/.gitkeep b/plone/app/upgrade/v52/profiles/to_alpha2/.gitkeep\nnew file mode 100644\nindex 00000000..e69de29b\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha2/registry.xml b/plone/app/upgrade/v52/profiles/to_alpha2/registry.xml\nnew file mode 100644\nindex 00000000..b8cbce22\n--- /dev/null\n+++ b/plone/app/upgrade/v52/profiles/to_alpha2/registry.xml\n@@ -0,0 +1,7 @@\n+<?xml version="1.0"?>\n+<registry>\n+\n+  <records interface="Products.CMFPlone.interfaces.controlpanel.INavigationSchema" prefix="plone" purge="False">\n+    <value key="navigation_depth">1</value>\n+  </records>\n+</registry>\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-05T18:19:13+01:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/0c9f328fff340728cf00a47b9db58c865d324a5d

move add_exclude_from_nav_index migration step to betas

Files changed:
A plone/app/upgrade/v52/betas.py
A plone/app/upgrade/v52/profiles/to_beta1/registry.xml
A plone/app/upgrade/v52/profiles/to_beta1/repositorytool.xml
M plone/app/upgrade/v52/alphas.py
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/profiles.zcml
D plone/app/upgrade/v52/profiles/to_alpha1/.gitkeep
D plone/app/upgrade/v52/profiles/to_alpha1/repositorytool.xml
D plone/app/upgrade/v52/profiles/to_alpha2/.gitkeep
D plone/app/upgrade/v52/profiles/to_alpha2/registry.xml

b'diff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py\nindex 987fe215..39e66e81 100644\n--- a/plone/app/upgrade/v52/alphas.py\n+++ b/plone/app/upgrade/v52/alphas.py\n@@ -29,23 +29,6 @@ def migrate_gopipindex(context):\n     manage_addGopipIndex(catalog, \'getObjPositionInParent\')\n \n \n-def add_exclude_from_nav_index(context):\n-    """Add exclude_from_nav index to the portal_catalog.\n-    """\n-    name = \'exclude_from_nav\'\n-    meta_type = \'BooleanIndex\'\n-    catalog = getToolByName(context, \'portal_catalog\')\n-    indexes = catalog.indexes()\n-    indexables = []\n-    if \'name\' not in indexes:\n-        catalog.addIndex(name, meta_type)\n-        indexables.append(name)\n-        logger.info(\'Added %s for field %s.\', meta_type, name)\n-    if len(indexables) > 0:\n-        logger.info(\'Indexing new indexes %s.\', \', \'.join(indexables))\n-        catalog.manage_reindexIndex(ids=indexables)\n-\n-\n def to52alpha1(context):\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52alpha1\')\n     portal = getToolByName(context, \'portal_url\').getPortalObject()\n@@ -53,7 +36,6 @@ def to52alpha1(context):\n \n     cleanup_resources()\n     migrate_gopipindex(context)\n-    add_exclude_from_nav_index(context)\n \n \n def to52alpha2(context):\ndiff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nnew file mode 100644\nindex 00000000..882f7928\n--- /dev/null\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -0,0 +1,30 @@\n+# -*- coding: utf-8 -*-\n+from Products.CMFCore.utils import getToolByName\n+from plone.app.upgrade.utils import loadMigrationProfile\n+\n+import logging\n+\n+\n+logger = logging.getLogger(\'plone.app.upgrade\')\n+\n+\n+def add_exclude_from_nav_index(context):\n+    """Add exclude_from_nav index to the portal_catalog.\n+    """\n+    name = \'exclude_from_nav\'\n+    meta_type = \'BooleanIndex\'\n+    catalog = getToolByName(context, \'portal_catalog\')\n+    indexes = catalog.indexes()\n+    indexables = []\n+    if \'name\' not in indexes:\n+        catalog.addIndex(name, meta_type)\n+        indexables.append(name)\n+        logger.info(\'Added %s for field %s.\', meta_type, name)\n+    if len(indexables) > 0:\n+        logger.info(\'Indexing new indexes %s.\', \', \'.join(indexables))\n+        catalog.manage_reindexIndex(ids=indexables)\n+\n+\n+def to52beta1(context):\n+    loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52beta1\')\n+    add_exclude_from_nav_index(context)\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex d544a6b0..f49f558f 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -25,7 +25,6 @@\n \n     </gs:upgradeSteps>\n \n-\n     <gs:upgradeSteps\n         source="5200"\n         destination="5201"\n@@ -39,4 +38,17 @@\n \n     </gs:upgradeSteps>\n \n+    <gs:upgradeSteps\n+        source="5201"\n+        destination="5202"\n+        profile="Products.CMFPlone:plone">\n+\n+      <gs:upgradeStep\n+           title="Run to52beta1 upgrade profile."\n+           description=""\n+           handler=".betas.to52beta1"\n+           />\n+\n+    </gs:upgradeSteps>\n+\n </configure>\ndiff --git a/plone/app/upgrade/v52/profiles.zcml b/plone/app/upgrade/v52/profiles.zcml\nindex 5d260dec..7726c8e2 100644\n--- a/plone/app/upgrade/v52/profiles.zcml\n+++ b/plone/app/upgrade/v52/profiles.zcml\n@@ -13,10 +13,10 @@\n       />\n \n   <genericsetup:registerProfile\n-      name="to52alpha2"\n-      title="Upgrade profile for Plone 5.1.x to Plone 5.2alpha2"\n+      name="to52beta1"\n+      title="Upgrade profile for Plone 5.2alpha2 to Plone 5.2beta1"\n       description=""\n-      directory="profiles/to_alpha2"\n+      directory="profiles/to_beta1"\n       for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/.gitkeep b/plone/app/upgrade/v52/profiles/to_alpha1/.gitkeep\ndeleted file mode 100644\nindex e69de29b..00000000\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha2/.gitkeep b/plone/app/upgrade/v52/profiles/to_alpha2/.gitkeep\ndeleted file mode 100644\nindex e69de29b..00000000\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha2/registry.xml b/plone/app/upgrade/v52/profiles/to_beta1/registry.xml\nsimilarity index 99%\nrename from plone/app/upgrade/v52/profiles/to_alpha2/registry.xml\nrename to plone/app/upgrade/v52/profiles/to_beta1/registry.xml\nindex b8cbce22..569419e0 100644\n--- a/plone/app/upgrade/v52/profiles/to_alpha2/registry.xml\n+++ b/plone/app/upgrade/v52/profiles/to_beta1/registry.xml\n@@ -4,4 +4,5 @@\n   <records interface="Products.CMFPlone.interfaces.controlpanel.INavigationSchema" prefix="plone" purge="False">\n     <value key="navigation_depth">1</value>\n   </records>\n+\n </registry>\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/repositorytool.xml b/plone/app/upgrade/v52/profiles/to_beta1/repositorytool.xml\nsimilarity index 100%\nrename from plone/app/upgrade/v52/profiles/to_alpha1/repositorytool.xml\nrename to plone/app/upgrade/v52/profiles/to_beta1/repositorytool.xml\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-05T19:41:47+01:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/3256c47414016be46996c1944ae3935d2beb334b

remove to52alpha2

Files changed:
M plone/app/upgrade/v52/alphas.py
M plone/app/upgrade/v52/configure.zcml

b'diff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py\nindex 39e66e81..9d530ae5 100644\n--- a/plone/app/upgrade/v52/alphas.py\n+++ b/plone/app/upgrade/v52/alphas.py\n@@ -36,7 +36,3 @@ def to52alpha1(context):\n \n     cleanup_resources()\n     migrate_gopipindex(context)\n-\n-\n-def to52alpha2(context):\n-    loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52alpha2\')\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex f49f558f..09880bfa 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -17,12 +17,6 @@\n            handler=".alphas.to52alpha1"\n            />\n \n-      <gs:upgradeStep\n-           title="Run to52alpha2 upgrade profile."\n-           description=""\n-           handler=".alphas.to52alpha2"\n-           />\n-\n     </gs:upgradeSteps>\n \n     <gs:upgradeSteps\n'

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-05T20:56:07+01:00
Author: Peter Holzer (agitator) <peter.holzer@agitator.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/9f35d35354398133d3237a05e5711f8a47214e6f

fix upgrade step

Files changed:
M plone/app/upgrade/v52/betas.py

b"diff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nindex 882f7928..8e7a1b01 100644\n--- a/plone/app/upgrade/v52/betas.py\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -16,7 +16,7 @@ def add_exclude_from_nav_index(context):\n     catalog = getToolByName(context, 'portal_catalog')\n     indexes = catalog.indexes()\n     indexables = []\n-    if 'name' not in indexes:\n+    if name not in indexes:\n         catalog.addIndex(name, meta_type)\n         indexables.append(name)\n         logger.info('Added %s for field %s.', meta_type, name)\n"

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-06T11:21:49+01:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.upgrade/commit/acefa135fa2f3cc87c4073aea978fbca5997a52b

Merge pull request #185 from plone/plip-2516-navigation

Plip 2516 navigation

Files changed:
A plone/app/upgrade/v52/betas.py
A plone/app/upgrade/v52/profiles/to_beta1/registry.xml
A plone/app/upgrade/v52/profiles/to_beta1/repositorytool.xml
M plone/app/upgrade/v52/alphas.py
M plone/app/upgrade/v52/configure.zcml
M plone/app/upgrade/v52/profiles.zcml
D plone/app/upgrade/v52/profiles/to_alpha1/.gitkeep
D plone/app/upgrade/v52/profiles/to_alpha1/repositorytool.xml

b'diff --git a/plone/app/upgrade/v52/alphas.py b/plone/app/upgrade/v52/alphas.py\nindex 4aa8bd0c..9d530ae5 100644\n--- a/plone/app/upgrade/v52/alphas.py\n+++ b/plone/app/upgrade/v52/alphas.py\n@@ -16,7 +16,7 @@ def cleanup_resources():\n     registry = getUtility(IRegistry)\n     record = \'plone.bundles/plone-legacy.resources\'\n     resources = registry.records[record]\n-    \n+\n     if u\'jquery-highlightsearchterms\' in resources.value:\n         resources.value.remove(u\'jquery-highlightsearchterms\')\n \ndiff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nnew file mode 100644\nindex 00000000..8e7a1b01\n--- /dev/null\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -0,0 +1,30 @@\n+# -*- coding: utf-8 -*-\n+from Products.CMFCore.utils import getToolByName\n+from plone.app.upgrade.utils import loadMigrationProfile\n+\n+import logging\n+\n+\n+logger = logging.getLogger(\'plone.app.upgrade\')\n+\n+\n+def add_exclude_from_nav_index(context):\n+    """Add exclude_from_nav index to the portal_catalog.\n+    """\n+    name = \'exclude_from_nav\'\n+    meta_type = \'BooleanIndex\'\n+    catalog = getToolByName(context, \'portal_catalog\')\n+    indexes = catalog.indexes()\n+    indexables = []\n+    if name not in indexes:\n+        catalog.addIndex(name, meta_type)\n+        indexables.append(name)\n+        logger.info(\'Added %s for field %s.\', meta_type, name)\n+    if len(indexables) > 0:\n+        logger.info(\'Indexing new indexes %s.\', \', \'.join(indexables))\n+        catalog.manage_reindexIndex(ids=indexables)\n+\n+\n+def to52beta1(context):\n+    loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52beta1\')\n+    add_exclude_from_nav_index(context)\ndiff --git a/plone/app/upgrade/v52/configure.zcml b/plone/app/upgrade/v52/configure.zcml\nindex 29ac7245..09880bfa 100644\n--- a/plone/app/upgrade/v52/configure.zcml\n+++ b/plone/app/upgrade/v52/configure.zcml\n@@ -19,7 +19,6 @@\n \n     </gs:upgradeSteps>\n \n-\n     <gs:upgradeSteps\n         source="5200"\n         destination="5201"\n@@ -33,4 +32,17 @@\n \n     </gs:upgradeSteps>\n \n+    <gs:upgradeSteps\n+        source="5201"\n+        destination="5202"\n+        profile="Products.CMFPlone:plone">\n+\n+      <gs:upgradeStep\n+           title="Run to52beta1 upgrade profile."\n+           description=""\n+           handler=".betas.to52beta1"\n+           />\n+\n+    </gs:upgradeSteps>\n+\n </configure>\ndiff --git a/plone/app/upgrade/v52/profiles.zcml b/plone/app/upgrade/v52/profiles.zcml\nindex 93c6f7f6..7726c8e2 100644\n--- a/plone/app/upgrade/v52/profiles.zcml\n+++ b/plone/app/upgrade/v52/profiles.zcml\n@@ -12,4 +12,13 @@\n       provides="Products.GenericSetup.interfaces.EXTENSION"\n       />\n \n+  <genericsetup:registerProfile\n+      name="to52beta1"\n+      title="Upgrade profile for Plone 5.2alpha2 to Plone 5.2beta1"\n+      description=""\n+      directory="profiles/to_beta1"\n+      for="Products.CMFPlone.interfaces.IMigratingPloneSiteRoot"\n+      provides="Products.GenericSetup.interfaces.EXTENSION"\n+      />\n+\n </configure>\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/.gitkeep b/plone/app/upgrade/v52/profiles/to_alpha1/.gitkeep\ndeleted file mode 100644\nindex e69de29b..00000000\ndiff --git a/plone/app/upgrade/v52/profiles/to_beta1/registry.xml b/plone/app/upgrade/v52/profiles/to_beta1/registry.xml\nnew file mode 100644\nindex 00000000..569419e0\n--- /dev/null\n+++ b/plone/app/upgrade/v52/profiles/to_beta1/registry.xml\n@@ -0,0 +1,8 @@\n+<?xml version="1.0"?>\n+<registry>\n+\n+  <records interface="Products.CMFPlone.interfaces.controlpanel.INavigationSchema" prefix="plone" purge="False">\n+    <value key="navigation_depth">1</value>\n+  </records>\n+\n+</registry>\ndiff --git a/plone/app/upgrade/v52/profiles/to_alpha1/repositorytool.xml b/plone/app/upgrade/v52/profiles/to_beta1/repositorytool.xml\nsimilarity index 100%\nrename from plone/app/upgrade/v52/profiles/to_alpha1/repositorytool.xml\nrename to plone/app/upgrade/v52/profiles/to_beta1/repositorytool.xml\n'

