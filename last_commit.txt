Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2020-01-07T14:36:03+01:00
Author: ale-rt (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/0bbf94eb66e940c8ffc09a23bb48cd98e8e28fb6

Fix redirect issues

Redirect (when possible) also ajax requests and do not return an unuseful body

Fixes #3014

Files changed:
A news/3014.bugfix
M Products/CMFPlone/browser/exceptions.py
M Products/CMFPlone/browser/templates/error_message.pt

b'diff --git a/Products/CMFPlone/browser/exceptions.py b/Products/CMFPlone/browser/exceptions.py\nindex 7a1a712f6c..8ee7944bf2 100644\n--- a/Products/CMFPlone/browser/exceptions.py\n+++ b/Products/CMFPlone/browser/exceptions.py\n@@ -1,8 +1,10 @@\n # -*- coding: utf-8 -*-\n from AccessControl import getSecurityManager\n+from plone.memoize.view import memoize\n from Products.Five import BrowserView\n from Products.Five.browser.pagetemplatefile import ViewPageTemplateFile\n from zExceptions.ExceptionFormatter import format_exception\n+from zope.component import getMultiAdapter\n \n import json\n import sys\n@@ -15,12 +17,24 @@ def is_manager(self):\n         return getSecurityManager().checkPermission(\n             \'Manage portal\', self.context)\n \n+    @property\n+    @memoize\n+    def plone_redirector_view(self):\n+        return getMultiAdapter(\n+            (self.__parent__, self.request), name="plone_redirector_view"\n+        )\n+\n     def __call__(self):\n         exception = self.context\n+        error_type = exception.__class__.__name__\n+        if error_type == "NotFound" and self.plone_redirector_view.attempt_redirect():\n+            # if a redirect is possible attempt_redirect returns True\n+            # and sets the proper location header\n+            return\n+\n         self.context = self.__parent__\n         request = self.request\n \n-        error_type = exception.__class__.__name__\n         exc_type, value, traceback = sys.exc_info()\n         error_tb = \'\'.join(\n             format_exception(exc_type, value, traceback, as_html=False))\ndiff --git a/Products/CMFPlone/browser/templates/error_message.pt b/Products/CMFPlone/browser/templates/error_message.pt\nindex d1d7be29b3..f68a5d4774 100644\n--- a/Products/CMFPlone/browser/templates/error_message.pt\n+++ b/Products/CMFPlone/browser/templates/error_message.pt\n@@ -14,11 +14,7 @@\n \n         <metal:notfound tal:condition="python:err_type == \'NotFound\'">\n \n-            <tal:redirect define="redirection_view context/@@plone_redirector_view">\n-\n-                <tal:redirect define="redirect_success redirection_view/attempt_redirect|nothing" replace="nothing">\n-                    If the attempt succeeds, we won\'t see any more of this template\n-                </tal:redirect>\n+            <tal:redirect define="redirection_view nocall:view/@@plone_redirector_view">\n \n                 <h1 class="documentFirstHeading"\n                     i18n:translate="heading_site_there_seems_to_be_an_error">\ndiff --git a/news/3014.bugfix b/news/3014.bugfix\nnew file mode 100644\nindex 0000000000..64f4a3c0ba\n--- /dev/null\n+++ b/news/3014.bugfix\n@@ -0,0 +1,2 @@\n+Fix a bunch of redirect issues, in particular redirect also ajax requests\n+[ale-rt]\n'

