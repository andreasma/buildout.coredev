Repository: plone.app.layout


Branch: refs/heads/2.8.x
Date: 2019-08-18T00:02:19+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/plone.app.layout/commit/0928428397121465a5d5f3f924e7cb9e0cb9431d

Fixed test in combination with newer CMFCore.

Files changed:
M CHANGES.rst
M plone/app/layout/sitemap/tests/test_sitemap.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex cfbe4923..1eca28bb 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,6 +14,8 @@ New features:\n \n Bug fixes:\n \n+- Fixed test in combination with newer CMFCore.  [maurits]\n+\n - Memory leak on getUserInfo [avoinea] (#204)\n \n \ndiff --git a/plone/app/layout/sitemap/tests/test_sitemap.py b/plone/app/layout/sitemap/tests/test_sitemap.py\nindex 41d038b2..c61bb066 100644\n--- a/plone/app/layout/sitemap/tests/test_sitemap.py\n+++ b/plone/app/layout/sitemap/tests/test_sitemap.py\n@@ -234,10 +234,15 @@ def test_default_pages(self):\n             default, \'review_state\'))\n         self.assertTrue(self.portal.plone_utils.isDefaultPage(default))\n \n-        default.modification_date = DateTime("2001-01-01")\n-        folder.modification_date = DateTime("2000-01-01")\n         self.portal.portal_catalog.reindexObject(folder)\n         self.portal.portal_catalog.reindexObject(default)\n+        default.modification_date = DateTime("2001-01-01")\n+        folder.modification_date = DateTime("2000-01-01")\n+        # Note: the modification date is overwritten when you call reindexObject,\n+        # which is totally not what we want.  So call it with the relevant index.\n+        # This avoids the overwriting.\n+        self.portal.portal_catalog.reindexObject(folder, idxs=[\'modified\'])\n+        self.portal.portal_catalog.reindexObject(default, idxs=[\'modified\'])\n         self.portal.default_page = "published"\n         self.portal.portal_catalog.reindexObject(self.portal.published)\n         self.logout()\n@@ -247,5 +252,6 @@ def test_default_pages(self):\n             \'<loc>http://nohost/plone/folder/default</loc>\' in xml)\n         self.assertTrue(\'<loc>http://nohost/plone/folder</loc>\' in xml)\n         self.assertTrue(\'<lastmod>2001-01-01T\' in xml)\n+        self.assertFalse(\'<lastmod>2000-01-01T\' in xml)\n         self.assertTrue(\'<loc>http://nohost/plone</loc>\' in xml)\n         self.assertFalse(\'<loc>http://nohost/plone/published</loc>\' in xml)\n'

Repository: plone.app.layout


Branch: refs/heads/2.8.x
Date: 2019-08-19T09:06:47+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.layout/commit/ccc88a644adf8878b1d3b31dbf145c84cebe1f04

Merge pull request #212 from plone/maurits-improve-sitemap-test-28

Fixed test in combination with newer CMFCore.

Files changed:
M CHANGES.rst
M plone/app/layout/sitemap/tests/test_sitemap.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex cfbe4923..1eca28bb 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -14,6 +14,8 @@ New features:\n \n Bug fixes:\n \n+- Fixed test in combination with newer CMFCore.  [maurits]\n+\n - Memory leak on getUserInfo [avoinea] (#204)\n \n \ndiff --git a/plone/app/layout/sitemap/tests/test_sitemap.py b/plone/app/layout/sitemap/tests/test_sitemap.py\nindex 41d038b2..c61bb066 100644\n--- a/plone/app/layout/sitemap/tests/test_sitemap.py\n+++ b/plone/app/layout/sitemap/tests/test_sitemap.py\n@@ -234,10 +234,15 @@ def test_default_pages(self):\n             default, \'review_state\'))\n         self.assertTrue(self.portal.plone_utils.isDefaultPage(default))\n \n-        default.modification_date = DateTime("2001-01-01")\n-        folder.modification_date = DateTime("2000-01-01")\n         self.portal.portal_catalog.reindexObject(folder)\n         self.portal.portal_catalog.reindexObject(default)\n+        default.modification_date = DateTime("2001-01-01")\n+        folder.modification_date = DateTime("2000-01-01")\n+        # Note: the modification date is overwritten when you call reindexObject,\n+        # which is totally not what we want.  So call it with the relevant index.\n+        # This avoids the overwriting.\n+        self.portal.portal_catalog.reindexObject(folder, idxs=[\'modified\'])\n+        self.portal.portal_catalog.reindexObject(default, idxs=[\'modified\'])\n         self.portal.default_page = "published"\n         self.portal.portal_catalog.reindexObject(self.portal.published)\n         self.logout()\n@@ -247,5 +252,6 @@ def test_default_pages(self):\n             \'<loc>http://nohost/plone/folder/default</loc>\' in xml)\n         self.assertTrue(\'<loc>http://nohost/plone/folder</loc>\' in xml)\n         self.assertTrue(\'<lastmod>2001-01-01T\' in xml)\n+        self.assertFalse(\'<lastmod>2000-01-01T\' in xml)\n         self.assertTrue(\'<loc>http://nohost/plone</loc>\' in xml)\n         self.assertFalse(\'<loc>http://nohost/plone/published</loc>\' in xml)\n'

