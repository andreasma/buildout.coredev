Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2018-12-12T12:19:15+01:00
Author: Andrea Cecchi (cekk) <andrea.cecchi85@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/c38f66dcf37acbe83d6540a5e79b0adbeb38e43e

avoid saving when select a different type

Files changed:
M CHANGES.rst
M Products/CMFPlone/controlpanel/browser/types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 2470171eb..d383a475b 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -29,7 +29,8 @@ Bug fixes:\n - Modernize robot keywords that use "Get Element Attribute" [ale-rt] (#2615)\n - Fix metabundle resource ordering to pay attention to depends setting\n   [vangheem] (#2641)\n-\n+- Do not save type settings in "content-controlpanel" when switching between types.\n+  [cekk]\n \n Changelog\n =========\ndiff --git a/Products/CMFPlone/controlpanel/browser/types.py b/Products/CMFPlone/controlpanel/browser/types.py\nindex fc73fdefd..bc248e75a 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.py\n+++ b/Products/CMFPlone/controlpanel/browser/types.py\n@@ -122,7 +122,7 @@ def __call__(self):\n         cancel_button = form.get(\'form.button.Cancel\', None) is not None\n         type_id = form.get(\'old_type_id\', None)\n \n-        if submitted and not cancel_button:\n+        if save_button and submitted and not cancel_button:\n             if type_id:\n                 portal_types = getToolByName(self.context, \'portal_types\')\n                 portal_repository = getToolByName(self.context,\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\nindex 71c9eaa66..067ccdd93 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n@@ -110,7 +110,7 @@ def test_disable_versioning_removes_behavior(self):\n         self.browser.getControl(name=\'type_id\').value = [\'Document\']\n         self.browser.getForm(action=self.types_url).submit()\n         self.browser.getControl(name=\'versionpolicy\').value = [\'off\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n@@ -123,7 +123,7 @@ def test_enable_versioning_behavior_on_document(self):\n         self.browser.getControl(name=\'type_id\').value = [\'Document\']\n         self.browser.getForm(action=self.types_url).submit()\n         self.browser.getControl(name=\'versionpolicy\').value = [\'off\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n@@ -132,7 +132,7 @@ def test_enable_versioning_behavior_on_document(self):\n             not in doc_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         self.assertTrue(\n             \'plone.app.versioningbehavior.behaviors.IVersionable\'\n@@ -165,3 +165,33 @@ def test_enable_versioning_behavior_on_file(self):\n         self.assertTrue(\n             \'plone.app.lockingbehavior.behaviors.ILocking\'\n             in file_type.behaviors)\n+\n+    def test_dont_update_settings_when_switch_types(self):\n+        # First of all, set a default\n+        self.browser.open(self.types_url)\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\n+            \'Redirect immediately to link target\'\n+        ).selected = True\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Then switch the type\n+        self.browser.getControl(name=\'type_id\').value = [\'Document\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.assertFalse(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+\n+        # Go back to the link, and check the value\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+\n+        self.assertTrue(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.assertEquals(\n+            self.browser.getControl(\n+                \'Redirect immediately to link target\').selected,\n+            True\n+        )\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2018-12-13T09:35:36+01:00
Author: Andrea Cecchi (cekk) <andrea.cecchi85@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/6e8eab3c89eea06167a5557b9cbb21413bc04187

fix test

Files changed:
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py

b"diff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\nindex 067ccdd93..649a988f4 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n@@ -157,7 +157,7 @@ def test_enable_versioning_behavior_on_file(self):\n             not in file_type.behaviors)  # noqa\n \n         self.browser.getControl(name='versionpolicy').value = ['manual']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl('Save').click()\n \n         self.assertTrue(\n             'plone.app.versioningbehavior.behaviors.IVersionable'\n"

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2018-12-18T16:39:16+01:00
Author: Andrea Cecchi (cekk) <andrea.cecchi85@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/5acd03b3d03eee7e610b0fc01e89a9d2136344d6

fix logic on save

Files changed:
M Products/CMFPlone/controlpanel/browser/types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py

b"diff --git a/Products/CMFPlone/controlpanel/browser/types.py b/Products/CMFPlone/controlpanel/browser/types.py\nindex bc248e75a..6d802ce22 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.py\n+++ b/Products/CMFPlone/controlpanel/browser/types.py\n@@ -200,9 +200,9 @@ def __call__(self):\n                 elif not default_page_type and type_id in default_page_types:\n                     default_page_types.remove(type_id)\n                 types_settings.default_page_types = default_page_types\n-\n-                redirect_links = form.get('redirect_links', False)\n-                types_settings.redirect_links = redirect_links\n+                if type_id == 'Link':\n+                    redirect_links = form.get('redirect_links', False)\n+                    types_settings.redirect_links = redirect_links\n \n             # Update workflow\n             if self.have_new_workflow() \\\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\nindex 649a988f4..85b91ac00 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n@@ -195,3 +195,34 @@ def test_dont_update_settings_when_switch_types(self):\n                 'Redirect immediately to link target').selected,\n             True\n         )\n+\n+    def test_dont_update_redirect_links_when_not_in_link_settings(self):\n+        # First of all, set a default\n+        self.browser.open(self.types_url)\n+        self.browser.getControl(name='type_id').value = ['Link']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\n+            'Redirect immediately to link target'\n+        ).selected = True\n+        self.browser.getControl('Save').click()\n+\n+        # Then switch the type\n+        self.browser.getControl(name='type_id').value = ['Document']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.assertFalse(\n+            'Redirect immediately to link target' in self.browser.contents\n+        )\n+        self.browser.getControl('Save').click()\n+\n+        # Go back to the link, and check the value\n+        self.browser.getControl(name='type_id').value = ['Link']\n+        self.browser.getForm(action=self.types_url).submit()\n+\n+        self.assertTrue(\n+            'Redirect immediately to link target' in self.browser.contents\n+        )\n+        self.assertEquals(\n+            self.browser.getControl(\n+                'Redirect immediately to link target').selected,\n+            True\n+        )\n"

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2018-12-19T01:31:48+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/Products.CMFPlone/commit/b0648a675283230523ab2c134c9367455c5c7c0c

Merge pull request #2663 from plone/cekk_fix_content_controlpanel

Do not save type settings in "content-controlpanel" when switching between types.

Files changed:
M CHANGES.rst
M Products/CMFPlone/controlpanel/browser/types.py
M Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 2470171eb..d383a475b 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -29,7 +29,8 @@ Bug fixes:\n - Modernize robot keywords that use "Get Element Attribute" [ale-rt] (#2615)\n - Fix metabundle resource ordering to pay attention to depends setting\n   [vangheem] (#2641)\n-\n+- Do not save type settings in "content-controlpanel" when switching between types.\n+  [cekk]\n \n Changelog\n =========\ndiff --git a/Products/CMFPlone/controlpanel/browser/types.py b/Products/CMFPlone/controlpanel/browser/types.py\nindex fc73fdefd..6d802ce22 100644\n--- a/Products/CMFPlone/controlpanel/browser/types.py\n+++ b/Products/CMFPlone/controlpanel/browser/types.py\n@@ -122,7 +122,7 @@ def __call__(self):\n         cancel_button = form.get(\'form.button.Cancel\', None) is not None\n         type_id = form.get(\'old_type_id\', None)\n \n-        if submitted and not cancel_button:\n+        if save_button and submitted and not cancel_button:\n             if type_id:\n                 portal_types = getToolByName(self.context, \'portal_types\')\n                 portal_repository = getToolByName(self.context,\n@@ -200,9 +200,9 @@ def __call__(self):\n                 elif not default_page_type and type_id in default_page_types:\n                     default_page_types.remove(type_id)\n                 types_settings.default_page_types = default_page_types\n-\n-                redirect_links = form.get(\'redirect_links\', False)\n-                types_settings.redirect_links = redirect_links\n+                if type_id == \'Link\':\n+                    redirect_links = form.get(\'redirect_links\', False)\n+                    types_settings.redirect_links = redirect_links\n \n             # Update workflow\n             if self.have_new_workflow() \\\ndiff --git a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\nindex 71c9eaa66..85b91ac00 100644\n--- a/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n+++ b/Products/CMFPlone/controlpanel/tests/test_controlpanel_browser_types.py\n@@ -110,7 +110,7 @@ def test_disable_versioning_removes_behavior(self):\n         self.browser.getControl(name=\'type_id\').value = [\'Document\']\n         self.browser.getForm(action=self.types_url).submit()\n         self.browser.getControl(name=\'versionpolicy\').value = [\'off\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n@@ -123,7 +123,7 @@ def test_enable_versioning_behavior_on_document(self):\n         self.browser.getControl(name=\'type_id\').value = [\'Document\']\n         self.browser.getForm(action=self.types_url).submit()\n         self.browser.getControl(name=\'versionpolicy\').value = [\'off\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         portal_types = self.portal.portal_types\n         doc_type = portal_types.Document\n@@ -132,7 +132,7 @@ def test_enable_versioning_behavior_on_document(self):\n             not in doc_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(name="form.button.Save").click()\n \n         self.assertTrue(\n             \'plone.app.versioningbehavior.behaviors.IVersionable\'\n@@ -157,7 +157,7 @@ def test_enable_versioning_behavior_on_file(self):\n             not in file_type.behaviors)  # noqa\n \n         self.browser.getControl(name=\'versionpolicy\').value = [\'manual\']\n-        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\'Save\').click()\n \n         self.assertTrue(\n             \'plone.app.versioningbehavior.behaviors.IVersionable\'\n@@ -165,3 +165,64 @@ def test_enable_versioning_behavior_on_file(self):\n         self.assertTrue(\n             \'plone.app.lockingbehavior.behaviors.ILocking\'\n             in file_type.behaviors)\n+\n+    def test_dont_update_settings_when_switch_types(self):\n+        # First of all, set a default\n+        self.browser.open(self.types_url)\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\n+            \'Redirect immediately to link target\'\n+        ).selected = True\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Then switch the type\n+        self.browser.getControl(name=\'type_id\').value = [\'Document\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.assertFalse(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+\n+        # Go back to the link, and check the value\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+\n+        self.assertTrue(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.assertEquals(\n+            self.browser.getControl(\n+                \'Redirect immediately to link target\').selected,\n+            True\n+        )\n+\n+    def test_dont_update_redirect_links_when_not_in_link_settings(self):\n+        # First of all, set a default\n+        self.browser.open(self.types_url)\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.browser.getControl(\n+            \'Redirect immediately to link target\'\n+        ).selected = True\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Then switch the type\n+        self.browser.getControl(name=\'type_id\').value = [\'Document\']\n+        self.browser.getForm(action=self.types_url).submit()\n+        self.assertFalse(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.browser.getControl(\'Save\').click()\n+\n+        # Go back to the link, and check the value\n+        self.browser.getControl(name=\'type_id\').value = [\'Link\']\n+        self.browser.getForm(action=self.types_url).submit()\n+\n+        self.assertTrue(\n+            \'Redirect immediately to link target\' in self.browser.contents\n+        )\n+        self.assertEquals(\n+            self.browser.getControl(\n+                \'Redirect immediately to link target\').selected,\n+            True\n+        )\n'

