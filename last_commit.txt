Repository: plone.supermodel


Branch: refs/heads/master
Date: 2020-02-12T15:52:10+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.supermodel/commit/16765d36094c500a3e4b5b6d5276e80d3aa06efb

fixes #34: zope.interface 4.7 support

Files changed:
A news/34.feature
M plone/supermodel/directives.py
M plone/supermodel/utils.py

b'diff --git a/news/34.feature b/news/34.feature\nnew file mode 100644\nindex 0000000..b22bb9a\n--- /dev/null\n+++ b/news/34.feature\n@@ -0,0 +1 @@\n+Support for zope.interface 4.7+ [jensens]\n\\ No newline at end of file\ndiff --git a/plone/supermodel/directives.py b/plone/supermodel/directives.py\nindex 77cda7a..02b57cc 100644\n--- a/plone/supermodel/directives.py\n+++ b/plone/supermodel/directives.py\n@@ -12,6 +12,7 @@\n from zope.component import adapter\n from zope.interface import alsoProvides\n from zope.interface import implementer\n+from zope.interface.interface import Element\n from zope.interface.interface import TAGGED_DATA\n \n import os.path\n@@ -71,7 +72,7 @@ class CheckerPlugin(object):\n \n     def __init__(self, schema):\n         self.schema = schema\n-        self.value = schema.queryTaggedValue(self.key, None)\n+        self.value = Element.queryTaggedValue(schema, self.key, default=None)\n \n     def fieldNames(self):\n         raise NotImplementedError()\n@@ -148,10 +149,18 @@ def __init__(self, interface):\n \n     def __call__(self):\n         interface = self.interface\n-        filename = interface.queryTaggedValue(FILENAME_KEY, None)\n+        filename = Element.queryTaggedValue(\n+            interface,\n+            FILENAME_KEY,\n+            default=None,\n+        )\n         if filename is None:\n             return\n-        schema = interface.queryTaggedValue(SCHEMA_NAME_KEY, u\'\')\n+        schema = Element.queryTaggedValue(\n+            interface,\n+            SCHEMA_NAME_KEY,\n+            default=u\'\',\n+        )\n \n         moduleName = interface.__module__\n         module = sys.modules.get(moduleName, None)\ndiff --git a/plone/supermodel/utils.py b/plone/supermodel/utils.py\nindex 78f4119..a797bdf 100644\n--- a/plone/supermodel/utils.py\n+++ b/plone/supermodel/utils.py\n@@ -1,4 +1,5 @@\n # -*- coding: utf-8 -*-\n+from collections import OrderedDict\n from lxml import etree\n from plone.supermodel.debug import parseinfo\n from plone.supermodel.interfaces import I18N_NAMESPACE\n@@ -8,6 +9,7 @@\n from zope.i18nmessageid import Message\n from zope.interface import directlyProvidedBy\n from zope.interface import directlyProvides\n+from zope.interface.interface import Element\n from zope.schema.interfaces import IChoice\n from zope.schema.interfaces import ICollection\n from zope.schema.interfaces import IDict\n@@ -21,12 +23,6 @@\n import sys\n \n \n-try:\n-    from collections import OrderedDict\n-except ImportError:\n-    from zope.schema.vocabulary import OrderedDict  # <py27\n-\n-\n _marker = object()\n noNS_re = re.compile(\'^{\\S+}\')\n \n@@ -269,7 +265,7 @@ def mergedTaggedValueDict(schema, name):\n     """\n     tv = {}\n     for iface in reversed(schema.__iro__):\n-        tv.update(iface.queryTaggedValue(name, {}))\n+        tv.update(Element.queryTaggedValue(iface, name, default={}))\n     return tv\n \n \n@@ -281,7 +277,7 @@ def mergedTaggedValueList(schema, name):\n     """\n     tv = []\n     for iface in reversed(schema.__iro__):\n-        tv.extend(iface.queryTaggedValue(name, []))\n+        tv.extend(Element.queryTaggedValue(iface, name, default=[]))\n     return tv\n \n \n'

Repository: plone.supermodel


Branch: refs/heads/master
Date: 2020-02-14T09:37:06+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.supermodel/commit/c0e0ba06522b6a328181e82849c3a237ee424b99

Merge pull request #36 from plone/update-zope.interface-4.7

fixes #34: zope.interface 4.7 support

Files changed:
A news/34.feature
M plone/supermodel/directives.py
M plone/supermodel/utils.py

b'diff --git a/news/34.feature b/news/34.feature\nnew file mode 100644\nindex 0000000..b22bb9a\n--- /dev/null\n+++ b/news/34.feature\n@@ -0,0 +1 @@\n+Support for zope.interface 4.7+ [jensens]\n\\ No newline at end of file\ndiff --git a/plone/supermodel/directives.py b/plone/supermodel/directives.py\nindex 77cda7a..02b57cc 100644\n--- a/plone/supermodel/directives.py\n+++ b/plone/supermodel/directives.py\n@@ -12,6 +12,7 @@\n from zope.component import adapter\n from zope.interface import alsoProvides\n from zope.interface import implementer\n+from zope.interface.interface import Element\n from zope.interface.interface import TAGGED_DATA\n \n import os.path\n@@ -71,7 +72,7 @@ class CheckerPlugin(object):\n \n     def __init__(self, schema):\n         self.schema = schema\n-        self.value = schema.queryTaggedValue(self.key, None)\n+        self.value = Element.queryTaggedValue(schema, self.key, default=None)\n \n     def fieldNames(self):\n         raise NotImplementedError()\n@@ -148,10 +149,18 @@ def __init__(self, interface):\n \n     def __call__(self):\n         interface = self.interface\n-        filename = interface.queryTaggedValue(FILENAME_KEY, None)\n+        filename = Element.queryTaggedValue(\n+            interface,\n+            FILENAME_KEY,\n+            default=None,\n+        )\n         if filename is None:\n             return\n-        schema = interface.queryTaggedValue(SCHEMA_NAME_KEY, u\'\')\n+        schema = Element.queryTaggedValue(\n+            interface,\n+            SCHEMA_NAME_KEY,\n+            default=u\'\',\n+        )\n \n         moduleName = interface.__module__\n         module = sys.modules.get(moduleName, None)\ndiff --git a/plone/supermodel/utils.py b/plone/supermodel/utils.py\nindex 78f4119..a797bdf 100644\n--- a/plone/supermodel/utils.py\n+++ b/plone/supermodel/utils.py\n@@ -1,4 +1,5 @@\n # -*- coding: utf-8 -*-\n+from collections import OrderedDict\n from lxml import etree\n from plone.supermodel.debug import parseinfo\n from plone.supermodel.interfaces import I18N_NAMESPACE\n@@ -8,6 +9,7 @@\n from zope.i18nmessageid import Message\n from zope.interface import directlyProvidedBy\n from zope.interface import directlyProvides\n+from zope.interface.interface import Element\n from zope.schema.interfaces import IChoice\n from zope.schema.interfaces import ICollection\n from zope.schema.interfaces import IDict\n@@ -21,12 +23,6 @@\n import sys\n \n \n-try:\n-    from collections import OrderedDict\n-except ImportError:\n-    from zope.schema.vocabulary import OrderedDict  # <py27\n-\n-\n _marker = object()\n noNS_re = re.compile(\'^{\\S+}\')\n \n@@ -269,7 +265,7 @@ def mergedTaggedValueDict(schema, name):\n     """\n     tv = {}\n     for iface in reversed(schema.__iro__):\n-        tv.update(iface.queryTaggedValue(name, {}))\n+        tv.update(Element.queryTaggedValue(iface, name, default={}))\n     return tv\n \n \n@@ -281,7 +277,7 @@ def mergedTaggedValueList(schema, name):\n     """\n     tv = []\n     for iface in reversed(schema.__iro__):\n-        tv.extend(iface.queryTaggedValue(name, []))\n+        tv.extend(Element.queryTaggedValue(iface, name, default=[]))\n     return tv\n \n \n'

