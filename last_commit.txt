Repository: plone.namedfile


Branch: refs/heads/4.2.x
Date: 2019-05-30T19:55:18+02:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.namedfile/commit/e14189ee6f8fcfc35fc3e3b7419129f3304eaace

fix multiple write during image requests

Files changed:
A news/78.bugfix
M plone/namedfile/file.py

b'diff --git a/news/78.bugfix b/news/78.bugfix\nnew file mode 100644\nindex 0000000..e69de29\ndiff --git a/plone/namedfile/file.py b/plone/namedfile/file.py\nindex 1f63219..9b225b4 100644\n--- a/plone/namedfile/file.py\n+++ b/plone/namedfile/file.py\n@@ -409,7 +409,15 @@ def _setData(self, data):\n             length = max(0, MAX_INFO_BYTES - start)\n             firstbytes += self.getFirstBytes(start, length)\n             res = getImageInfo(firstbytes)\n+        \n         contentType, self._width, self._height = res\n+        \n+        if (self._width, self._height) == (-1, -1):\n+            # not enough information on firstbytes to guess width/height ?\n+            # TODO: missing problematic file on tests\n+            # see https://github.com/plone/plone.namedfile/pull/11\n+            contentType, self._width, self._height = getImageInfo(data)\n+\n         if contentType:\n             self.contentType = contentType\n \n@@ -428,8 +436,4 @@ def getFirstBytes(self, start=0, length=IMAGE_INFO_BYTES):\n \n     def getImageSize(self):\n         """See interface `IImage`"""\n-        if (self._width, self._height) != (-1, -1):\n-            return (self._width, self._height)\n-\n-        contentType, self._width, self._height = getImageInfo(self.data)\n         return (self._width, self._height)\n'

Repository: plone.namedfile


Branch: refs/heads/4.2.x
Date: 2019-05-30T20:47:06+02:00
Author: mauro (mamico) <mauro.amico@unibo.it>
Commit: https://github.com/plone/plone.namedfile/commit/db4478cce586535f5f184eb6ddf0e5793ad41836

changelog

Files changed:
M news/78.bugfix

b'diff --git a/news/78.bugfix b/news/78.bugfix\nindex e69de29..392890e 100644\n--- a/news/78.bugfix\n+++ b/news/78.bugfix\n@@ -0,0 +1,2 @@\n+fix multiple write during image requests\n+[mamico]\n\\ No newline at end of file\n'

Repository: plone.namedfile


Branch: refs/heads/4.2.x
Date: 2019-05-31T22:44:56+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.namedfile/commit/622730e35aab61af1bcadce1e8aed19677e85831

Merge pull request #78 from mamico/4.2.x-patch1

fix multiple write during image requests

Files changed:
A news/78.bugfix
M plone/namedfile/file.py

b'diff --git a/news/78.bugfix b/news/78.bugfix\nnew file mode 100644\nindex 0000000..392890e\n--- /dev/null\n+++ b/news/78.bugfix\n@@ -0,0 +1,2 @@\n+fix multiple write during image requests\n+[mamico]\n\\ No newline at end of file\ndiff --git a/plone/namedfile/file.py b/plone/namedfile/file.py\nindex 1f63219..9b225b4 100644\n--- a/plone/namedfile/file.py\n+++ b/plone/namedfile/file.py\n@@ -409,7 +409,15 @@ def _setData(self, data):\n             length = max(0, MAX_INFO_BYTES - start)\n             firstbytes += self.getFirstBytes(start, length)\n             res = getImageInfo(firstbytes)\n+        \n         contentType, self._width, self._height = res\n+        \n+        if (self._width, self._height) == (-1, -1):\n+            # not enough information on firstbytes to guess width/height ?\n+            # TODO: missing problematic file on tests\n+            # see https://github.com/plone/plone.namedfile/pull/11\n+            contentType, self._width, self._height = getImageInfo(data)\n+\n         if contentType:\n             self.contentType = contentType\n \n@@ -428,8 +436,4 @@ def getFirstBytes(self, start=0, length=IMAGE_INFO_BYTES):\n \n     def getImageSize(self):\n         """See interface `IImage`"""\n-        if (self._width, self._height) != (-1, -1):\n-            return (self._width, self._height)\n-\n-        contentType, self._width, self._height = getImageInfo(self.data)\n         return (self._width, self._height)\n'

