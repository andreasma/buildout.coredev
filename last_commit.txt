Repository: Products.CMFPlone


Branch: refs/heads/5.2.x
Date: 2019-11-06T14:26:15+01:00
Author: Ã‰rico Andrei (ericof) <ericof@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/7ecc8129b0cbe65e3a97c90a922608481a6437b4

Fix #1318: Always install default content types on Plone site creation (#2971)

* Fix #1318: Always install default content types on Plone site creation

* Update changelog entry

Files changed:
A news/1318.bugfix
M Products/CMFPlone/factory.py
M Products/CMFPlone/tests/test_factory.py

b'diff --git a/Products/CMFPlone/factory.py b/Products/CMFPlone/factory.py\nindex c25e9aec9..516ce9598 100644\n--- a/Products/CMFPlone/factory.py\n+++ b/Products/CMFPlone/factory.py\n@@ -14,6 +14,7 @@\n \n _TOOL_ID = \'portal_setup\'\n _DEFAULT_PROFILE = \'Products.CMFPlone:plone\'\n+_TYPES_PROFILE = \'plone.app.contenttypes:default\'\n _CONTENT_PROFILE = \'plone.app.contenttypes:plone-content\'\n \n # A little hint for PloneTestCase\n@@ -155,9 +156,11 @@ def addPloneSite(context, site_id, title=\'Plone site\', description=\'\',\n     reg[\'plone.default_language\'] = default_language\n     reg[\'plone.available_languages\'] = [default_language]\n \n-    if setup_content:\n-        setup_tool.runAllImportStepsFromProfile(\n-            \'profile-%s\' % content_profile_id)\n+    # Install default content types profile if user do not select "example content"\n+    # during site creation.\n+    content_types_profile = content_profile_id if setup_content else _TYPES_PROFILE\n+\n+    setup_tool.runAllImportStepsFromProfile(\'profile-{0}\'.format(content_types_profile))\n \n     props = dict(\n         title=title,\ndiff --git a/Products/CMFPlone/tests/test_factory.py b/Products/CMFPlone/tests/test_factory.py\nindex b22fb4a0b..e3c776f88 100644\n--- a/Products/CMFPlone/tests/test_factory.py\n+++ b/Products/CMFPlone/tests/test_factory.py\n@@ -1,15 +1,20 @@\n # -*- coding: utf-8 -*-\n+from plone.dexterity.interfaces import IDexterityFTI\n from Products.CMFPlone.factory import addPloneSite\n+from Products.CMFPlone.utils import get_installer\n from Products.CMFPlone.testing import PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n+from zope.component import queryUtility\n \n import unittest\n \n+\n class TestFactoryPloneSite(unittest.TestCase):\n \n     layer = PRODUCTS_CMFPLONE_INTEGRATION_TESTING\n \n     def setUp(self):\n         self.app = self.layer[\'app\']\n+        self.request = self.layer[\'request\']\n \n     def testPlonesiteWithUnicodeTitle(self):\n         TITLE = \'Plon\xc3\xa9\'\n@@ -34,3 +39,18 @@ def testPlonesiteWithoutUnicodeTitle(self):\n         ploneSiteTitle = ploneSite.Title()\n         self.assertTrue(isinstance(ploneSiteTitle, str))\n         self.assertEqual(ploneSiteTitle, TITLE)\n+\n+    def test_site_creation_without_content_but_with_dexterity(self):\n+        """Test site creation without example content have dexterity installed."""\n+        ploneSite = addPloneSite(\n+            self.app, \'ploneFoo\', title=\'Foo\', setup_content=False)\n+        qi = get_installer(ploneSite, self.request)\n+        self.assertTrue(qi.is_product_installed(\'plone.app.dexterity\'))\n+\n+    def test_site_creation_without_content_but_with_content_types(self):\n+        """Test site creation without example content have content types."""\n+        ploneSite = addPloneSite(\n+            self.app, \'ploneFoo\', title=\'Foo\', setup_content=False)\n+        # Folder\n+        fti = queryUtility(IDexterityFTI, name=\'Folder\')\n+        self.assertIsNotNone(fti)\ndiff --git a/news/1318.bugfix b/news/1318.bugfix\nnew file mode 100644\nindex 000000000..06ce93b80\n--- /dev/null\n+++ b/news/1318.bugfix\n@@ -0,0 +1,2 @@\n+fix creation of Plone site not adding default Dexterity content types if example content not explicitily selected by user.\n+[ericof]\n'

