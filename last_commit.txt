Repository: plone.app.testing


Branch: refs/heads/master
Date: 2020-02-11T11:50:36+01:00
Author: ale-rt (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.testing/commit/5b7b6e664b42a9d0080b6139d4bb769fbada4b38

MockMailHostLayer: clean up the registry on test tear down

Files changed:
M news/62.bugfix
M src/plone/app/testing/layers.py
M src/plone/app/testing/layers.rst

b'diff --git a/news/62.bugfix b/news/62.bugfix\nindex 4a8304d..ec5183e 100644\n--- a/news/62.bugfix\n+++ b/news/62.bugfix\n@@ -1 +1 @@\n-Properly configure the mail sender setting the appropriate registry records (Fixes #62)\n+MockMailHostLayer configures the mail sender setting the appropriate registry records (Fixes #62)\ndiff --git a/src/plone/app/testing/layers.py b/src/plone/app/testing/layers.py\nindex b6d8a96..a250b21 100644\n--- a/src/plone/app/testing/layers.py\n+++ b/src/plone/app/testing/layers.py\n@@ -388,28 +388,43 @@ def testSetUp(self):\n         with zope.zopeApp() as app:\n             portal = app[PLONE_SITE_ID]\n             registry = getUtility(IRegistry, context=portal)\n+\n             if not registry["plone.email_from_address"]:\n+                portal._original_email_address = registry["plone.email_from_address"]  # noqa: E501\n                 registry["plone.email_from_address"] = "noreply@example.com"\n+\n             if not registry["plone.email_from_name"]:\n+                portal._original_email_name = registry["plone.email_from_name"]\n                 registry["plone.email_from_name"] = u"Plone site"\n+\n             portal._original_MailHost = portal.MailHost\n             portal.MailHost = mailhost = MockMailHost(\'MailHost\')\n+\n             sm = getSiteManager(context=portal)\n             sm.unregisterUtility(provided=IMailHost)\n             sm.registerUtility(mailhost, provided=IMailHost)\n \n     def testTearDown(self):\n+\n         with zope.zopeApp() as app:\n             portal = app[PLONE_SITE_ID]\n-            _o_mailhost = getattr(portal, \'_original_MailHost\', None)\n-            if _o_mailhost:\n-                portal.MailHost = portal._original_MailHost\n-                sm = getSiteManager(context=portal)\n-                sm.unregisterUtility(provided=IMailHost)\n-                sm.registerUtility(\n-                    aq_base(portal._original_MailHost),\n-                    provided=IMailHost\n-                )\n+            registry = getUtility(IRegistry, context=portal)\n+\n+            portal.MailHost = portal._original_MailHost\n+\n+            sm = getSiteManager(context=portal)\n+            sm.unregisterUtility(provided=IMailHost)\n+            sm.registerUtility(aq_base(portal.MailHost), provided=IMailHost)\n+\n+            if hasattr(portal, "_original_email_name"):\n+                registry["plone.email_from_name"] = portal._original_email_name\n+                delattr(portal, "_original_email_name")\n+\n+            if hasattr(portal, "_original_email_address"):\n+                registry["plone.email_from_address"] = portal._original_email_address  # noqa: E501\n+                delattr(portal, "_original_email_address")\n+\n+            delattr(portal, "_original_MailHost")\n \n \n MOCK_MAILHOST_FIXTURE = MockMailHostLayer()\ndiff --git a/src/plone/app/testing/layers.rst b/src/plone/app/testing/layers.rst\nindex 8304321..3603707 100644\n--- a/src/plone/app/testing/layers.rst\n+++ b/src/plone/app/testing/layers.rst\n@@ -457,7 +457,8 @@ The list can be reset:\n     ...     portal.MailHost.messages\n     []\n \n-When the test is torn down the original MaiHost is restored:\n+When the test is torn down the original MaiHost is restored\n+and the registry is cleaned up:\n \n     >>> layers.MOCK_MAILHOST_FIXTURE.testTearDown()\n     >>> zope.STARTUP.testTearDown()\n@@ -469,6 +470,8 @@ When the test is torn down the original MaiHost is restored:\n     ...\n     AttributeError: \'RequestContainer\' object has no attribute \'messages\'\n \n+    >>> registry["plone.email_from_address"]\n+    >>> registry["plone.email_from_name"]\n     >>> runner.tear_down_unneeded(options, [], setupLayers)\n     Tear down plone.app.testing.layers.MockMailHostLayer in ... seconds.\n     Tear down plone.app.testing.layers.PloneFixture in ... seconds.\n'

Repository: plone.app.testing


Branch: refs/heads/master
Date: 2020-02-11T19:18:33+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.testing/commit/80cddda31c711a951a3a628da8f8c52bce71b20b

Merge pull request #67 from plone/mock-mailhost

MockMailHostLayer: clean up the registry on test tear down

Files changed:
M news/62.bugfix
M src/plone/app/testing/layers.py
M src/plone/app/testing/layers.rst

b'diff --git a/news/62.bugfix b/news/62.bugfix\nindex 4a8304d..ec5183e 100644\n--- a/news/62.bugfix\n+++ b/news/62.bugfix\n@@ -1 +1 @@\n-Properly configure the mail sender setting the appropriate registry records (Fixes #62)\n+MockMailHostLayer configures the mail sender setting the appropriate registry records (Fixes #62)\ndiff --git a/src/plone/app/testing/layers.py b/src/plone/app/testing/layers.py\nindex b6d8a96..a250b21 100644\n--- a/src/plone/app/testing/layers.py\n+++ b/src/plone/app/testing/layers.py\n@@ -388,28 +388,43 @@ def testSetUp(self):\n         with zope.zopeApp() as app:\n             portal = app[PLONE_SITE_ID]\n             registry = getUtility(IRegistry, context=portal)\n+\n             if not registry["plone.email_from_address"]:\n+                portal._original_email_address = registry["plone.email_from_address"]  # noqa: E501\n                 registry["plone.email_from_address"] = "noreply@example.com"\n+\n             if not registry["plone.email_from_name"]:\n+                portal._original_email_name = registry["plone.email_from_name"]\n                 registry["plone.email_from_name"] = u"Plone site"\n+\n             portal._original_MailHost = portal.MailHost\n             portal.MailHost = mailhost = MockMailHost(\'MailHost\')\n+\n             sm = getSiteManager(context=portal)\n             sm.unregisterUtility(provided=IMailHost)\n             sm.registerUtility(mailhost, provided=IMailHost)\n \n     def testTearDown(self):\n+\n         with zope.zopeApp() as app:\n             portal = app[PLONE_SITE_ID]\n-            _o_mailhost = getattr(portal, \'_original_MailHost\', None)\n-            if _o_mailhost:\n-                portal.MailHost = portal._original_MailHost\n-                sm = getSiteManager(context=portal)\n-                sm.unregisterUtility(provided=IMailHost)\n-                sm.registerUtility(\n-                    aq_base(portal._original_MailHost),\n-                    provided=IMailHost\n-                )\n+            registry = getUtility(IRegistry, context=portal)\n+\n+            portal.MailHost = portal._original_MailHost\n+\n+            sm = getSiteManager(context=portal)\n+            sm.unregisterUtility(provided=IMailHost)\n+            sm.registerUtility(aq_base(portal.MailHost), provided=IMailHost)\n+\n+            if hasattr(portal, "_original_email_name"):\n+                registry["plone.email_from_name"] = portal._original_email_name\n+                delattr(portal, "_original_email_name")\n+\n+            if hasattr(portal, "_original_email_address"):\n+                registry["plone.email_from_address"] = portal._original_email_address  # noqa: E501\n+                delattr(portal, "_original_email_address")\n+\n+            delattr(portal, "_original_MailHost")\n \n \n MOCK_MAILHOST_FIXTURE = MockMailHostLayer()\ndiff --git a/src/plone/app/testing/layers.rst b/src/plone/app/testing/layers.rst\nindex 8304321..3603707 100644\n--- a/src/plone/app/testing/layers.rst\n+++ b/src/plone/app/testing/layers.rst\n@@ -457,7 +457,8 @@ The list can be reset:\n     ...     portal.MailHost.messages\n     []\n \n-When the test is torn down the original MaiHost is restored:\n+When the test is torn down the original MaiHost is restored\n+and the registry is cleaned up:\n \n     >>> layers.MOCK_MAILHOST_FIXTURE.testTearDown()\n     >>> zope.STARTUP.testTearDown()\n@@ -469,6 +470,8 @@ When the test is torn down the original MaiHost is restored:\n     ...\n     AttributeError: \'RequestContainer\' object has no attribute \'messages\'\n \n+    >>> registry["plone.email_from_address"]\n+    >>> registry["plone.email_from_name"]\n     >>> runner.tear_down_unneeded(options, [], setupLayers)\n     Tear down plone.app.testing.layers.MockMailHostLayer in ... seconds.\n     Tear down plone.app.testing.layers.PloneFixture in ... seconds.\n'

