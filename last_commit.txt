Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-03-27T10:35:45-03:00
Author: hvelarde (hvelarde) <hector.velarde@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/c8c3a360217fb992981fa3e869a37d8fc3866e38

Add test case for issue #457

Files changed:
M plone/app/contenttypes/tests/test_link.py

diff --git a/plone/app/contenttypes/tests/test_link.py b/plone/app/contenttypes/tests/test_link.py
index 7fb0f911..4cf569fb 100644
--- a/plone/app/contenttypes/tests/test_link.py
+++ b/plone/app/contenttypes/tests/test_link.py
@@ -160,6 +160,21 @@ def test_link_redirect_view_path_with_variable(self):
         self.assertTrue(view())
         self._assert_redirect('http://nohost/plone/my-folder/my-item')
 
+    def test_link_redirect_view_path_with_variable_and_parameters(self):
+        # https://github.com/plone/plone.app.contenttypes/issues/457
+        self.link.remoteUrl = '${portal_url}/@@search?SearchableText=Plone'
+        self._publish(self.link)
+        view = self._get_link_redirect_view(self.link)
+
+        # As manager: do not redirect
+        self.assertTrue(view())
+        self.assertEqual(self.response.status, 200)
+
+        # As anonymous: redirect
+        logout()
+        self.assertTrue(view())
+        self._assert_redirect('http://nohost/plone/@@search?SearchableText=Plone')
+
     def test_mailto_type(self):
         self.link.remoteUrl = 'mailto:stress@test.us'
         view = self._get_link_redirect_view(self.link)


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-03-27T10:37:06-03:00
Author: hvelarde (hvelarde) <hector.velarde@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/78b04be1c273c3ec5d5f605dcc5085ad85f53b18

Do not encode query strings on internal link redirections

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/link_redirect_view.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6106f1fd..ac308697 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -16,6 +16,10 @@ New features:
 
 Bug fixes:
 
+- Do not encode query strings on internal link redirections;
+  fixes `issue 457 <https://github.com/plone/plone.app.contenttypes/issues/457>`_.
+  [hvelarde]
+
 - Migrations:
   - Handle ignore catalog errors where a brain can't find it's object.
   - Try to delete the layout attribute before setting the layout.
diff --git a/plone/app/contenttypes/browser/link_redirect_view.py b/plone/app/contenttypes/browser/link_redirect_view.py
index 20abc2f1..b9c385f3 100644
--- a/plone/app/contenttypes/browser/link_redirect_view.py
+++ b/plone/app/contenttypes/browser/link_redirect_view.py
@@ -87,7 +87,7 @@ def absolute_target_url(self):
                 url
             ])
         else:
-            if not (url.startswith('http://') or url.startswith('https://')):
-                url = self.request.physicalPathToURL(url)
+            if not url.startswith(('http://', 'https://')):
+                url = self.request['SERVER_URL'] + url
 
         return url


Repository: plone.app.contenttypes


Branch: refs/heads/master
Date: 2018-03-27T23:20:24+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/plone.app.contenttypes/commit/1b14503bbfe2f09c0574f0489a265f97cfc53d75

Merge pull request #458 from plone/issue_457

Do not encode query strings on internal link redirections

Files changed:
M CHANGES.rst
M plone/app/contenttypes/browser/link_redirect_view.py
M plone/app/contenttypes/tests/test_link.py

diff --git a/CHANGES.rst b/CHANGES.rst
index 6106f1fd..ac308697 100644
--- a/CHANGES.rst
+++ b/CHANGES.rst
@@ -16,6 +16,10 @@ New features:
 
 Bug fixes:
 
+- Do not encode query strings on internal link redirections;
+  fixes `issue 457 <https://github.com/plone/plone.app.contenttypes/issues/457>`_.
+  [hvelarde]
+
 - Migrations:
   - Handle ignore catalog errors where a brain can't find it's object.
   - Try to delete the layout attribute before setting the layout.
diff --git a/plone/app/contenttypes/browser/link_redirect_view.py b/plone/app/contenttypes/browser/link_redirect_view.py
index 20abc2f1..b9c385f3 100644
--- a/plone/app/contenttypes/browser/link_redirect_view.py
+++ b/plone/app/contenttypes/browser/link_redirect_view.py
@@ -87,7 +87,7 @@ def absolute_target_url(self):
                 url
             ])
         else:
-            if not (url.startswith('http://') or url.startswith('https://')):
-                url = self.request.physicalPathToURL(url)
+            if not url.startswith(('http://', 'https://')):
+                url = self.request['SERVER_URL'] + url
 
         return url
diff --git a/plone/app/contenttypes/tests/test_link.py b/plone/app/contenttypes/tests/test_link.py
index 7fb0f911..4cf569fb 100644
--- a/plone/app/contenttypes/tests/test_link.py
+++ b/plone/app/contenttypes/tests/test_link.py
@@ -160,6 +160,21 @@ def test_link_redirect_view_path_with_variable(self):
         self.assertTrue(view())
         self._assert_redirect('http://nohost/plone/my-folder/my-item')
 
+    def test_link_redirect_view_path_with_variable_and_parameters(self):
+        # https://github.com/plone/plone.app.contenttypes/issues/457
+        self.link.remoteUrl = '${portal_url}/@@search?SearchableText=Plone'
+        self._publish(self.link)
+        view = self._get_link_redirect_view(self.link)
+
+        # As manager: do not redirect
+        self.assertTrue(view())
+        self.assertEqual(self.response.status, 200)
+
+        # As anonymous: redirect
+        logout()
+        self.assertTrue(view())
+        self._assert_redirect('http://nohost/plone/@@search?SearchableText=Plone')
+
     def test_mailto_type(self):
         self.link.remoteUrl = 'mailto:stress@test.us'
         view = self._get_link_redirect_view(self.link)


