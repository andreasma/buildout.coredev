Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2020-02-06T16:47:24+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/e407d02a407bd6de0697ae01baa0b491c0ff122d

fix problem in remove_interface_indexes_from_relations_catalog whe token is disconnected

Files changed:
A news/225.bugfix
M plone/app/upgrade/v52/betas.py

b"diff --git a/news/225.bugfix b/news/225.bugfix\nnew file mode 100644\nindex 00000000..53bb44b8\n--- /dev/null\n+++ b/news/225.bugfix\n@@ -0,0 +1,4 @@\n+Fix problem in step to 5.2 beta 1 `remove_interface_indexes_from_relations_catalog`.\n+While upgrading the relation-catalog in some real world databases some of the iterated tokens are orphaned.\n+Remove them to have a clean relation-catalog afterwards and log a warning.\n+[jensens]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nindex b639b06f..2309aefa 100644\n--- a/plone/app/upgrade/v52/betas.py\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -8,7 +8,7 @@\n from zope.interface import Interface\n from zope.intid.interfaces import IIntIds\n from zope.intid.interfaces import IntIdMissingError\n-\n+from zope.intid.interfaces import ObjectMissingError\n import logging\n import sys\n \n@@ -68,7 +68,13 @@ def remove_interface_indexes_from_relations_catalog():\n     tokens = [token for token in catalog._relTokens]\n     empty = 0\n     for token in tokens:\n-        relation = catalog.resolveRelationToken(token)\n+        try:\n+            relation = catalog.resolveRelationToken(token)\n+        except ObjectMissingError:\n+            logger.warning('Removed token with missing object.')\n+            catalog._relTokens.remove(token)\n+            continue\n+\n         if relation.from_object is not None or relation.to_object is not None:\n             continue\n         catalog.unindex_doc(token)\n"

Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2020-02-11T18:45:29+01:00
Author: Maurits van Rees (mauritsvanrees) <m.van.rees@zestsoftware.nl>
Commit: https://github.com/plone/plone.app.upgrade/commit/ce2dce3cd83cabc15e00ab0ecc58004f5241284a

Merge pull request #225 from plone/fix-relation-update

fix problem in remove_interface_indexes_from_relations_catalog

Files changed:
A news/225.bugfix
M plone/app/upgrade/v52/betas.py

b"diff --git a/news/225.bugfix b/news/225.bugfix\nnew file mode 100644\nindex 00000000..53bb44b8\n--- /dev/null\n+++ b/news/225.bugfix\n@@ -0,0 +1,4 @@\n+Fix problem in step to 5.2 beta 1 `remove_interface_indexes_from_relations_catalog`.\n+While upgrading the relation-catalog in some real world databases some of the iterated tokens are orphaned.\n+Remove them to have a clean relation-catalog afterwards and log a warning.\n+[jensens]\n\\ No newline at end of file\ndiff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nindex b639b06f..2309aefa 100644\n--- a/plone/app/upgrade/v52/betas.py\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -8,7 +8,7 @@\n from zope.interface import Interface\n from zope.intid.interfaces import IIntIds\n from zope.intid.interfaces import IntIdMissingError\n-\n+from zope.intid.interfaces import ObjectMissingError\n import logging\n import sys\n \n@@ -68,7 +68,13 @@ def remove_interface_indexes_from_relations_catalog():\n     tokens = [token for token in catalog._relTokens]\n     empty = 0\n     for token in tokens:\n-        relation = catalog.resolveRelationToken(token)\n+        try:\n+            relation = catalog.resolveRelationToken(token)\n+        except ObjectMissingError:\n+            logger.warning('Removed token with missing object.')\n+            catalog._relTokens.remove(token)\n+            continue\n+\n         if relation.from_object is not None or relation.to_object is not None:\n             continue\n         catalog.unindex_doc(token)\n"

