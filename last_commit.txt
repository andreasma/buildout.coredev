Repository: plone.app.upgrade


Branch: refs/heads/master
Date: 2019-02-11T10:41:16+01:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.upgrade/commit/ab6e9f7ad4a124e9cec7022165a7a82a4835cc95

fake RR import before remove which needs it in place

Files changed:
M plone/app/upgrade/v52/betas.py

b'diff --git a/plone/app/upgrade/v52/betas.py b/plone/app/upgrade/v52/betas.py\nindex 7604cba4..925ef0e9 100644\n--- a/plone/app/upgrade/v52/betas.py\n+++ b/plone/app/upgrade/v52/betas.py\n@@ -1,12 +1,15 @@\n # -*- coding: utf-8 -*-\n-from Products.CMFCore.utils import getToolByName\n from plone.app.upgrade.utils import loadMigrationProfile\n from plone.app.upgrade.v40.alphas import cleanUpToolRegistry\n+from Products.CMFCore.utils import getToolByName\n+from types import ModuleType\n from zc.relation.interfaces import ICatalog\n from zope import component\n+from zope.interface import Interface\n from zope.intid.interfaces import IntIdMissingError\n \n import logging\n+import sys\n \n \n logger = logging.getLogger(\'plone.app.upgrade\')\n@@ -45,8 +48,8 @@ def remove_legacy_resource_registries(context):\n         portal.manage_delObjects(tools)\n \n     cleanUpToolRegistry(context)\n-    \n-    \n+\n+\n def remove_interface_indexes_from_relations_catalog():\n     """ remove unused interface indexes from relations catalog """\n     catalog = component.queryUtility(ICatalog)\n@@ -66,8 +69,35 @@ def remove_interface_indexes_from_relations_catalog():\n             logger.warn(\'Broken relation removed.\')\n \n \n+class IResourceRegistriesSettings(Interface):\n+    """fake/mock interface to be able to remove non existing dotted path\n+    """\n+    pass\n+\n+\n+FAKE_RR_PATH = "Products.ResourceRegistries.interfaces.settings." \\\n+               "IResourceRegistriesSettings"\n+\n+\n def to52beta1(context):\n+    # fake the old ResourceRegistries interface:\n+    fake_mods = FAKE_RR_PATH.split(\'.\')[:-1]\n+    parent = sys.modules[fake_mods[0]]\n+    for idx in range(1, len(fake_mods)):\n+        mod_name = \'.\'.join(fake_mods[:idx + 1])\n+        mod_inst = ModuleType(mod_name)\n+        if parent:\n+            setattr(parent, fake_mods[idx], mod_inst)\n+        sys.modules[mod_name] = parent = mod_inst\n+    sys.modules[FAKE_RR_PATH] = IResourceRegistriesSettings\n+    setattr(parent, \'IResourceRegistriesSettings\', IResourceRegistriesSettings)\n+    sys.modules[FAKE_RR_PATH]\n     loadMigrationProfile(context, \'profile-plone.app.upgrade.v52:to52beta1\')\n+    for idx in range(1, len(fake_mods)):\n+        mod_name = \'.\'.join(fake_mods[:idx + 1])\n+        del sys.modules[mod_name]\n+    del sys.modules[FAKE_RR_PATH]\n+    delattr(sys.modules[fake_mods[0]], fake_mods[1])\n     add_exclude_from_nav_index(context)\n     remove_legacy_resource_registries(context)\n     remove_interface_indexes_from_relations_catalog()\n'

