Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2018-09-18T08:26:24+02:00
Author: Tom Gross (tomgross) <itconsense@gmail.com>
Commit: https://github.com/plone/plone.app.multilingual/commit/4e9f28b158d615ad7bcddea9c09481cec4b59af1

Fix connection of documents

Files changed:
M CHANGES.rst
M src/plone/app/multilingual/browser/modify.py
M src/plone/app/multilingual/manager.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 6801d993..daa16fac 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -28,6 +28,9 @@ Bug fixes:\n - Don\'t fail, if multilingual selector is called without query\n   [tomgross]\n \n+- Fix connecting of documents\n+  [tomgross]\n+\n 5.2.0 (2018-04-04)\n ------------------\n \ndiff --git a/src/plone/app/multilingual/browser/modify.py b/src/plone/app/multilingual/browser/modify.py\nindex e76ffd1a..152545e5 100644\n--- a/src/plone/app/multilingual/browser/modify.py\n+++ b/src/plone/app/multilingual/browser/modify.py\n@@ -5,6 +5,7 @@\n from plone.autoform.form import AutoExtensibleForm\n from plone.autoform.interfaces import IFormFieldProvider\n from plone.registry.interfaces import IRegistry\n+from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import ILanguage\n from Products.Five.browser import BrowserView\n@@ -50,10 +51,13 @@ def handle_add(self, action):\n         if not errors:\n             content = data[\'content\']\n             language = data[\'language\']\n-            ITranslationManager(self.context)\\\n-                .register_translation(language, content)\n             ILanguage(content).set_language(language)\n-\n+            itm = ITranslationManager(self.context)\n+            # the \'register_translation\'-method takes content OR\n+            # UUID as second parameter. We need to use the UUID\n+            # here because otherwise the catalog can\'t be acquired\n+            # and the translation index is not updated\n+            itm.register_translation(language, IUUID(content))\n         return self.request.response.redirect(\n             self.context.absolute_url() + \'/modify_translations\')\n \ndiff --git a/src/plone/app/multilingual/manager.py b/src/plone/app/multilingual/manager.py\nindex 96932f0f..ee9467b1 100644\n--- a/src/plone/app/multilingual/manager.py\n+++ b/src/plone/app/multilingual/manager.py\n@@ -83,9 +83,8 @@ def register_translation(self, language, content):\n \n         # register the new translation in the canonical\n         IMutableTG(content_obj).set(self.tg)\n-        content_obj.reindexObject()\n-\n-        return\n+        content_obj.reindexObject(\n+            idxs=(\'Language\', \'TranslationGroup\'))\n \n     def update(self):\n         """ see interfaces"""\n'

Repository: plone.app.multilingual


Branch: refs/heads/master
Date: 2018-09-25T16:53:21+02:00
Author: Jens W. Klein (jensens) <jk@kleinundpartner.at>
Commit: https://github.com/plone/plone.app.multilingual/commit/ab00a8d84f1be5392016b95f65435e6520a79ef6

Merge pull request #323 from plone/fix_lang_connection

Fix connection of documents

Files changed:
M CHANGES.rst
M src/plone/app/multilingual/browser/modify.py
M src/plone/app/multilingual/manager.py

b'diff --git a/CHANGES.rst b/CHANGES.rst\nindex 6801d993..daa16fac 100644\n--- a/CHANGES.rst\n+++ b/CHANGES.rst\n@@ -28,6 +28,9 @@ Bug fixes:\n - Don\'t fail, if multilingual selector is called without query\n   [tomgross]\n \n+- Fix connecting of documents\n+  [tomgross]\n+\n 5.2.0 (2018-04-04)\n ------------------\n \ndiff --git a/src/plone/app/multilingual/browser/modify.py b/src/plone/app/multilingual/browser/modify.py\nindex e76ffd1a..152545e5 100644\n--- a/src/plone/app/multilingual/browser/modify.py\n+++ b/src/plone/app/multilingual/browser/modify.py\n@@ -5,6 +5,7 @@\n from plone.autoform.form import AutoExtensibleForm\n from plone.autoform.interfaces import IFormFieldProvider\n from plone.registry.interfaces import IRegistry\n+from plone.uuid.interfaces import IUUID\n from Products.CMFCore.utils import getToolByName\n from Products.CMFPlone.interfaces import ILanguage\n from Products.Five.browser import BrowserView\n@@ -50,10 +51,13 @@ def handle_add(self, action):\n         if not errors:\n             content = data[\'content\']\n             language = data[\'language\']\n-            ITranslationManager(self.context)\\\n-                .register_translation(language, content)\n             ILanguage(content).set_language(language)\n-\n+            itm = ITranslationManager(self.context)\n+            # the \'register_translation\'-method takes content OR\n+            # UUID as second parameter. We need to use the UUID\n+            # here because otherwise the catalog can\'t be acquired\n+            # and the translation index is not updated\n+            itm.register_translation(language, IUUID(content))\n         return self.request.response.redirect(\n             self.context.absolute_url() + \'/modify_translations\')\n \ndiff --git a/src/plone/app/multilingual/manager.py b/src/plone/app/multilingual/manager.py\nindex 96932f0f..ee9467b1 100644\n--- a/src/plone/app/multilingual/manager.py\n+++ b/src/plone/app/multilingual/manager.py\n@@ -83,9 +83,8 @@ def register_translation(self, language, content):\n \n         # register the new translation in the canonical\n         IMutableTG(content_obj).set(self.tg)\n-        content_obj.reindexObject()\n-\n-        return\n+        content_obj.reindexObject(\n+            idxs=(\'Language\', \'TranslationGroup\'))\n \n     def update(self):\n         """ see interfaces"""\n'

