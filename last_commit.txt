Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2019-08-18T01:08:43+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/0d90a79ab98255c58e78cf172e009e7091aa5718

Initial fix for catalog clear and rebuild changing the modification date.

See https://github.com/plone/Products.CMFPlone/issues/2941

Files changed:
A news/2941.bugfix
M Products/CMFPlone/CatalogTool.py

b'diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 12e5addc7..91bd73290 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -302,11 +302,12 @@ class ContentIndexer(object):\n     """An instance of this class can be passed to ZopeFindAndApply\n     """\n \n-    def __init__(self, catalog, queue_interval=100, log_progress=100):\n+    def __init__(self, catalog, queue_interval=100, log_progress=100, idxs=None):\n         self.catalog = catalog\n         self.queue_interval = queue_interval\n         self.log_progress = log_progress\n         self.counter = 0\n+        self.idxs = idxs\n \n     def index_discussion(self, obj):\n         # index conversions from plone.app.discussion\n@@ -329,7 +330,7 @@ def __call__(self, obj, path):\n             return\n         self.counter += 1\n         try:\n-            obj.indexObject()\n+            obj.indexObject(idxs=self.idxs)\n             self.index_discussion(obj)\n         except TypeError:\n             # Catalogs have \'indexObject\' as well, but they\n@@ -558,7 +559,8 @@ def clearFindAndRebuild(self):\n         # This may take a long time.\n         self.manage_catalogClear()\n         portal = aq_parent(aq_inner(self))\n-        index_content = ContentIndexer(aq_inner(self))\n+        idxs = list(self.indexes())\n+        index_content = ContentIndexer(aq_inner(self), idxs=idxs)\n         portal.ZopeFindAndApply(\n             portal,\n             search_sub=True,\ndiff --git a/news/2941.bugfix b/news/2941.bugfix\nnew file mode 100644\nindex 000000000..f02af4a87\n--- /dev/null\n+++ b/news/2941.bugfix\n@@ -0,0 +1,3 @@\n+Avoid changing the modification date when doing catalog clear and rebuild.\n+This happens with a new CMFCore version.\n+[maurits]\n'

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2019-08-18T01:10:26+02:00
Author: Maurits van Rees (mauritsvanrees) <maurits@vanrees.org>
Commit: https://github.com/plone/Products.CMFPlone/commit/0b524eab084f593bf5641f4f44f7c09ba58fdbda

Clear and rebuild catalog: use reindexObject instead of indexObject.

indexObject does not allow passing 'idxs'.

Files changed:
M Products/CMFPlone/CatalogTool.py

b"diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 91bd73290..21c43dcf3 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -324,16 +324,16 @@ def index_discussion(self, obj):\n             self.counter += 1\n \n     def __call__(self, obj, path):\n-        if not base_hasattr(obj, 'indexObject'):\n+        if not base_hasattr(obj, 'reindexObject'):\n             return\n-        if not safe_callable(obj.indexObject):\n+        if not safe_callable(obj.reindexObject):\n             return\n         self.counter += 1\n         try:\n-            obj.indexObject(idxs=self.idxs)\n+            obj.reindexObject(idxs=self.idxs)\n             self.index_discussion(obj)\n         except TypeError:\n-            # Catalogs have 'indexObject' as well, but they\n+            # Catalogs have 'reindexObject' as well, but they\n             # take different args, and will fail\n             pass\n         except Exception:\n"

Repository: Products.CMFPlone


Branch: refs/heads/5.1.x
Date: 2019-08-30T09:11:46+02:00
Author: Alessandro Pisa (ale-rt) <alessandro.pisa@gmail.com>
Commit: https://github.com/plone/Products.CMFPlone/commit/3b712caa586e2d94e0180f36db609bbf1a446593

Merge pull request #2942 from plone/maurits-fix-clear-rebuild-modification-date-51

Fix catalog clear rebuild resetting modification date [5.1]

Files changed:
A news/2941.bugfix
M Products/CMFPlone/CatalogTool.py

b'diff --git a/Products/CMFPlone/CatalogTool.py b/Products/CMFPlone/CatalogTool.py\nindex 12e5addc7..21c43dcf3 100644\n--- a/Products/CMFPlone/CatalogTool.py\n+++ b/Products/CMFPlone/CatalogTool.py\n@@ -302,11 +302,12 @@ class ContentIndexer(object):\n     """An instance of this class can be passed to ZopeFindAndApply\n     """\n \n-    def __init__(self, catalog, queue_interval=100, log_progress=100):\n+    def __init__(self, catalog, queue_interval=100, log_progress=100, idxs=None):\n         self.catalog = catalog\n         self.queue_interval = queue_interval\n         self.log_progress = log_progress\n         self.counter = 0\n+        self.idxs = idxs\n \n     def index_discussion(self, obj):\n         # index conversions from plone.app.discussion\n@@ -323,16 +324,16 @@ def index_discussion(self, obj):\n             self.counter += 1\n \n     def __call__(self, obj, path):\n-        if not base_hasattr(obj, \'indexObject\'):\n+        if not base_hasattr(obj, \'reindexObject\'):\n             return\n-        if not safe_callable(obj.indexObject):\n+        if not safe_callable(obj.reindexObject):\n             return\n         self.counter += 1\n         try:\n-            obj.indexObject()\n+            obj.reindexObject(idxs=self.idxs)\n             self.index_discussion(obj)\n         except TypeError:\n-            # Catalogs have \'indexObject\' as well, but they\n+            # Catalogs have \'reindexObject\' as well, but they\n             # take different args, and will fail\n             pass\n         except Exception:\n@@ -558,7 +559,8 @@ def clearFindAndRebuild(self):\n         # This may take a long time.\n         self.manage_catalogClear()\n         portal = aq_parent(aq_inner(self))\n-        index_content = ContentIndexer(aq_inner(self))\n+        idxs = list(self.indexes())\n+        index_content = ContentIndexer(aq_inner(self), idxs=idxs)\n         portal.ZopeFindAndApply(\n             portal,\n             search_sub=True,\ndiff --git a/news/2941.bugfix b/news/2941.bugfix\nnew file mode 100644\nindex 000000000..f02af4a87\n--- /dev/null\n+++ b/news/2941.bugfix\n@@ -0,0 +1,3 @@\n+Avoid changing the modification date when doing catalog clear and rebuild.\n+This happens with a new CMFCore version.\n+[maurits]\n'

